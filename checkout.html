<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - ScanHub</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .checkout-container {
            width: 100%;
            max-width: 800px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .checkout-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .left-panel {
            padding: 40px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .logo-checkout {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo-checkout h1 {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
        }
        
        .logo-checkout p {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .plano-resumo {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .plano-nome {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .plano-preco {
            font-size: 48px;
            font-weight: 800;
            margin: 15px 0;
        }
        
        .plano-periodo {
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .recursos-lista {
            list-style: none;
            margin-top: 25px;
        }
        
        .recursos-lista li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
        }
        
        .recursos-lista li:last-child {
            border-bottom: none;
        }
        
        .recursos-lista i {
            color: #4cd964;
            margin-right: 10px;
            font-size: 18px;
        }
        
        .right-panel {
            padding: 40px;
        }
        
        .header-pagamento {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header-pagamento h2 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header-pagamento p {
            color: #7f8c8d;
        }
        
        .form-container {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn-pagar {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border: none;
            padding: 18px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-pagar:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3);
        }
        
        .btn-pagar:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-voltar {
            display: block;
            text-align: center;
            color: #3498db;
            text-decoration: none;
            padding: 15px;
            margin-top: 15px;
            border: 2px solid #3498db;
            border-radius: 10px;
            background: transparent;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-voltar:hover {
            background: #3498db;
            color: white;
        }
        
        .cartoes-teste {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 2px dashed #FF6B35;
        }
        
        .cartoes-teste h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cartoes-teste h3 i {
            color: #FF6B35;
        }
        
        .cartao-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        
        .cartao-item:last-child {
            margin-bottom: 0;
        }
        
        .cartao-numero {
            font-family: monospace;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .cartao-detalhes {
            display: flex;
            gap: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c62828;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr;
                max-width: 500px;
            }
            
            .left-panel, .right-panel {
                padding: 30px 20px;
            }
            
            .plano-preco {
                font-size: 36px;
            }
        }
        
        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .plano-nome {
                font-size: 24px;
            }
            
            .plano-preco {
                font-size: 32px;
            }
        }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Processando pagamento...</p>
    </div>

    <div class="checkout-container">
        <div class="left-panel checkout-box">
            <div class="logo-checkout">
                <h1><i class="fas fa-qrcode"></i> SCANHUB</h1>
                <p>Sistema Profissional Completo</p>
            </div>
            
            <div class="plano-resumo">
                <div class="plano-nome" id="planoNome">PROFESSIONAL</div>
                <div class="plano-preco" id="planoPreco">R$ 59,90</div>
                <div class="plano-periodo">/m√™s ‚Ä¢ Cobran√ßa recorrente</div>
                <div class="plano-descricao">
                    <p>Plano ideal para profissionais que desejam crescer</p>
                </div>
            </div>
            
            <ul class="recursos-lista">
                <li><i class="fas fa-check"></i> Clientes: At√© 1.000</li>
                <li><i class="fas fa-check"></i> Cat√°logo: 100 itens</li>
                <li><i class="fas fa-check"></i> Pedidos ilimitados</li>
                <li><i class="fas fa-check"></i> Agenda completa</li>
                <li><i class="fas fa-check"></i> Relat√≥rios avan√ßados</li>
                <li><i class="fas fa-check"></i> Suporte priorit√°rio</li>
            </ul>
            
            <div style="margin-top: auto; text-align: center;">
                <p style="opacity: 0.8; font-size: 14px;">
                    <i class="fas fa-lock"></i> Pagamento 100% seguro
                </p>
            </div>
        </div>
        
        <div class="right-panel checkout-box">
            <div class="header-pagamento">
                <h2><i class="fas fa-credit-card"></i> Pagamento</h2>
                <p>Complete os dados para finalizar sua assinatura</p>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <div class="form-container">
                <div class="form-group">
                    <label class="form-label">Nome completo</label>
                    <input type="text" class="form-input" id="cardholderName" placeholder="Como est√° no cart√£o" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">E-mail</label>
                    <input type="email" class="form-input" id="cardholderEmail" placeholder="seu@email.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">N√∫mero do cart√£o</label>
                    <input type="text" class="form-input" id="cardNumber" placeholder="0000 0000 0000 0000" required maxlength="19">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Validade</label>
                        <input type="text" class="form-input" id="cardExpiry" placeholder="MM/AA" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">CVV</label>
                        <input type="text" class="form-input" id="cardCvv" placeholder="123" required maxlength="4">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">CPF do titular</label>
                    <input type="text" class="form-input" id="identificationNumber" placeholder="000.000.000-00" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcelas</label>
                    <select class="form-input" id="installments">
                        <option value="1">1x de R$ 59,90 (√† vista)</option>
                        <option value="2">2x de R$ 29,95</option>
                        <option value="3">3x de R$ 19,97</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-pagar" id="btnPagar">
                <i class="fas fa-lock"></i> FINALIZAR ASSINATURA
            </button>
            
            <a href="assinaturas.html" class="btn-voltar">
                <i class="fas fa-arrow-left"></i> Voltar para planos
            </a>
            
            <div class="cartoes-teste">
                <h3><i class="fas fa-vial"></i> CART√ïES PARA TESTE (SANDBOX)</h3>
                
                <div class="cartao-item">
                    <div class="cartao-numero">5031 4332 1540 6351</div>
                    <div class="cartao-detalhes">
                        <span>CVV: 123</span>
                        <span>Val: 11/30</span>
                        <span><strong>APRO</strong> (aprovado)</span>
                    </div>
                </div>
                
                <div class="cartao-item">
                    <div class="cartao-numero">5031 7557 3453 0604</div>
                    <div class="cartao-detalhes">
                        <span>CVV: 123</span>
                        <span>Val: 11/30</span>
                        <span><strong>OTHE</strong> (recusado)</span>
                    </div>
                </div>
                
                <div class="cartao-item">
                    <div class="cartao-numero">4235 6477 2802 5682</div>
                    <div class="cartao-detalhes">
                        <span>CVV: 123</span>
                        <span>Val: 11/30</span>
                        <span><strong>VISA</strong> teste</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <script>
    const CONFIG = {
        PUBLIC_KEY: 'TEST-7212078d-c1a3-424f-b3de-192dd48bdcbd',
        ACCESS_TOKEN: 'TEST-8505030648459314-012809-308028c845daf1965da62f398b2b794d-1057080095',
        
        PLANOS_IDS: {
            basic: '2c9380848c58d203018c5c86352600a2',
            pro: '2c9380848c58d203018c5c86353100a3',
            enterprise: '2c9380848c58d203018c5c86353700a4'
        },
        
        PLANOS_INFO: {
            basic: { nome: 'BASIC', preco: '29,90', valor: 29.90 },
            pro: { nome: 'PROFESSIONAL', preco: '59,90', valor: 59.90 },
            enterprise: { nome: 'ENTERPRISE', preco: '99,90', valor: 99.90 }
        }
    };

    let planoAtual = 'pro';
    let mpInstance = null;
    let firebaseApp = null;
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        planoAtual = urlParams.get('plano') || 'pro';
        
        atualizarPlano();
        formatarInputs();
        inicializarFirebase();
        inicializarMercadoPago();
        
        document.getElementById('btnPagar').addEventListener('click', processarPagamento);
        
        // Teste inicial das conex√µes
        setTimeout(testarConexoes, 1000);
    });

    function atualizarPlano() {
        const plano = CONFIG.PLANOS_INFO[planoAtual];
        if (!plano) return;
        
        document.getElementById('planoNome').textContent = plano.nome;
        document.getElementById('planoPreco').textContent = `R$ ${plano.preco}`;
        atualizarParcelas(plano.valor);
    }

    function atualizarParcelas(valor) {
        const select = document.getElementById('installments');
        select.innerHTML = '';
        
        for (let i = 1; i <= 3; i++) {
            const parcelaValor = valor / i;
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${i}x de R$ ${parcelaValor.toFixed(2)}`;
            if (i === 1) option.textContent += ' (√† vista)';
            select.appendChild(option);
        }
    }

    function formatarInputs() {
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})/g, '$1 ').trim();
            e.target.value = value.substring(0, 19);
        });
        
        document.getElementById('cardExpiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value.substring(0, 5);
        });
        
        document.getElementById('identificationNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 3) value = value.substring(0, 3) + '.' + value.substring(3);
            if (value.length > 7) value = value.substring(0, 7) + '.' + value.substring(7);
            if (value.length > 11) value = value.substring(0, 11) + '-' + value.substring(11, 14);
            e.target.value = value.substring(0, 14);
        });
    }

    function inicializarFirebase() {
        const firebaseConfig = {
            apiKey: "AIzaSyAYqWTg2RAr4IbqxRsl58TZGQ9tKnyFK14",
            authDomain: "scanhub-ed512.firebaseapp.com",
            projectId: "scanhub-ed512",
            storageBucket: "scanhub-ed512.firebasestorage.app",
            messagingSenderId: "1083305018831",
            appId: "1:1083305018831:web:f7594d560439c8965c3eba"
        };
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            console.log('‚úÖ Firebase inicializado');
        } catch (error) {
            console.log('Firebase j√° inicializado:', error.message);
            firebaseApp = firebase.app();
        }
        
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                console.log('‚úÖ Usu√°rio autenticado:', user.email, 'UID:', user.uid);
                preencherDadosUsuario(user);
                verificarPlanoAtual(user);
            } else {
                console.warn('Usu√°rio n√£o autenticado, redirecionando...');
                window.location.href = 'login.html';
            }
        });
    }

    async function verificarPlanoAtual(user) {
        try {
            const db = firebase.firestore();
            const userDoc = await db.collection('usuarios').doc(user.uid).get();
            
            if (userDoc.exists) {
                const userData = userDoc.data();
                console.log('üìä Status do usu√°rio:', {
                    plano: userData.plano_assinatura || 'free',
                    status: userData.status || 'n√£o definido',
                    assinatura_ativa: userData.assinatura_ativa || false
                });
                
                if (userData.plano_assinatura && userData.plano_assinatura !== 'free') {
                    mostrarAvisoPlanoAtual(userData.plano_assinatura);
                }
            } else {
                console.warn('Documento do usu√°rio n√£o encontrado');
            }
        } catch (error) {
            console.error('Erro ao verificar plano:', error);
        }
    }

    function mostrarAvisoPlanoAtual(plano) {
        const planoInfo = CONFIG.PLANOS_INFO[plano];
        if (!planoInfo) return;
        
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-info-circle" style="font-size: 1.2rem;"></i>
                <div>
                    <strong>Voc√™ j√° possui o plano ${planoInfo.nome} ativo.</strong><br>
                    Esta √© uma simula√ß√£o no ambiente Sandbox - nenhum pagamento real ser√° processado.
                </div>
            </div>
        `;
        errorDiv.style.background = '#e3f2fd';
        errorDiv.style.color = '#1565c0';
        errorDiv.style.borderLeft = '4px solid #2196f3';
        errorDiv.classList.add('active');
    }

    function preencherDadosUsuario(user) {
        document.getElementById('cardholderEmail').value = user.email || '';
        document.getElementById('cardholderName').value = user.displayName || '';
    }

    function inicializarMercadoPago() {
        try {
            mpInstance = new MercadoPago(CONFIG.PUBLIC_KEY, { locale: 'pt-BR' });
            console.log('‚úÖ Mercado Pago inicializado');
        } catch (error) {
            console.error('Erro ao inicializar Mercado Pago:', error);
        }
    }

    async function testarConexoes() {
        if (!currentUser) {
            console.log('Aguardando autentica√ß√£o do usu√°rio...');
            return;
        }
        
        console.log('üß™ Testando permiss√µes do Firestore...');
        const db = firebase.firestore();
        
        try {
            // Teste 1: Ler dados do usu√°rio
            const userDoc = await db.collection('usuarios').doc(currentUser.uid).get();
            console.log('üß™ Teste 1 - Ler usu√°rio:', userDoc.exists ? '‚úÖ OK' : '‚ùå N√£o encontrado');
            
            if (userDoc.exists) {
                const data = userDoc.data();
                console.log('üìã Dados do usu√°rio:', {
                    temPlanoAssinatura: 'plano_assinatura' in data,
                    planoAtual: data.plano_assinatura || 'n√£o definido'
                });
            }
            
        } catch (error) {
            console.error('üß™ Erro nos testes:', error.code, error.message);
        }
    }

    async function processarPagamento() {
        try {
            console.log('üîÑ Iniciando processamento de pagamento...');
            console.log('üìã Plano selecionado:', planoAtual);
            
            if (!validarFormulario()) {
                console.log('‚ùå Valida√ß√£o do formul√°rio falhou');
                return;
            }
            
            if (!currentUser) {
                mostrarErro('Usu√°rio n√£o autenticado. Fa√ßa login novamente.');
                return;
            }
            
            mostrarLoading(true);
            ocultarErro();
            
            console.log('üîÑ Processando pagamento no Mercado Pago (Sandbox)...');
            const assinaturaId = await criarAssinaturaMP();
            console.log('‚úÖ Assinatura MP criada:', assinaturaId);
            
            console.log('üîÑ Atualizando dados no Firebase...');
            await salvarNoFirebase(assinaturaId);
            console.log('‚úÖ Firebase atualizado com sucesso!');
            
            console.log('‚úÖ Pagamento processado com sucesso!');
            redirecionarSucesso(assinaturaId);
            
        } catch (error) {
            console.error('‚ùå Erro no processamento:', error);
            mostrarErro(error.message || 'Erro ao processar pagamento');
            mostrarLoading(false);
        }
    }

    function validarFormulario() {
        const campos = [
            {id: 'cardholderName', label: 'Nome completo'},
            {id: 'cardholderEmail', label: 'E-mail'},
            {id: 'cardNumber', label: 'N√∫mero do cart√£o'},
            {id: 'cardExpiry', label: 'Validade'},
            {id: 'cardCvv', label: 'CVV'},
            {id: 'identificationNumber', label: 'CPF'}
        ];
        
        for (const campo of campos) {
            const elemento = document.getElementById(campo.id);
            if (!elemento.value.trim()) {
                mostrarErro(`Preencha o campo: ${campo.label}`);
                elemento.focus();
                return false;
            }
        }
        
        // Valida√ß√£o de e-mail
        const email = document.getElementById('cardholderEmail').value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            mostrarErro('Digite um e-mail v√°lido');
            return false;
        }
        
        // Valida√ß√£o de CVV
        const cvv = document.getElementById('cardCvv').value;
        if (cvv.length < 3 || cvv.length > 4) {
            mostrarErro('CVV deve ter 3 ou 4 d√≠gitos');
            return false;
        }
        
        // Valida√ß√£o de data
        const expiry = document.getElementById('cardExpiry').value;
        if (!/^\d{2}\/\d{2}$/.test(expiry)) {
            mostrarErro('Data de validade inv√°lida. Use MM/AA (ex: 12/25)');
            return false;
        }
        
        // Valida√ß√£o de CPF
        const cpf = document.getElementById('identificationNumber').value.replace(/\D/g, '');
        if (cpf.length !== 11) {
            mostrarErro('CPF inv√°lido. Digite 11 n√∫meros');
            return false;
        }
        
        return true;
    }

    async function criarAssinaturaMP() {
        const planoId = CONFIG.PLANOS_IDS[planoAtual];
        const planoInfo = CONFIG.PLANOS_INFO[planoAtual];
        
        if (!planoId || planoId.includes('SEU-ID')) {
            throw new Error('IDs dos planos n√£o configurados corretamente');
        }
        
        return new Promise((resolve) => {
            // Simula√ß√£o de cria√ß√£o de assinatura no Mercado Pago Sandbox
            setTimeout(() => {
                const assinaturaId = 'MP-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                console.log('üìù Simula√ß√£o de assinatura no Mercado Pago:', {
                    plano: planoAtual,
                    valor: `R$ ${planoInfo.preco}`,
                    assinaturaId: assinaturaId,
                    status: 'aprovado',
                    ambiente: 'sandbox'
                });
                resolve(assinaturaId);
            }, 1500);
        });
    }

    async function salvarNoFirebase(assinaturaId) {
        if (!currentUser) {
            throw new Error('Usu√°rio n√£o autenticado');
        }
        
        const db = firebase.firestore();
        const userId = currentUser.uid;
        const userEmail = currentUser.email;
        const planoInfo = CONFIG.PLANOS_INFO[planoAtual];
        
        if (!planoInfo) {
            throw new Error('Plano n√£o encontrado');
        }
        
        const hoje = new Date();
        const expiracao = new Date(hoje);
        expiracao.setMonth(expiracao.getMonth() + 1);
        
        console.log('üíæ Salvando dados no Firebase:', {
            userId: userId,
            plano: planoAtual,
            valor: planoInfo.valor,
            assinaturaId: assinaturaId
        });
        
        try {
            // 1. Criar documento na cole√ß√£o 'assinaturas'
            const dadosAssinatura = {
                userId: userId, // CAMPO ESSENCIAL para as regras do Firestore
                userEmail: userEmail,
                plano: planoAtual,
                nomePlano: planoInfo.nome,
                assinaturaId: assinaturaId,
                status: 'ativa',
                valor: planoInfo.valor,
                valorFormatado: `R$ ${planoInfo.preco}`,
                dataInicio: firebase.firestore.FieldValue.serverTimestamp(),
                dataExpiracao: firebase.firestore.Timestamp.fromDate(expiracao),
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
                metodoPagamento: 'cart√£o de cr√©dito',
                recorrente: true,
                ambiente: 'sandbox',
                dataProcessamento: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('assinaturas').doc(assinaturaId).set(dadosAssinatura);
            console.log('‚úÖ Assinatura salva na cole√ß√£o "assinaturas"');
            
            // 2. Atualizar o usu√°rio com o novo plano
            const dadosUsuario = {
                plano_assinatura: planoAtual,
                status_assinatura: 'ativa',
                assinatura_ativa: true,
                data_expiracao_assinatura: firebase.firestore.Timestamp.fromDate(expiracao),
                ultimo_pagamento: firebase.firestore.FieldValue.serverTimestamp(),
                data_atualizacao: firebase.firestore.FieldValue.serverTimestamp(),
                data_upgrade: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('usuarios').doc(userId).update(dadosUsuario);
            console.log('‚úÖ Usu√°rio atualizado com novo plano');
            
            return { success: true, assinaturaId: assinaturaId };
            
        } catch (error) {
            console.error('‚ùå Erro detalhado do Firestore:', {
                code: error.code,
                message: error.message,
                stack: error.stack
            });
            
            // Mensagens de erro mais espec√≠ficas
            if (error.code === 'permission-denied') {
                throw new Error('Permiss√£o negada pelo Firestore. Verifique as regras de seguran√ßa.');
            } else if (error.code === 'not-found') {
                throw new Error('Documento n√£o encontrado. Verifique se o usu√°rio existe no Firestore.');
            } else if (error.code === 'invalid-argument') {
                throw new Error('Dados inv√°lidos enviados ao Firestore.');
            } else {
                throw new Error(`Erro do Firestore: ${error.message}`);
            }
        }
    }

    function redirecionarSucesso(assinaturaId) {
        setTimeout(() => {
            window.location.href = `pagamento-sucesso.html?plano=${planoAtual}&id=${assinaturaId}`;
        }, 1000);
    }

    function mostrarLoading(mostrar) {
        const overlay = document.getElementById('loadingOverlay');
        const btn = document.getElementById('btnPagar');
        
        if (mostrar) {
            overlay.classList.add('active');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESSANDO...';
        } else {
            overlay.classList.remove('active');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-lock"></i> FINALIZAR ASSINATURA';
        }
    }

    function mostrarErro(mensagem) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 10px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 1.2rem; margin-top: 2px;"></i>
                <div>
                    <strong>Erro no Processamento</strong><br>
                    ${mensagem}
                </div>
            </div>
        `;
        errorDiv.classList.add('active');
        
        // Scroll para o erro
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        console.error('‚ùå Erro exibido para o usu√°rio:', mensagem);
    }

    function ocultarErro() {
        document.getElementById('errorMessage').classList.remove('active');
    }
</script>
</body>
</html>