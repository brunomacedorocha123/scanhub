<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - ScanHub</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #44689a;
            --secondary-color: #33c47;
            --light-color: #e8ecef;
            --dark-color: #2c3e50;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .navbar-brand img {
            height: 60px;
            transform: scale(2);
            transform-origin: left center;
        }

        .container-main {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .profile-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #666;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            text-align: center;
            margin-top: 15px;
        }

        .avatar-upload-btn {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s;
        }

        .avatar-upload-btn:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(68, 104, 154, 0.1);
        }

        .form-control[readonly] {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            color: #666;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .verification-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .verification-status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-not-verified {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .upload-area i {
            font-size: 3rem;
            color: #aaa;
            margin-bottom: 15px;
        }

        .requirements-list {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .requirements-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .requirements-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .requirements-list i.fa-times {
            color: #dc3545;
        }

        .requirements-list i.fa-check {
            color: #28a745;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #856404;
        }

        .warning-box i {
            margin-right: 10px;
        }

        .btn-save {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            display: block;
            width: 100%;
            margin-top: 20px;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        @media (max-width: 768px) {
            .container-main {
                padding: 0 15px;
                margin: 20px auto;
            }
            
            .profile-header, .section-card {
                padding: 20px;
            }
            
            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }
        }

        @media (max-width: 576px) {
            .section-title {
                font-size: 1.1rem;
            }
            
            .form-control {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard-cliente.html">
                <img src="logoscanhub.png" alt="ScanHub">
            </a>
            <div class="d-flex">
                <a href="dashboard-cliente.html" class="btn btn-outline-primary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-main">
        <!-- Profile Header -->
        <div class="profile-header text-center">
            <div class="profile-avatar" id="avatarDisplay">
                <i class="fas fa-user"></i>
            </div>
            
            <h2 id="userName">Carregando...</h2>
            <p class="text-muted" id="userEmail">carregando@email.com</p>
            
            <div class="avatar-upload">
                <label class="avatar-upload-btn">
                    <i class="fas fa-camera me-2"></i>Alterar Foto
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                </label>
            </div>
        </div>

        <!-- Dados do Cadastro (Somente Leitura) -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-id-card"></i>Dados do Cadastro
            </h3>
            <p class="text-muted mb-4">Estes dados foram registrados no seu cadastro e n√£o podem ser alterados.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user"></i>Nome Completo
                        </label>
                        <input type="text" class="form-control" id="nomeCompleto" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-smile"></i>Como quer ser chamado
                        </label>
                        <input type="text" class="form-control" id="apelido" readonly>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-envelope"></i>E-mail
                        </label>
                        <input type="email" class="form-control" id="email" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-phone"></i>Celular/WhatsApp
                        </label>
                        <input type="text" class="form-control" id="celular" readonly>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-birthday-cake"></i>Data de Nascimento
                        </label>
                        <input type="text" class="form-control" id="dataNascimento" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-hashtag"></i>ID ScanHub
                        </label>
                        <input type="text" class="form-control" id="idScanHub" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados Faltantes (Para Completar) -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-edit"></i>Complete seu Perfil
            </h3>
            <p class="text-muted mb-4">Preencha os dados abaixo para melhorar sua experi√™ncia na plataforma.</p>
            
            <!-- CPF/CNPJ -->
            <div class="form-group">
                <label for="cpfCnpj" class="form-label">
                    <i class="fas fa-id-card"></i>CPF ou CNPJ
                </label>
                <input type="text" class="form-control" id="cpfCnpj" 
                       placeholder="Digite seu CPF ou CNPJ">
            </div>

            <!-- Endere√ßo -->
            <h5 class="mt-4 mb-3"><i class="fas fa-home me-2"></i>Endere√ßo</h5>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="cep" class="form-label">CEP</label>
                        <input type="text" class="form-control" id="cep" placeholder="00000-000">
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="form-group">
                        <label for="logradouro" class="form-label">Rua/Avenida</label>
                        <input type="text" class="form-control" id="logradouro" placeholder="Nome da rua">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="numero" class="form-label">N√∫mero</label>
                        <input type="text" class="form-control" id="numero" placeholder="123">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="complemento" class="form-label">Complemento</label>
                        <input type="text" class="form-control" id="complemento" placeholder="Apto 101">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" class="form-control" id="bairro" placeholder="Bairro">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="cidade" class="form-label">Cidade</label>
                        <input type="text" class="form-control" id="cidade" placeholder="Cidade">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-control" id="estado">
                            <option value="">Selecione</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amap√°</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Cear√°</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Esp√≠rito Santo</option>
                            <option value="GO">Goi√°s</option>
                            <option value="MA">Maranh√£o</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Par√°</option>
                            <option value="PB">Para√≠ba</option>
                            <option value="PR">Paran√°</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piau√≠</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rond√¥nia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">S√£o Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Configura√ß√µes de Contato -->
            <h5 class="mt-4 mb-3"><i class="fas fa-shield-alt me-2"></i>Configura√ß√µes de Contato</h5>
            
            <div class="checkbox-group">
                <input type="checkbox" id="mostrarContato" checked>
                <label for="mostrarContato" class="mb-0">
                    Mostrar meu contato para profissionais
                </label>
            </div>
            <small class="text-muted">Quando desativado, os profissionais n√£o ver√£o seu telefone/email.</small>
        </div>

        <!-- Verifica√ß√£o de Documento -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-user-check"></i>Verifica√ß√£o de Identidade
            </h3>
            
            <div class="verification-card">
                <!-- Status da Verifica√ß√£o -->
                <div class="verification-status status-not-verified" id="verificationStatus">
                    <i class="fas fa-times-circle me-2"></i>N√ÉO VERIFICADO
                </div>
                
                <p class="mb-4">Para sua seguran√ßa e dos profissionais, verifique sua identidade enviando uma selfie segurando seu documento.</p>
                
                <!-- Upload Area -->
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h5>Arraste e solte sua foto aqui</h5>
                    <p class="text-muted">ou clique para selecionar</p>
                    <input type="file" id="documentPhoto" accept="image/*" style="display: none;">
                </div>
                
                <!-- Preview da Imagem -->
                <img id="imagePreview" class="preview-image" alt="Pr√©-visualiza√ß√£o">
                
                <!-- Requisitos -->
                <div class="requirements-list">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Requisitos obrigat√≥rios:</h6>
                    <ul>
                        <li><i class="fas fa-times text-danger"></i> Proibido usar bon√© ou chap√©u</li>
                        <li><i class="fas fa-times text-danger"></i> Sem √≥culos escuros ou acess√≥rios no rosto</li>
                        <li><i class="fas fa-times text-danger"></i> Imagem n√≠tida e bem iluminada</li>
                        <li><i class="fas fa-times text-danger"></i> Documento leg√≠vel pr√≥ximo ao rosto</li>
                        <li><i class="fas fa-times text-danger"></i> Seu rosto deve estar completamente vis√≠vel</li>
                    </ul>
                </div>
                
                <!-- Mensagem de Prazo -->
                <div class="warning-box">
                    <i class="fas fa-clock"></i>
                    <strong>Prazo de valida√ß√£o:</strong> Ap√≥s o envio, nossa equipe tem at√© 48 horas √∫teis para validar sua documenta√ß√£o.
                </div>
                
                <!-- Instru√ß√£o para enviar -->
                <div class="text-center mt-4">
                    <button class="btn btn-save" id="btnEnviarVerificacao" disabled>
                        <i class="fas fa-paper-plane me-2"></i>Enviar para Verifica√ß√£o
                    </button>
                    <small class="text-muted d-block mt-2">
                        Ap√≥s o envio, voc√™ n√£o poder√° alterar a foto at√© a valida√ß√£o ser conclu√≠da.
                    </small>
                </div>
            </div>
        </div>

        <!-- Bot√£o Salvar Tudo -->
        <div class="section-card">
            <button class="btn btn-save" id="btnSalvarTudo">
                <i class="fas fa-save me-2"></i>Salvar Todas as Altera√ß√µes
            </button>
        </div>
    </div>

    <!-- Firebase e Scripts -->
    <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc,
        updateDoc 
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
    import { 
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-storage.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAYqWTg2RAr4IbqxRsl58TZGQ9tKnyFK14",
        authDomain: "scanhub-ed512.firebaseapp.com",
        projectId: "scanhub-ed512",
        storageBucket: "scanhub-ed512.firebasestorage.app",
        messagingSenderId: "1083305018831",
        appId: "1:1083305018831:web:f7594d560439c8965c3eba"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elementos DOM
    const avatarDisplay = document.getElementById('avatarDisplay');
    const avatarInput = document.getElementById('avatarInput');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    
    // Dados do cadastro (somente leitura)
    const nomeCompleto = document.getElementById('nomeCompleto');
    const apelido = document.getElementById('apelido');
    const email = document.getElementById('email');
    const celular = document.getElementById('celular');
    const dataNascimento = document.getElementById('dataNascimento');
    const idScanHub = document.getElementById('idScanHub');
    
    // Dados para completar
    const cpfCnpj = document.getElementById('cpfCnpj');
    const cep = document.getElementById('cep');
    const logradouro = document.getElementById('logradouro');
    const numero = document.getElementById('numero');
    const complemento = document.getElementById('complemento');
    const bairro = document.getElementById('bairro');
    const cidade = document.getElementById('cidade');
    const estado = document.getElementById('estado');
    const mostrarContato = document.getElementById('mostrarContato');
    
    // Verifica√ß√£o de documento
    const uploadArea = document.getElementById('uploadArea');
    const documentPhoto = document.getElementById('documentPhoto');
    const imagePreview = document.getElementById('imagePreview');
    const verificationStatus = document.getElementById('verificationStatus');
    const btnEnviarVerificacao = document.getElementById('btnEnviarVerificacao');
    const btnSalvarTudo = document.getElementById('btnSalvarTudo');

    // Estado da aplica√ß√£o
    let userData = null;
    let selectedFile = null;

    // Carregar dados do usu√°rio
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const userRef = doc(db, "usuarios", user.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    carregarDadosUsuario(userData);
                } else {
                    console.log("Documento do usu√°rio n√£o encontrado");
                }
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
            }
        } else {
            window.location.href = 'login.html';
        }
    });

    // Fun√ß√£o para carregar dados no formul√°rio
    function carregarDadosUsuario(data) {
        // Dados do cadastro (somente leitura)
        nomeCompleto.value = data.nomeCompleto || '';
        apelido.value = data.apelido || '';
        email.value = data.email || '';
        celular.value = data.celular || '';
        dataNascimento.value = data.dataNascimento || '';
        idScanHub.value = data.idScanHub || '';
        
        // Nome e email no header
        userName.textContent = data.apelido || 'Usu√°rio';
        userEmail.textContent = data.email || '';
        
        // Avatar
        if (data.fotoPerfil) {
            avatarDisplay.innerHTML = `<img src="${data.fotoPerfil}" alt="Foto de perfil" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else if (data.apelido) {
            avatarDisplay.textContent = data.apelido.charAt(0).toUpperCase();
        }
        
        // Dados para completar (se existirem)
        if (data.cpfCnpj) cpfCnpj.value = data.cpfCnpj;
        if (data.endereco) {
            cep.value = data.endereco.cep || '';
            logradouro.value = data.endereco.logradouro || '';
            numero.value = data.endereco.numero || '';
            complemento.value = data.endereco.complemento || '';
            bairro.value = data.endereco.bairro || '';
            cidade.value = data.endereco.cidade || '';
            estado.value = data.endereco.estado || '';
        }
        
        // Configura√ß√µes de contato
        if (data.configuracoes && data.configuracoes.mostrarContato !== undefined) {
            mostrarContato.checked = data.configuracoes.mostrarContato;
        }
        
        // Status da verifica√ß√£o
        if (data.verificacao) {
            atualizarStatusVerificacao(data.verificacao);
        }
    }

    // Atualizar status da verifica√ß√£o
    function atualizarStatusVerificacao(verificacao) {
        if (verificacao.status === 'aprovado') {
            verificationStatus.className = 'verification-status status-verified';
            verificationStatus.innerHTML = '<i class="fas fa-check-circle me-2"></i>VERIFICADO';
            uploadArea.style.display = 'none';
            btnEnviarVerificacao.style.display = 'none';
        } else if (verificacao.status === 'pendente') {
            verificationStatus.className = 'verification-status status-pending';
            verificationStatus.innerHTML = '<i class="fas fa-clock me-2"></i>AGUARDANDO VALIDA√á√ÉO';
            uploadArea.style.display = 'none';
            btnEnviarVerificacao.style.display = 'none';
            document.querySelector('.warning-box').innerHTML = `
                <i class="fas fa-clock"></i>
                <strong>Sua verifica√ß√£o est√° em an√°lise:</strong> Nossa equipe tem at√© 48 horas √∫teis para validar sua documenta√ß√£o.
            `;
        } else {
            verificationStatus.className = 'verification-status status-not-verified';
            verificationStatus.innerHTML = '<i class="fas fa-times-circle me-2"></i>N√ÉO VERIFICADO';
        }
    }

    // 1. UPLOAD DA FOTO DE PERFIL - CORRIGIDO
    avatarInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validar tipo de arquivo
        if (!file.type.startsWith('image/')) {
            alert('‚ùå Por favor, selecione uma imagem (JPG, PNG, etc).');
            return;
        }
        
        // Mostrar loading
        avatarDisplay.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            // Criar nome √∫nico para o arquivo
            const timestamp = Date.now();
            const fileName = `avatar_${timestamp}.jpg`;
            
            // Criar refer√™ncia no Storage
            const storageRef = ref(storage, `usuarios/${auth.currentUser.uid}/perfil/${fileName}`);
            
            console.log('üì§ Iniciando upload...');
            
            // Upload do arquivo
            const snapshot = await uploadBytes(storageRef, file);
            console.log('‚úÖ Upload realizado:', snapshot);
            
            // Obter URL de download
            const downloadURL = await getDownloadURL(snapshot.ref);
            console.log('‚úÖ URL obtida:', downloadURL);
            
            // Atualizar no Firestore
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            await updateDoc(userRef, {
                fotoPerfil: downloadURL,
                ultimaAtualizacao: new Date().toISOString()
            });
            
            // Atualizar visual
            avatarDisplay.innerHTML = `<img src="${downloadURL}" alt="Foto de perfil" style="width: 100%; height: 100%; object-fit: cover;">`;
            
            alert('‚úÖ Foto de perfil atualizada com sucesso!');
            
        } catch (error) {
            console.error('‚ùå Erro no upload:', error);
            avatarDisplay.innerHTML = '<i class="fas fa-user"></i>';
            
            // Tratamento de erros espec√≠ficos
            if (error.code === 'storage/unauthorized') {
                alert('‚ùå Erro de permiss√£o. Verifique as regras do Firebase Storage.');
            } else if (error.code === 'storage/unknown') {
                alert('‚ùå Erro desconhecido. Verifique sua conex√£o com a internet.');
            } else if (error.code === 'storage/canceled') {
                alert('‚ùå Upload cancelado.');
            } else if (error.code === 'storage/server-error') {
                alert('‚ùå Erro no servidor. Tente novamente mais tarde.');
            } else {
                alert(`‚ùå Erro ao fazer upload: ${error.message}`);
            }
        }
    });

    // 2. UPLOAD DA SELFIE COM DOCUMENTO - CORRIGIDO
    uploadArea.addEventListener('click', () => {
        documentPhoto.click();
    });

    documentPhoto.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validar tipo de arquivo
        if (!file.type.startsWith('image/')) {
            alert('‚ùå Por favor, selecione uma imagem (JPG, PNG, etc).');
            return;
        }
        
        // Verificar tamanho (m√°ximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('‚ùå A imagem deve ter no m√°ximo 5MB.');
            return;
        }
        
        selectedFile = file;
        
        // Mostrar preview
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            imagePreview.style.maxWidth = '100%';
            imagePreview.style.height = 'auto';
        };
        reader.readAsDataURL(file);
        
        // Habilitar bot√£o de envio
        btnEnviarVerificacao.disabled = false;
    });

    // 3. ENVIAR PARA VERIFICA√á√ÉO - CORRIGIDO
    btnEnviarVerificacao.addEventListener('click', async () => {
        if (!selectedFile) {
            alert('‚ùå Por favor, selecione uma foto primeiro.');
            return;
        }
        
        // Mostrar loading
        btnEnviarVerificacao.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
        btnEnviarVerificacao.disabled = true;
        
        try {
            // Criar nome √∫nico para o arquivo
            const timestamp = Date.now();
            const fileName = `verificacao_${timestamp}.jpg`;
            
            // Criar refer√™ncia no Storage
            const storageRef = ref(storage, `usuarios/${auth.currentUser.uid}/verificacao/${fileName}`);
            
            console.log('üì§ Iniciando upload de verifica√ß√£o...');
            
            // Upload do arquivo
            const snapshot = await uploadBytes(storageRef, selectedFile);
            console.log('‚úÖ Upload de verifica√ß√£o realizado:', snapshot);
            
            // Obter URL de download
            const downloadURL = await getDownloadURL(snapshot.ref);
            console.log('‚úÖ URL de verifica√ß√£o obtida:', downloadURL);
            
            // Atualizar no Firestore
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            await updateDoc(userRef, {
                verificacao: {
                    status: 'pendente',
                    dataEnvio: new Date().toISOString(),
                    arquivoUrl: downloadURL,
                    nomeArquivo: fileName,
                    aprovadoPor: null,
                    dataAprovacao: null,
                    observacoes: ''
                },
                ultimaAtualizacao: new Date().toISOString()
            });
            
            // Atualizar status na tela
            verificationStatus.className = 'verification-status status-pending';
            verificationStatus.innerHTML = '<i class="fas fa-clock me-2"></i>AGUARDANDO VALIDA√á√ÉO';
            uploadArea.style.display = 'none';
            btnEnviarVerificacao.style.display = 'none';
            imagePreview.style.display = 'none';
            
            // Atualizar mensagem
            document.querySelector('.warning-box').innerHTML = `
                <i class="fas fa-check-circle text-success"></i>
                <strong>Documenta√ß√£o enviada com sucesso!</strong> Nossa equipe tem at√© 48 horas √∫teis para validar.
            `;
            
            alert('‚úÖ Documenta√ß√£o enviada com sucesso! Nossa equipe ir√° validar em at√© 48 horas.');
            
        } catch (error) {
            console.error('‚ùå Erro ao enviar verifica√ß√£o:', error);
            
            // Restaurar bot√£o
            btnEnviarVerificacao.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar para Verifica√ß√£o';
            btnEnviarVerificacao.disabled = false;
            
            // Tratamento de erros
            if (error.code === 'storage/unauthorized') {
                alert('‚ùå Erro de permiss√£o. N√£o foi poss√≠vel enviar a verifica√ß√£o.');
            } else if (error.code === 'storage/unknown') {
                alert('‚ùå Erro de conex√£o. Verifique sua internet.');
            } else {
                alert(`‚ùå Erro ao enviar documenta√ß√£o: ${error.message}`);
            }
        }
    });

    // 4. API VIA CEP - CORRIGIDO
    cep.addEventListener('blur', async () => {
        const cepValue = cep.value.replace(/\D/g, '');
        
        if (cepValue.length !== 8) {
            alert('‚ùå CEP inv√°lido. Digite 8 n√∫meros.');
            return;
        }
        
        // Mostrar loading no campo logradouro
        logradouro.value = 'Buscando CEP...';
        logradouro.disabled = true;
        
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cepValue}/json/`);
            
            if (!response.ok) {
                throw new Error('Erro na busca do CEP');
            }
            
            const data = await response.json();
            
            if (data.erro) {
                alert('‚ùå CEP n√£o encontrado.');
                logradouro.value = '';
                logradouro.disabled = false;
                return;
            }
            
            // Preencher campos automaticamente
            logradouro.value = data.logradouro || '';
            bairro.value = data.bairro || '';
            cidade.value = data.localidade || '';
            estado.value = data.uf || '';
            
            // Focar no campo n√∫mero
            setTimeout(() => {
                numero.focus();
                logradouro.disabled = false;
            }, 100);
            
        } catch (error) {
            console.error('‚ùå Erro ao buscar CEP:', error);
            alert('‚ùå Erro ao buscar CEP. Tente novamente.');
            logradouro.value = '';
            logradouro.disabled = false;
        }
    });

    // 5. SALVAR TODAS AS ALTERA√á√ïES - CORRIGIDO
    btnSalvarTudo.addEventListener('click', async () => {
        if (!auth.currentUser) {
            alert('‚ùå Voc√™ precisa estar logado para salvar.');
            return;
        }
        
        // Validar CPF/CNPJ (formato b√°sico)
        const docValue = cpfCnpj.value.replace(/\D/g, '');
        if (docValue && (docValue.length !== 11 && docValue.length !== 14)) {
            alert('‚ùå CPF deve ter 11 d√≠gitos ou CNPJ 14 d√≠gitos.');
            cpfCnpj.focus();
            return;
        }
        
        // Validar endere√ßo b√°sico
        if (!cep.value || !logradouro.value || !numero.value || !cidade.value || !estado.value) {
            alert('‚ùå Por favor, preencha todos os campos obrigat√≥rios do endere√ßo.');
            return;
        }
        
        // Preparar dados do endere√ßo
        const enderecoData = {
            cep: cep.value.replace(/\D/g, ''),
            logradouro: logradouro.value,
            numero: numero.value,
            complemento: complemento.value || '',
            bairro: bairro.value,
            cidade: cidade.value,
            estado: estado.value
        };
        
        // Mostrar loading
        btnSalvarTudo.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
        btnSalvarTudo.disabled = true;
        
        try {
            // Atualizar no Firestore
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            await updateDoc(userRef, {
                cpfCnpj: cpfCnpj.value || null,
                endereco: enderecoData,
                configuracoes: {
                    mostrarContato: mostrarContato.checked
                },
                ultimaAtualizacao: new Date().toISOString()
            });
            
            alert('‚úÖ Dados salvos com sucesso!');
            
        } catch (error) {
            console.error('‚ùå Erro ao salvar dados:', error);
            alert(`‚ùå Erro ao salvar dados: ${error.message}`);
            
        } finally {
            // Restaurar bot√£o
            btnSalvarTudo.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Todas as Altera√ß√µes';
            btnSalvarTudo.disabled = false;
        }
    });

    // 6. FORMATA√á√ÉO DE CPF/CNPJ
    cpfCnpj.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.length <= 11) {
            // CPF: 000.000.000-00
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
            // CNPJ: 00.000.000/0000-00
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
        }
        
        e.target.value = value;
    });

    // 7. FORMATA√á√ÉO DE CEP
    cep.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 5) {
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
        }
        e.target.value = value;
    });

    // 8. FUN√á√ÉO PARA TESTAR FIREBASE STORAGE
    async function testarFirebaseStorage() {
        console.log('üß™ Testando Firebase Storage...');
        
        if (!auth.currentUser) {
            console.error('‚ùå Usu√°rio n√£o autenticado');
            return;
        }
        
        try {
            // Testar se podemos acessar o storage
            const testRef = ref(storage, 'teste.txt');
            const testBlob = new Blob(['Teste Firebase Storage'], { type: 'text/plain' });
            
            const snapshot = await uploadBytes(testRef, testBlob);
            console.log('‚úÖ Storage funciona:', snapshot);
            
            const url = await getDownloadURL(snapshot.ref);
            console.log('‚úÖ URL obtida:', url);
            
            alert('‚úÖ Firebase Storage est√° funcionando corretamente!');
            
        } catch (error) {
            console.error('‚ùå Erro no teste do Storage:', error);
            alert(`‚ùå Problema no Firebase Storage: ${error.message}`);
        }
    }

    // 9. VERIFICAR ESTRUTURA DO FIRESTORE
    async function verificarEstruturaFirestore() {
        console.log('üîç Verificando estrutura do Firestore...');
        
        if (!auth.currentUser) return;
        
        try {
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            const userDoc = await getDoc(userRef);
            
            if (userDoc.exists()) {
                console.log('‚úÖ Documento do usu√°rio existe:', userDoc.data());
            } else {
                console.warn('‚ö†Ô∏è Documento do usu√°rio n√£o existe');
            }
        } catch (error) {
            console.error('‚ùå Erro ao verificar Firestore:', error);
        }
    }

    // 10. INICIALIZA√á√ÉO E TESTES
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ ScanHub - Perfil Cliente inicializado');
        
        // Verificar estrutura ap√≥s login
        setTimeout(() => {
            if (auth.currentUser) {
                verificarEstruturaFirestore();
            }
        }, 2000);
        
        // Adicionar bot√£o de debug (remova em produ√ß√£o)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            const debugBtn = document.createElement('button');
            debugBtn.innerHTML = '<i class="fas fa-bug me-2"></i>Debug Storage';
            debugBtn.className = 'btn btn-warning btn-sm';
            debugBtn.style.position = 'fixed';
            debugBtn.style.bottom = '20px';
            debugBtn.style.right = '20px';
            debugBtn.style.zIndex = '9999';
            debugBtn.onclick = testarFirebaseStorage;
            document.body.appendChild(debugBtn);
        }
    });

    // 11. DRAG AND DROP PARA UPLOAD
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#44689a';
        uploadArea.style.background = '#f0f7ff';
    });

    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ddd';
        uploadArea.style.background = 'white';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ddd';
        uploadArea.style.background = 'white';
        
        if (e.dataTransfer.files.length > 0) {
            documentPhoto.files = e.dataTransfer.files;
            const changeEvent = new Event('change');
            documentPhoto.dispatchEvent(changeEvent);
        }
    });
</script>
</body>
</html>