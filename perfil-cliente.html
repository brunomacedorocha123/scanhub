<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - ScanHub</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #44689a;
            --secondary-color: #33c47;
            --light-color: #e8ecef;
            --dark-color: #2c3e50;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .navbar-brand img {
            height: 60px;
            transform: scale(2);
            transform-origin: left center;
        }

        .container-main {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .profile-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #666;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            text-align: center;
            margin-top: 15px;
        }

        .avatar-upload-btn {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s;
        }

        .avatar-upload-btn:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(68, 104, 154, 0.1);
        }

        .form-control[readonly] {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            color: #666;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .verification-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .verification-status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-not-verified {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .upload-area i {
            font-size: 3rem;
            color: #aaa;
            margin-bottom: 15px;
        }

        .requirements-list {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .requirements-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .requirements-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .requirements-list i.fa-times {
            color: #dc3545;
        }

        .requirements-list i.fa-check {
            color: #28a745;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #856404;
        }

        .warning-box i {
            margin-right: 10px;
        }

        .btn-save {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            display: block;
            width: 100%;
            margin-top: 20px;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        @media (max-width: 768px) {
            .container-main {
                padding: 0 15px;
                margin: 20px auto;
            }
            
            .profile-header, .section-card {
                padding: 20px;
            }
            
            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }
        }

        @media (max-width: 576px) {
            .section-title {
                font-size: 1.1rem;
            }
            
            .form-control {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard-cliente.html">
                <img src="logoscanhub.png" alt="ScanHub">
            </a>
            <div class="d-flex">
                <a href="cliente-dashboard.html" class="btn btn-outline-primary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-main">
        <!-- Profile Header -->
        <div class="profile-header text-center">
            <div class="profile-avatar" id="avatarDisplay">
                <i class="fas fa-user"></i>
            </div>
            
            <h2 id="userName">Carregando...</h2>
            <p class="text-muted" id="userEmail">carregando@email.com</p>
            
            <div class="avatar-upload">
                <label class="avatar-upload-btn">
                    <i class="fas fa-camera me-2"></i>Alterar Foto
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                </label>
            </div>
        </div>

        <!-- Dados do Cadastro (Somente Leitura) -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-id-card"></i>Dados do Cadastro
            </h3>
            <p class="text-muted mb-4">Estes dados foram registrados no seu cadastro e não podem ser alterados.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user"></i>Nome Completo
                        </label>
                        <input type="text" class="form-control" id="nomeCompleto" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-smile"></i>Como quer ser chamado
                        </label>
                        <input type="text" class="form-control" id="apelido" readonly>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-envelope"></i>E-mail
                        </label>
                        <input type="email" class="form-control" id="email" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-phone"></i>Celular/WhatsApp
                        </label>
                        <input type="text" class="form-control" id="celular" readonly>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-birthday-cake"></i>Data de Nascimento
                        </label>
                        <input type="text" class="form-control" id="dataNascimento" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-hashtag"></i>ID ScanHub
                        </label>
                        <input type="text" class="form-control" id="idScanHub" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados Faltantes (Para Completar) -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-edit"></i>Complete seu Perfil
            </h3>
            <p class="text-muted mb-4">Preencha os dados abaixo para melhorar sua experiência na plataforma.</p>
            
            <!-- CPF/CNPJ -->
            <div class="form-group">
                <label for="cpfCnpj" class="form-label">
                    <i class="fas fa-id-card"></i>CPF ou CNPJ
                </label>
                <input type="text" class="form-control" id="cpfCnpj" 
                       placeholder="Digite seu CPF ou CNPJ">
            </div>

            <!-- Endereço -->
            <h5 class="mt-4 mb-3"><i class="fas fa-home me-2"></i>Endereço</h5>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="cep" class="form-label">CEP</label>
                        <input type="text" class="form-control" id="cep" placeholder="00000-000">
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="form-group">
                        <label for="logradouro" class="form-label">Rua/Avenida</label>
                        <input type="text" class="form-control" id="logradouro" placeholder="Nome da rua">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="numero" class="form-label">Número</label>
                        <input type="text" class="form-control" id="numero" placeholder="123">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="complemento" class="form-label">Complemento</label>
                        <input type="text" class="form-control" id="complemento" placeholder="Apto 101">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" class="form-control" id="bairro" placeholder="Bairro">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="cidade" class="form-label">Cidade</label>
                        <input type="text" class="form-control" id="cidade" placeholder="Cidade">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-control" id="estado">
                            <option value="">Selecione</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amapá</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Ceará</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Espírito Santo</option>
                            <option value="GO">Goiás</option>
                            <option value="MA">Maranhão</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Pará</option>
                            <option value="PB">Paraíba</option>
                            <option value="PR">Paraná</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piauí</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rondônia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">São Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Configurações de Contato -->
            <h5 class="mt-4 mb-3"><i class="fas fa-shield-alt me-2"></i>Configurações de Contato</h5>
            
            <div class="checkbox-group">
                <input type="checkbox" id="mostrarContato" checked>
                <label for="mostrarContato" class="mb-0">
                    Mostrar meu contato para profissionais
                </label>
            </div>
            <small class="text-muted">Quando desativado, os profissionais não verão seu telefone/email.</small>
        </div>

        <!-- Verificação de Documento -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-user-check"></i>Verificação de Identidade
            </h3>
            
            <div class="verification-card">
                <!-- Status da Verificação -->
                <div class="verification-status status-not-verified" id="verificationStatus">
                    <i class="fas fa-times-circle me-2"></i>NÃO VERIFICADO
                </div>
                
                <p class="mb-4">Para sua segurança e dos profissionais, verifique sua identidade enviando uma selfie segurando seu documento.</p>
                
                <!-- Upload Area -->
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h5>Arraste e solte sua foto aqui</h5>
                    <p class="text-muted">ou clique para selecionar</p>
                    <input type="file" id="documentPhoto" accept="image/*" style="display: none;">
                </div>
                
                <!-- Preview da Imagem -->
                <img id="imagePreview" class="preview-image" alt="Pré-visualização">
                
                <!-- Requisitos -->
                <div class="requirements-list">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Requisitos obrigatórios:</h6>
                    <ul>
                        <li><i class="fas fa-times text-danger"></i> Proibido usar boné ou chapéu</li>
                        <li><i class="fas fa-times text-danger"></i> Sem óculos escuros ou acessórios no rosto</li>
                        <li><i class="fas fa-times text-danger"></i> Imagem nítida e bem iluminada</li>
                        <li><i class="fas fa-times text-danger"></i> Documento legível próximo ao rosto</li>
                        <li><i class="fas fa-times text-danger"></i> Seu rosto deve estar completamente visível</li>
                    </ul>
                </div>
                
                <!-- Mensagem de Prazo -->
                <div class="warning-box">
                    <i class="fas fa-clock"></i>
                    <strong>Prazo de validação:</strong> Após o envio, nossa equipe tem até 48 horas úteis para validar sua documentação.
                </div>
                
                <!-- Instrução para enviar -->
                <div class="text-center mt-4">
                    <button class="btn btn-save" id="btnEnviarVerificacao" disabled>
                        <i class="fas fa-paper-plane me-2"></i>Enviar para Verificação
                    </button>
                    <small class="text-muted d-block mt-2">
                        Após o envio, você não poderá alterar a foto até a validação ser concluída.
                    </small>
                </div>
            </div>
        </div>

        <!-- Botão Salvar Tudo -->
        <div class="section-card">
            <button class="btn btn-save" id="btnSalvarTudo">
                <i class="fas fa-save me-2"></i>Salvar Todas as Alterações
            </button>
        </div>
    </div>

    <!-- Firebase e Scripts -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc,
        updateDoc,
        setDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { 
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAYqWTg2RAr4IbqxRsl58TZGQ9tKnyFK14",
        authDomain: "scanhub-ed512.firebaseapp.com",
        projectId: "scanhub-ed512",
        storageBucket: "scanhub-ed512.appspot.com",
        messagingSenderId: "1083305018831",
        appId: "1:1083305018831:web:f7594d560439c8965c3eba"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elementos DOM
    const avatarDisplay = document.getElementById('avatarDisplay');
    const avatarInput = document.getElementById('avatarInput');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const nomeCompleto = document.getElementById('nomeCompleto');
    const apelido = document.getElementById('apelido');
    const email = document.getElementById('email');
    const celular = document.getElementById('celular');
    const dataNascimento = document.getElementById('dataNascimento');
    const idScanHub = document.getElementById('idScanHub');
    const cpfCnpj = document.getElementById('cpfCnpj');
    const cep = document.getElementById('cep');
    const logradouro = document.getElementById('logradouro');
    const numero = document.getElementById('numero');
    const complemento = document.getElementById('complemento');
    const bairro = document.getElementById('bairro');
    const cidade = document.getElementById('cidade');
    const estado = document.getElementById('estado');
    const mostrarContato = document.getElementById('mostrarContato');
    const uploadArea = document.getElementById('uploadArea');
    const documentPhoto = document.getElementById('documentPhoto');
    const imagePreview = document.getElementById('imagePreview');
    const verificationStatus = document.getElementById('verificationStatus');
    const btnEnviarVerificacao = document.getElementById('btnEnviarVerificacao');
    const btnSalvarTudo = document.getElementById('btnSalvarTudo');

    let userData = null;
    let selectedFile = null;

    // Carregar dados do usuário
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const userRef = doc(db, "usuarios", user.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    carregarDadosUsuario(userData);
                } else {
                    // Criar documento se não existir
                    await setDoc(userRef, {
                        uid: user.uid,
                        email: user.email,
                        nomeCompleto: '',
                        apelido: '',
                        celular: '',
                        dataNascimento: '',
                        idScanHub: '',
                        fotoPerfil: '',
                        cpfCnpj: '',
                        endereco: {},
                        configuracoes: {
                            mostrarContato: true
                        },
                        verificacao: {
                            status: 'nao_verificado'
                        },
                        dataCriacao: new Date().toISOString(),
                        ultimaAtualizacao: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.log("Erro ao carregar dados");
            }
        } else {
            window.location.href = 'login.html';
        }
    });

    function carregarDadosUsuario(data) {
        nomeCompleto.value = data.nomeCompleto || '';
        apelido.value = data.apelido || '';
        email.value = data.email || '';
        celular.value = data.celular || '';
        dataNascimento.value = data.dataNascimento || '';
        idScanHub.value = data.idScanHub || '';
        
        userName.textContent = data.apelido || data.nomeCompleto || 'Usuário';
        userEmail.textContent = data.email || '';
        
        // Carregar foto de perfil - MÉTODO CORRIGIDO
        if (data.fotoPerfil && data.fotoPerfil.trim() !== '') {
            const img = new Image();
            img.onload = function() {
                avatarDisplay.innerHTML = '';
                const imgElement = document.createElement('img');
                imgElement.src = data.fotoPerfil;
                imgElement.alt = 'Foto de perfil';
                imgElement.style.width = '100%';
                imgElement.style.height = '100%';
                imgElement.style.objectFit = 'cover';
                imgElement.style.borderRadius = '50%';
                avatarDisplay.appendChild(imgElement);
            };
            img.onerror = function() {
                // Se a imagem não carregar, mostrar inicial ou ícone
                mostrarAvatarFallback(data);
            };
            img.src = data.fotoPerfil;
        } else {
            mostrarAvatarFallback(data);
        }
        
        if (data.cpfCnpj) cpfCnpj.value = data.cpfCnpj;
        if (data.endereco) {
            cep.value = data.endereco.cep || '';
            logradouro.value = data.endereco.logradouro || '';
            numero.value = data.endereco.numero || '';
            complemento.value = data.endereco.complemento || '';
            bairro.value = data.endereco.bairro || '';
            cidade.value = data.endereco.cidade || '';
            estado.value = data.endereco.estado || '';
        }
        
        if (data.configuracoes && data.configuracoes.mostrarContato !== undefined) {
            mostrarContato.checked = data.configuracoes.mostrarContato;
        }
        
        if (data.verificacao) {
            atualizarStatusVerificacao(data.verificacao);
        }
    }

    function mostrarAvatarFallback(data) {
        if (data.apelido && data.apelido.trim() !== '') {
            const inicial = data.apelido.charAt(0).toUpperCase();
            avatarDisplay.innerHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: bold; background: linear-gradient(135deg, #44689a, #33c47); color: white; border-radius: 50%;">${inicial}</div>`;
        } else if (data.nomeCompleto && data.nomeCompleto.trim() !== '') {
            const inicial = data.nomeCompleto.charAt(0).toUpperCase();
            avatarDisplay.innerHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: bold; background: linear-gradient(135deg, #44689a, #33c47); color: white; border-radius: 50%;">${inicial}</div>`;
        } else {
            avatarDisplay.innerHTML = '<i class="fas fa-user fa-3x" style="color: #666;"></i>';
        }
    }

    function atualizarStatusVerificacao(verificacao) {
        if (verificacao.status === 'aprovado') {
            verificationStatus.className = 'verification-status status-verified';
            verificationStatus.innerHTML = '<i class="fas fa-check-circle me-2"></i>VERIFICADO';
            uploadArea.style.display = 'none';
            btnEnviarVerificacao.style.display = 'none';
        } else if (verificacao.status === 'pendente') {
            verificationStatus.className = 'verification-status status-pending';
            verificationStatus.innerHTML = '<i class="fas fa-clock me-2"></i>AGUARDANDO VALIDAÇÃO';
            uploadArea.style.display = 'none';
            btnEnviarVerificacao.style.display = 'none';
            document.querySelector('.warning-box').innerHTML = `
                <i class="fas fa-clock"></i>
                <strong>Sua verificação está em análise:</strong> Nossa equipe tem até 48 horas úteis para validar sua documentação.
            `;
        } else {
            verificationStatus.className = 'verification-status status-not-verified';
            verificationStatus.innerHTML = '<i class="fas fa-times-circle me-2"></i>NÃO VERIFICADO';
        }
    }

    // UPLOAD DA FOTO DE PERFIL - CORRIGIDO PARA SALVAR PERMANENTEMENTE
    avatarInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('Por favor, selecione uma imagem (JPG, PNG, etc)');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            alert('A imagem deve ter no máximo 5MB');
            return;
        }
        
        // Salvar estado original
        const originalContent = avatarDisplay.innerHTML;
        avatarDisplay.innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 50%;"><i class="fas fa-spinner fa-spin fa-2x" style="color: #44689a;"></i></div>';
        
        try {
            const user = auth.currentUser;
            if (!user) {
                alert('Usuário não autenticado');
                avatarDisplay.innerHTML = originalContent;
                return;
            }
            
            // Mostrar preview imediato
            const reader = new FileReader();
            reader.onload = function(e) {
                const tempImg = new Image();
                tempImg.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400;
                    canvas.height = 400;
                    const ctx = canvas.getContext('2d');
                    
                    // Criar clipping circular
                    ctx.beginPath();
                    ctx.arc(200, 200, 200, 0, Math.PI * 2);
                    ctx.closePath();
                    ctx.clip();
                    
                    // Desenhar imagem redimensionada
                    ctx.drawImage(tempImg, 0, 0, 400, 400);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Atualizar preview
                    avatarDisplay.innerHTML = '';
                    const previewImg = document.createElement('img');
                    previewImg.src = dataUrl;
                    previewImg.alt = 'Preview da foto';
                    previewImg.style.width = '100%';
                    previewImg.style.height = '100%';
                    previewImg.style.objectFit = 'cover';
                    previewImg.style.borderRadius = '50%';
                    avatarDisplay.appendChild(previewImg);
                };
                tempImg.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Preparar arquivo para upload
            const timestamp = Date.now();
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const fileName = `perfil_${user.uid}_${timestamp}.${fileExtension}`;
            
            // Criar referência no Storage
            const storageRef = ref(storage, `usuarios/${user.uid}/perfil/${fileName}`);
            
            // Fazer upload do arquivo original
            await uploadBytes(storageRef, file);
            
            // Obter URL pública permanente
            const downloadURL = await getDownloadURL(storageRef);
            
            // Atualizar no Firestore - GARANTIR QUE SALVA
            const userRef = doc(db, "usuarios", user.uid);
            await updateDoc(userRef, {
                fotoPerfil: downloadURL,
                ultimaAtualizacao: new Date().toISOString()
            });
            
            // Atualizar localmente
            userData.fotoPerfil = downloadURL;
            
            // Atualizar visual com a imagem do Firebase
            setTimeout(() => {
                const finalImg = new Image();
                finalImg.onload = () => {
                    avatarDisplay.innerHTML = '';
                    const imgElement = document.createElement('img');
                    imgElement.src = downloadURL;
                    imgElement.alt = 'Foto de perfil';
                    imgElement.style.width = '100%';
                    imgElement.style.height = '100%';
                    imgElement.style.objectFit = 'cover';
                    imgElement.style.borderRadius = '50%';
                    avatarDisplay.appendChild(imgElement);
                };
                finalImg.onerror = () => {
                    // Se falhar, manter o preview
                    console.log('Imagem do Firebase não carregou, mantendo preview');
                };
                finalImg.src = downloadURL + '?t=' + timestamp; // Forçar cache busting
            }, 500);
            
            alert('✅ Foto de perfil salva com sucesso! Ela será mantida mesmo após sair da conta.');
            
        } catch (error) {
            console.error('Erro no upload:', error);
            avatarDisplay.innerHTML = originalContent;
            alert('❌ Erro ao salvar a foto. Tente novamente.');
        }
    });

    uploadArea.addEventListener('click', () => {
        documentPhoto.click();
    });

    documentPhoto.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            alert('Por favor, selecione uma imagem');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            alert('A imagem deve ter no máximo 5MB');
            return;
        }
        
        selectedFile = file;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            imagePreview.style.maxWidth = '100%';
            imagePreview.style.maxHeight = '200px';
            imagePreview.style.objectFit = 'contain';
            imagePreview.style.borderRadius = '10px';
            imagePreview.style.margin = '15px auto';
            imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
        
        btnEnviarVerificacao.disabled = false;
    });

    btnEnviarVerificacao.addEventListener('click', async () => {
        if (!selectedFile) {
            alert('Por favor, selecione uma foto primeiro');
            return;
        }
        
        const originalContent = btnEnviarVerificacao.innerHTML;
        btnEnviarVerificacao.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
        btnEnviarVerificacao.disabled = true;
        
        try {
            const user = auth.currentUser;
            const timestamp = Date.now();
            const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
            const fileName = `verificacao_${user.uid}_${timestamp}.${fileExtension}`;
            
            const storageRef = ref(storage, `usuarios/${user.uid}/verificacao/${fileName}`);
            await uploadBytes(storageRef, selectedFile);
            const downloadURL = await getDownloadURL(storageRef);
            
            const userRef = doc(db, "usuarios", user.uid);
            await updateDoc(userRef, {
                verificacao: {
                    status: 'pendente',
                    dataEnvio: new Date().toISOString(),
                    arquivoUrl: downloadURL,
                    nomeArquivo: fileName,
                    dataAprovacao: null,
                    aprovadoPor: null
                },
                ultimaAtualizacao: new Date().toISOString()
            });
            
            // Atualizar dados locais
            userData.verificacao = {
                status: 'pendente',
                dataEnvio: new Date().toISOString(),
                arquivoUrl: downloadURL,
                nomeArquivo: fileName
            };
            
            atualizarStatusVerificacao(userData.verificacao);
            
            alert('✅ Documentação enviada com sucesso! Aguarde a validação.');
            
        } catch (error) {
            btnEnviarVerificacao.innerHTML = originalContent;
            btnEnviarVerificacao.disabled = false;
            alert('❌ Erro ao enviar documentação');
        }
    });

    cep.addEventListener('blur', async () => {
        const cepValue = cep.value.replace(/\D/g, '');
        
        if (cepValue.length !== 8) {
            return;
        }
        
        const originalValue = logradouro.value;
        logradouro.value = 'Buscando...';
        logradouro.disabled = true;
        bairro.disabled = true;
        cidade.disabled = true;
        estado.disabled = true;
        
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cepValue}/json/`);
            const data = await response.json();
            
            if (data.erro) {
                alert('CEP não encontrado');
                logradouro.value = originalValue;
                return;
            }
            
            logradouro.value = data.logradouro || '';
            bairro.value = data.bairro || '';
            cidade.value = data.localidade || '';
            estado.value = data.uf || '';
            
            setTimeout(() => numero.focus(), 100);
            
        } catch (error) {
            alert('Erro ao buscar CEP');
            logradouro.value = originalValue;
        } finally {
            logradouro.disabled = false;
            bairro.disabled = false;
            cidade.disabled = false;
            estado.disabled = false;
        }
    });

    btnSalvarTudo.addEventListener('click', async () => {
        if (!auth.currentUser) {
            alert('Você precisa estar logado para salvar');
            return;
        }
        
        const docValue = cpfCnpj.value.replace(/\D/g, '');
        if (docValue && (docValue.length !== 11 && docValue.length !== 14)) {
            alert('CPF deve ter 11 dígitos ou CNPJ 14 dígitos');
            cpfCnpj.focus();
            return;
        }
        
        if (!cep.value || !logradouro.value || !numero.value || !cidade.value || !estado.value) {
            alert('Preencha todos os campos obrigatórios do endereço');
            return;
        }
        
        const enderecoData = {
            cep: cep.value.replace(/\D/g, ''),
            logradouro: logradouro.value,
            numero: numero.value,
            complemento: complemento.value || '',
            bairro: bairro.value,
            cidade: cidade.value,
            estado: estado.value
        };
        
        const originalContent = btnSalvarTudo.innerHTML;
        btnSalvarTudo.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
        btnSalvarTudo.disabled = true;
        
        try {
            const userRef = doc(db, "usuarios", auth.currentUser.uid);
            await updateDoc(userRef, {
                cpfCnpj: cpfCnpj.value || null,
                endereco: enderecoData,
                configuracoes: {
                    mostrarContato: mostrarContato.checked
                },
                ultimaAtualizacao: new Date().toISOString()
            });
            
            // Atualizar dados locais
            userData.cpfCnpj = cpfCnpj.value || null;
            userData.endereco = enderecoData;
            userData.configuracoes = {
                mostrarContato: mostrarContato.checked
            };
            
            alert('✅ Dados salvos com sucesso!');
            
        } catch (error) {
            alert('❌ Erro ao salvar dados');
        } finally {
            btnSalvarTudo.innerHTML = originalContent;
            btnSalvarTudo.disabled = false;
        }
    });

    cpfCnpj.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
            value = value.replace(/^(\d{2})(\d)/, '$1.$2');
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
            value = value.replace(/(\d{4})(\d)/, '$1-$2');
        }
        
        e.target.value = value;
    });

    cep.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 5) {
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
        }
        e.target.value = value;
    });

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#44689a';
        uploadArea.style.background = '#f0f7ff';
    });

    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ddd';
        uploadArea.style.background = 'white';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#ddd';
        uploadArea.style.background = 'white';
        
        if (e.dataTransfer.files.length > 0) {
            documentPhoto.files = e.dataTransfer.files;
            const changeEvent = new Event('change');
            documentPhoto.dispatchEvent(changeEvent);
        }
    });
</script>
</body>
</html>