<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - ScanHub</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #44689a;
            --secondary-color: #33c47;
            --light-color: #e8ecef;
            --dark-color: #2c3e50;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .navbar-brand img {
            height: 60px;
            transform: scale(2);
            transform-origin: left center;
        }

        .container-main {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .profile-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #666;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            text-align: center;
            margin-top: 15px;
        }

        .avatar-upload-btn {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s;
        }

        .avatar-upload-btn:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }

        .btn-remove-avatar {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-remove-avatar:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(68, 104, 154, 0.1);
        }

        .form-control[readonly] {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            color: #666;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .verification-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .verification-status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-not-verified {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .upload-area i {
            font-size: 3rem;
            color: #aaa;
            margin-bottom: 15px;
        }

        .requirements-list {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .requirements-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .requirements-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .requirements-list i.fa-times {
            color: #dc3545;
        }

        .requirements-list i.fa-check {
            color: #28a745;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #856404;
        }

        .warning-box i {
            margin-right: 10px;
        }

        .btn-save {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            display: block;
            width: 100%;
            margin-top: 20px;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #44689a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container-main {
                padding: 0 15px;
                margin: 20px auto;
            }
            
            .profile-header, .section-card {
                padding: 20px;
            }
            
            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }
        }

        @media (max-width: 576px) {
            .section-title {
                font-size: 1.1rem;
            }
            
            .form-control {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard-cliente.html">
                <img src="logoscanhub.png" alt="ScanHub">
            </a>
            <div class="d-flex">
                <a href="cliente-dashboard.html" class="btn btn-outline-primary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-main">
        <!-- Profile Header -->
        <div class="profile-header text-center">
            <div class="profile-avatar" id="avatarDisplay">
                <i class="fas fa-user"></i>
            </div>
            
            <h2 id="userName">Carregando...</h2>
            <p class="text-muted" id="userEmail">carregando@email.com</p>
            
            <div class="avatar-upload">
                <label class="avatar-upload-btn">
                    <i class="fas fa-camera me-2"></i>Alterar Foto
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                </label>
                <button class="btn-remove-avatar" id="btnRemoverFoto" style="display: none;">
                    <i class="fas fa-trash me-2"></i>Remover Foto
                </button>
            </div>
        </div>

        <!-- Dados do Cadastro (Somente Leitura) -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-id-card"></i>Dados do Cadastro
            </h3>
            <p class="text-muted mb-4">Estes dados foram registrados no seu cadastro e n√£o podem ser alterados.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user"></i>Nome Completo
                        </label>
                        <input type="text" class="form-control" id="nomeCompleto" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-smile"></i>Como quer ser chamado
                        </label>
                        <input type="text" class="form-control" id="apelido" readonly>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-envelope"></i>E-mail
                        </label>
                        <input type="email" class="form-control" id="email" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-phone"></i>Celular/WhatsApp
                        </label>
                        <input type="text" class="form-control" id="celular" readonly>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-birthday-cake"></i>Data de Nascimento
                        </label>
                        <input type="text" class="form-control" id="dataNascimento" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-hashtag"></i>ID ScanHub
                        </label>
                        <input type="text" class="form-control" id="idScanHub" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados Faltantes (Para Completar) -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-edit"></i>Complete seu Perfil
            </h3>
            <p class="text-muted mb-4">Preencha os dados abaixo para melhorar sua experi√™ncia na plataforma.</p>
            
            <!-- CPF/CNPJ -->
            <div class="form-group">
                <label for="cpfCnpj" class="form-label">
                    <i class="fas fa-id-card"></i>CPF ou CNPJ
                </label>
                <input type="text" class="form-control" id="cpfCnpj" 
                       placeholder="Digite seu CPF ou CNPJ">
            </div>

            <!-- Endere√ßo -->
            <h5 class="mt-4 mb-3"><i class="fas fa-home me-2"></i>Endere√ßo</h5>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="cep" class="form-label">CEP</label>
                        <input type="text" class="form-control" id="cep" placeholder="00000-000">
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="form-group">
                        <label for="logradouro" class="form-label">Rua/Avenida</label>
                        <input type="text" class="form-control" id="logradouro" placeholder="Nome da rua">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="numero" class="form-label">N√∫mero</label>
                        <input type="text" class="form-control" id="numero" placeholder="123">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="complemento" class="form-label">Complemento</label>
                        <input type="text" class="form-control" id="complemento" placeholder="Apto 101">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" class="form-control" id="bairro" placeholder="Bairro">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="cidade" class="form-label">Cidade</label>
                        <input type="text" class="form-control" id="cidade" placeholder="Cidade">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-control" id="estado">
                            <option value="">Selecione</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amap√°</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Cear√°</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Esp√≠rito Santo</option>
                            <option value="GO">Goi√°s</option>
                            <option value="MA">Maranh√£o</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Par√°</option>
                            <option value="PB">Para√≠ba</option>
                            <option value="PR">Paran√°</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piau√≠</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rond√¥nia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">S√£o Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Configura√ß√µes de Contato -->
            <h5 class="mt-4 mb-3"><i class="fas fa-shield-alt me-2"></i>Configura√ß√µes de Contato</h5>
            
            <div class="checkbox-group">
                <input type="checkbox" id="mostrarContato" checked>
                <label for="mostrarContato" class="mb-0">
                    Mostrar meu contato para profissionais
                </label>
            </div>
            <small class="text-muted">Quando desativado, os profissionais n√£o ver√£o seu telefone/email.</small>
        </div>

        <!-- Verifica√ß√£o de Documento -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-user-check"></i>Verifica√ß√£o de Identidade
            </h3>
            
            <div class="verification-card">
                <!-- Status da Verifica√ß√£o -->
                <div class="verification-status status-not-verified" id="verificationStatus">
                    <i class="fas fa-times-circle me-2"></i>N√ÉO VERIFICADO
                </div>
                
                <p class="mb-4">Para sua seguran√ßa e dos profissionais, verifique sua identidade enviando uma selfie segurando seu documento.</p>
                
                <!-- Upload Area -->
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h5>Arraste e solte sua foto aqui</h5>
                    <p class="text-muted">ou clique para selecionar</p>
                    <input type="file" id="documentPhoto" accept="image/*" style="display: none;">
                </div>
                
                <!-- Preview da Imagem -->
                <img id="imagePreview" class="preview-image" alt="Pr√©-visualiza√ß√£o">
                
                <!-- Requisitos -->
                <div class="requirements-list">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Requisitos obrigat√≥rios:</h6>
                    <ul>
                        <li><i class="fas fa-times text-danger"></i> Proibido usar bon√© ou chap√©u</li>
                        <li><i class="fas fa-times text-danger"></i> Sem √≥culos escuros ou acess√≥rios no rosto</li>
                        <li><i class="fas fa-times text-danger"></i> Imagem n√≠tida e bem iluminada</li>
                        <li><i class="fas fa-times text-danger"></i> Documento leg√≠vel pr√≥ximo ao rosto</li>
                        <li><i class="fas fa-times text-danger"></i> Seu rosto deve estar completamente vis√≠vel</li>
                    </ul>
                </div>
                
                <!-- Mensagem de Prazo -->
                <div class="warning-box">
                    <i class="fas fa-clock"></i>
                    <strong>Prazo de valida√ß√£o:</strong> Ap√≥s o envio, nossa equipe tem at√© 48 horas √∫teis para validar sua documenta√ß√£o.
                </div>
                
                <!-- Instru√ß√£o para enviar -->
                <div class="text-center mt-4">
                    <button class="btn btn-save" id="btnEnviarVerificacao" disabled>
                        <i class="fas fa-paper-plane me-2"></i>Enviar para Verifica√ß√£o
                    </button>
                    <small class="text-muted d-block mt-2">
                        Ap√≥s o envio, voc√™ n√£o poder√° alterar a foto at√© a valida√ß√£o ser conclu√≠da.
                    </small>
                </div>
            </div>
        </div>

        <!-- Bot√£o Salvar Tudo -->
        <div class="section-card">
            <button class="btn btn-save" id="btnSalvarTudo">
                <i class="fas fa-save me-2"></i>Salvar Todas as Altera√ß√µes
            </button>
        </div>
    </div>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase + Script Principal -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAYqWTg2RAr4IbqxRsl58TZGQ9tKnyFK14",
            authDomain: "scanhub-ed512.firebaseapp.com",
            projectId: "scanhub-ed512",
            storageBucket: "scanhub-ed512.appspot.com",
            messagingSenderId: "1083305018831",
            appId: "1:1083305018831:web:f7594d560439c8965c3eba"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elementos DOM
        const avatarDisplay = document.getElementById('avatarDisplay');
        const avatarInput = document.getElementById('avatarInput');
        const btnRemoverFoto = document.getElementById('btnRemoverFoto');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const nomeCompleto = document.getElementById('nomeCompleto');
        const apelido = document.getElementById('apelido');
        const email = document.getElementById('email');
        const celular = document.getElementById('celular');
        const dataNascimento = document.getElementById('dataNascimento');
        const idScanHub = document.getElementById('idScanHub');
        const cpfCnpj = document.getElementById('cpfCnpj');
        const cep = document.getElementById('cep');
        const logradouro = document.getElementById('logradouro');
        const numero = document.getElementById('numero');
        const complemento = document.getElementById('complemento');
        const bairro = document.getElementById('bairro');
        const cidade = document.getElementById('cidade');
        const estado = document.getElementById('estado');
        const mostrarContato = document.getElementById('mostrarContato');
        const uploadArea = document.getElementById('uploadArea');
        const documentPhoto = document.getElementById('documentPhoto');
        const imagePreview = document.getElementById('imagePreview');
        const verificationStatus = document.getElementById('verificationStatus');
        const btnEnviarVerificacao = document.getElementById('btnEnviarVerificacao');
        const btnSalvarTudo = document.getElementById('btnSalvarTudo');
        const loadingOverlay = document.getElementById('loadingOverlay');

        let userData = null;
        let selectedFile = null;

        // ========== FUN√á√ïES UTILIT√ÅRIAS ==========

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showAlert(mensagem, tipo = 'info') {
            alert(mensagem);
        }

        function converterParaBase64(arquivo) {
            return new Promise((resolve, reject) => {
                const leitor = new FileReader();
                leitor.onload = (e) => resolve(e.target.result);
                leitor.onerror = reject;
                leitor.readAsDataURL(arquivo);
            });
        }

        // ========== FUN√á√ÉO DE UPLOAD PARA IMGUR ==========

        async function uploadParaImgur(arquivo) {
            showLoading();
            
            try {
                // Converter para base64
                const base64 = await converterParaBase64(arquivo);
                
                // API Client ID do Imgur (funciona sem conta)
                const CLIENT_ID = '546c25a59c58ad7';
                const formData = new FormData();
                formData.append('image', base64.split(',')[1]); // Remove "data:image/..."
                formData.append('type', 'base64');
                
                // Enviar para Imgur
                const resposta = await fetch('https://api.imgur.com/3/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Client-ID ${CLIENT_ID}`
                    },
                    body: formData
                });
                
                if (!resposta.ok) {
                    throw new Error(`Erro ${resposta.status} do Imgur`);
                }
                
                const dados = await resposta.json();
                
                if (!dados.success) {
                    throw new Error(dados.data?.error || 'Erro no upload');
                }
                
                console.log('‚úÖ Upload bem-sucedido para Imgur:', dados.data.link);
                return dados.data.link;
                
            } catch (erro) {
                console.error('‚ùå Erro no Imgur:', erro);
                
                // Tentar m√©todo alternativo se o primeiro falhar
                try {
                    console.log('üîÑ Tentando m√©todo alternativo...');
                    return await uploadAlternativo(arquivo);
                } catch (erro2) {
                    throw new Error('Falha ao enviar imagem: ' + erro.message);
                }
                
            } finally {
                hideLoading();
            }
        }

        // M√©todo alternativo de upload (fallback)
        async function uploadAlternativo(arquivo) {
            const formData = new FormData();
            formData.append('file', arquivo);
            
            const resposta = await fetch('https://tmpfiles.org/api/v1/upload', {
                method: 'POST',
                body: formData
            });
            
            if (!resposta.ok) throw new Error('Erro no upload alternativo');
            
            const dados = await resposta.json();
            return dados.data.url.replace('tmpfiles.org/', 'tmpfiles.org/dl/');
        }

        // ========== CARREGAR DADOS DO USU√ÅRIO ==========

        onAuthStateChanged(auth, async (usuario) => {
            if (usuario) {
                try {
                    showLoading();
                    const userRef = doc(db, "usuarios", usuario.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        userData = userDoc.data();
                        mostrarDadosUsuario(userData);
                    }
                } catch (erro) {
                    console.error("Erro ao carregar dados:", erro);
                } finally {
                    hideLoading();
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        function mostrarDadosUsuario(dados) {
            // Dados b√°sicos
            nomeCompleto.value = dados.nomeCompleto || '';
            apelido.value = dados.apelido || '';
            email.value = dados.email || '';
            celular.value = dados.celular || '';
            dataNascimento.value = dados.dataNascimento || '';
            idScanHub.value = dados.idScanHub || '';
            
            userName.textContent = dados.apelido || dados.nomeCompleto?.split(' ')[0] || 'Usu√°rio';
            userEmail.textContent = dados.email || '';
            
            // Carregar foto de perfil (APENAS URL)
            if (dados.fotoPerfil && dados.fotoPerfil.startsWith('http')) {
                avatarDisplay.innerHTML = '';
                const img = document.createElement('img');
                img.src = dados.fotoPerfil;
                img.alt = 'Foto de perfil';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '50%';
                
                img.onload = () => {
                    console.log('Foto carregada:', dados.fotoPerfil);
                    btnRemoverFoto.style.display = 'inline-block';
                };
                
                img.onerror = () => {
                    console.log('Erro ao carregar foto');
                    mostrarAvatarPadrao(dados);
                    btnRemoverFoto.style.display = 'none';
                };
                
                avatarDisplay.appendChild(img);
            } else {
                mostrarAvatarPadrao(dados);
                btnRemoverFoto.style.display = 'none';
            }
            
            // Dados complementares
            if (dados.cpfCnpj) cpfCnpj.value = dados.cpfCnpj;
            if (dados.endereco) {
                cep.value = dados.endereco.cep || '';
                logradouro.value = dados.endereco.logradouro || '';
                numero.value = dados.endereco.numero || '';
                complemento.value = dados.endereco.complemento || '';
                bairro.value = dados.endereco.bairro || '';
                cidade.value = dados.endereco.cidade || '';
                estado.value = dados.endereco.estado || '';
            }
            
            if (dados.configuracoes) {
                mostrarContato.checked = dados.configuracoes.mostrarContato !== false;
            }
            
            if (dados.verificacao) {
                atualizarStatusVerificacao(dados.verificacao);
            }
        }

        function mostrarAvatarPadrao(dados) {
            avatarDisplay.innerHTML = '';
            const div = document.createElement('div');
            div.style.width = '100%';
            div.style.height = '100%';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'center';
            div.style.fontSize = '3rem';
            div.style.fontWeight = 'bold';
            div.style.background = 'linear-gradient(135deg, #44689a, #33c47)';
            div.style.color = 'white';
            div.style.borderRadius = '50%';
            
            if (dados.apelido && dados.apelido.trim() !== '') {
                div.textContent = dados.apelido.charAt(0).toUpperCase();
            } else if (dados.nomeCompleto && dados.nomeCompleto.trim() !== '') {
                div.textContent = dados.nomeCompleto.charAt(0).toUpperCase();
            } else {
                const icon = document.createElement('i');
                icon.className = 'fas fa-user';
                div.appendChild(icon);
            }
            
            avatarDisplay.appendChild(div);
        }

        function atualizarStatusVerificacao(verificacao) {
            if (verificacao.status === 'aprovado') {
                verificationStatus.className = 'verification-status status-verified';
                verificationStatus.innerHTML = '<i class="fas fa-check-circle me-2"></i>VERIFICADO';
                uploadArea.style.display = 'none';
                btnEnviarVerificacao.style.display = 'none';
            } else if (verificacao.status === 'pendente') {
                verificationStatus.className = 'verification-status status-pending';
                verificationStatus.innerHTML = '<i class="fas fa-clock me-2"></i>AGUARDANDO VALIDA√á√ÉO';
                uploadArea.style.display = 'none';
                btnEnviarVerificacao.style.display = 'none';
                const warningBox = document.querySelector('.warning-box');
                if (warningBox) {
                    warningBox.innerHTML = `
                        <i class="fas fa-clock"></i>
                        <strong>Sua verifica√ß√£o est√° em an√°lise:</strong> Nossa equipe tem at√© 48 horas √∫teis para validar sua documenta√ß√£o.
                    `;
                }
            }
        }

        // ========== UPLOAD DA FOTO DE PERFIL ==========

        avatarInput.addEventListener('change', async (e) => {
            const arquivo = e.target.files[0];
            if (!arquivo) return;
            
            // Valida√ß√µes
            if (!arquivo.type.startsWith('image/')) {
                showAlert('Selecione uma imagem v√°lida (JPG, PNG, etc)', 'error');
                return;
            }
            
            if (arquivo.size > 10 * 1024 * 1024) {
                showAlert('A imagem deve ter no m√°ximo 10MB', 'error');
                return;
            }
            
            // Salvar estado atual
            const estadoAtual = avatarDisplay.innerHTML;
            
            // Mostrar preview local (r√°pido)
            const leitor = new FileReader();
            leitor.onload = function(e) {
                avatarDisplay.innerHTML = '';
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Preview';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '50%';
                avatarDisplay.appendChild(img);
            };
            leitor.readAsDataURL(arquivo);
            
            try {
                const usuario = auth.currentUser;
                if (!usuario) {
                    showAlert('Usu√°rio n√£o autenticado', 'error');
                    avatarDisplay.innerHTML = estadoAtual;
                    return;
                }
                
                // 1. Upload para Imgur
                const imageUrl = await uploadParaImgur(arquivo);
                
                // 2. Salvar APENAS A URL no Firestore (poucos bytes!)
                const userRef = doc(db, "usuarios", usuario.uid);
                await updateDoc(userRef, {
                    fotoPerfil: imageUrl,
                    ultimaAtualizacao: new Date().toISOString()
                });
                
                // 3. Atualizar localmente
                userData.fotoPerfil = imageUrl;
                btnRemoverFoto.style.display = 'inline-block';
                
                showAlert('‚úÖ Foto de perfil salva com sucesso!', 'success');
                
            } catch (erro) {
                console.error('Erro ao salvar foto:', erro);
                
                // Restaurar estado anterior
                avatarDisplay.innerHTML = estadoAtual;
                
                showAlert('‚ùå Erro ao salvar a foto: ' + erro.message, 'error');
            }
        });

        // ========== REMOVER FOTO DE PERFIL ==========

        btnRemoverFoto.addEventListener('click', async () => {
            if (!confirm('Tem certeza que deseja remover sua foto de perfil?')) {
                return;
            }
            
            try {
                const usuario = auth.currentUser;
                if (!usuario) {
                    showAlert('Usu√°rio n√£o autenticado', 'error');
                    return;
                }
                
                showLoading();
                
                // 1. Remover URL do Firestore
                const userRef = doc(db, "usuarios", usuario.uid);
                await updateDoc(userRef, {
                    fotoPerfil: null,
                    ultimaAtualizacao: new Date().toISOString()
                });
                
                // 2. Atualizar localmente
                userData.fotoPerfil = null;
                
                // 3. Mostrar avatar padr√£o
                mostrarAvatarPadrao(userData);
                btnRemoverFoto.style.display = 'none';
                
                showAlert('‚úÖ Foto de perfil removida com sucesso!', 'success');
                
            } catch (erro) {
                console.error('Erro ao remover foto:', erro);
                showAlert('‚ùå Erro ao remover foto', 'error');
            } finally {
                hideLoading();
            }
        });

        // ========== UPLOAD DA DOCUMENTA√á√ÉO ==========

        uploadArea.addEventListener('click', () => {
            documentPhoto.click();
        });

        documentPhoto.addEventListener('change', (e) => {
            const arquivo = e.target.files[0];
            if (!arquivo) return;
            
            if (!arquivo.type.startsWith('image/')) {
                showAlert('Selecione uma imagem v√°lida', 'error');
                return;
            }
            
            if (arquivo.size > 10 * 1024 * 1024) {
                showAlert('A imagem deve ter no m√°ximo 10MB', 'error');
                return;
            }
            
            selectedFile = arquivo;
            
            const leitor = new FileReader();
            leitor.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                imagePreview.style.maxWidth = '100%';
                imagePreview.style.maxHeight = '200px';
                imagePreview.style.objectFit = 'contain';
                imagePreview.style.borderRadius = '10px';
                imagePreview.style.margin = '15px auto';
            };
            leitor.readAsDataURL(arquivo);
            
            btnEnviarVerificacao.disabled = false;
        });

        btnEnviarVerificacao.addEventListener('click', async () => {
            if (!selectedFile) {
                showAlert('Selecione uma foto primeiro', 'error');
                return;
            }
            
            btnEnviarVerificacao.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            btnEnviarVerificacao.disabled = true;
            
            try {
                const usuario = auth.currentUser;
                
                // 1. Upload para Imgur
                const imageUrl = await uploadParaImgur(selectedFile);
                
                // 2. Salvar APENAS A URL no Firestore
                const userRef = doc(db, "usuarios", usuario.uid);
                await updateDoc(userRef, {
                    verificacao: {
                        status: 'pendente',
                        dataEnvio: new Date().toISOString(),
                        arquivoUrl: imageUrl // APENAS URL!
                    },
                    ultimaAtualizacao: new Date().toISOString()
                });
                
                // 3. Atualizar localmente
                userData.verificacao = {
                    status: 'pendente',
                    dataEnvio: new Date().toISOString(),
                    arquivoUrl: imageUrl
                };
                
                atualizarStatusVerificacao(userData.verificacao);
                showAlert('‚úÖ Documenta√ß√£o enviada para verifica√ß√£o!', 'success');
                
            } catch (erro) {
                console.error('Erro ao enviar verifica√ß√£o:', erro);
                showAlert('‚ùå Erro ao enviar documenta√ß√£o: ' + erro.message, 'error');
                btnEnviarVerificacao.disabled = false;
                btnEnviarVerificacao.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar para Verifica√ß√£o';
            }
        });

        // ========== SALVAR TODOS OS DADOS ==========

        btnSalvarTudo.addEventListener('click', async () => {
            if (!auth.currentUser) {
                showAlert('Voc√™ precisa estar logado para salvar', 'error');
                return;
            }
            
            // Valida√ß√£o de CPF/CNPJ
            const valorDoc = cpfCnpj.value.replace(/\D/g, '');
            if (valorDoc && (valorDoc.length !== 11 && valorDoc.length !== 14)) {
                showAlert('CPF deve ter 11 d√≠gitos ou CNPJ 14 d√≠gitos', 'error');
                cpfCnpj.focus();
                return;
            }
            
            // Valida√ß√£o de endere√ßo
            if (!cep.value || !logradouro.value || !numero.value || !cidade.value || !estado.value) {
                showAlert('Preencha todos os campos obrigat√≥rios do endere√ßo', 'error');
                return;
            }
            
            showLoading();
            btnSalvarTudo.disabled = true;
            btnSalvarTudo.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            
            try {
                const dadosEndereco = {
                    cep: cep.value.replace(/\D/g, ''),
                    logradouro: logradouro.value,
                    numero: numero.value,
                    complemento: complemento.value || '',
                    bairro: bairro.value,
                    cidade: cidade.value,
                    estado: estado.value
                };
                
                const userRef = doc(db, "usuarios", auth.currentUser.uid);
                await updateDoc(userRef, {
                    cpfCnpj: cpfCnpj.value || null,
                    endereco: dadosEndereco,
                    configuracoes: {
                        mostrarContato: mostrarContato.checked
                    },
                    ultimaAtualizacao: new Date().toISOString()
                });
                
                // Atualizar localmente
                userData.cpfCnpj = cpfCnpj.value || null;
                userData.endereco = dadosEndereco;
                userData.configuracoes = {
                    mostrarContato: mostrarContato.checked
                };
                
                showAlert('‚úÖ Dados salvos com sucesso!', 'success');
                
            } catch (erro) {
                console.error('Erro ao salvar dados:', erro);
                showAlert('‚ùå Erro ao salvar dados', 'error');
            } finally {
                hideLoading();
                btnSalvarTudo.disabled = false;
                btnSalvarTudo.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Todas as Altera√ß√µes';
            }
        });

        // ========== BUSCA DE CEP ==========

        cep.addEventListener('blur', async () => {
            const cepValor = cep.value.replace(/\D/g, '');
            if (cepValor.length !== 8) return;
            
            showLoading();
            
            try {
                const resposta = await fetch(`https://viacep.com.br/ws/${cepValor}/json/`);
                const dados = await resposta.json();
                
                if (dados.erro) {
                    showAlert('CEP n√£o encontrado', 'error');
                    return;
                }
                
                logradouro.value = dados.logradouro || '';
                bairro.value = dados.bairro || '';
                cidade.value = dados.localidade || '';
                estado.value = dados.uf || '';
                
                numero.focus();
                
            } catch (erro) {
                showAlert('Erro ao buscar CEP', 'error');
            } finally {
                hideLoading();
            }
        });

        // ========== FORMATA√á√ÉO DE CPF/CNPJ ==========

        cpfCnpj.addEventListener('input', (e) => {
            let valor = e.target.value.replace(/\D/g, '');
            
            if (valor.length <= 11) {
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else {
                valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
                valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
                valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
            }
            
            e.target.value = valor;
        });

        // ========== FORMATA√á√ÉO DE CEP ==========

        cep.addEventListener('input', (e) => {
            let valor = e.target.value.replace(/\D/g, '');
            if (valor.length > 5) {
                valor = valor.replace(/(\d{5})(\d)/, '$1-$2');
            }
            e.target.value = valor;
        });

        // ========== DRAG AND DROP ==========

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#44689a';
            uploadArea.style.background = '#f0f7ff';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ddd';
            uploadArea.style.background = 'white';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ddd';
            uploadArea.style.background = 'white';
            
            if (e.dataTransfer.files.length > 0) {
                documentPhoto.files = e.dataTransfer.files;
                const changeEvent = new Event('change');
                documentPhoto.dispatchEvent(changeEvent);
            }
        });

        // ========== TESTE DO IMGUR ==========

        window.testarUpload = async function() {
            // Criar imagem de teste
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#44689a';
            ctx.fillRect(0, 0, 100, 100);
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.fillText('OK', 30, 55);
            
            canvas.toBlob(async (blob) => {
                const testFile = new File([blob], 'teste.png', { type: 'image/png' });
                
                try {
                    console.log('Testando upload para Imgur...');
                    const url = await uploadParaImgur(testFile);
                    console.log('‚úÖ Imgur funcionando! URL:', url);
                    alert('‚úÖ Upload funcionando!\nURL: ' + url);
                } catch (error) {
                    console.error('‚ùå Erro:', error);
                    alert('‚ùå Erro no upload: ' + error.message);
                }
            }, 'image/png');
        };

        // Teste autom√°tico ao carregar
        console.log('‚úÖ Script carregado com sucesso!');
        console.log('Para testar o upload, execute no console: testarUpload()');
    </script>
</body>
</html>