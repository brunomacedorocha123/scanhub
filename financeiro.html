<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro - ScanHub</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js para Gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary-color: #44689a;
            --secondary-color: #FF6B35;
            --light-color: #e8ecef;
            --dark-color: #2c3e50;
            --white: #ffffff;
            --receita-color: #27ae60;
            --despesa-color: #e74c3c;
            --saldo-color: #3498db;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
            padding-top: 80px;
        }

        /* Logo Grande */
        .navbar-brand-dashboard {
            display: flex;
            align-items: center;
            transform: scale(2.5);
            transform-origin: left center;
            margin-right: 40px;
        }

        .navbar-brand-dashboard img {
            height: 60px;
            width: auto;
            object-fit: contain;
        }

        /* Navbar Dashboard */
        .navbar-dashboard {
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        /* Menu Principal */
        .dashboard-menu {
            list-style: none;
            display: flex;
            gap: 5px;
            margin: 0;
            padding: 0 15px;
            flex-wrap: wrap;
            background: white;
            border-top: 1px solid #eee;
        }

        .dashboard-menu li {
            flex: 1;
            min-width: 120px;
        }

        .dashboard-menu a {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            color: var(--dark-color);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border-radius: 10px;
            background: transparent;
            text-align: center;
        }

        .dashboard-menu a:hover,
        .dashboard-menu a.active {
            background: rgba(68, 104, 154, 0.1);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .dashboard-menu i {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .dashboard-menu span {
            font-size: 0.75rem;
            line-height: 1.2;
        }

        /* User Info */
        .user-info-mobile {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .welcome-card {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(39, 174, 96, 0.3);
        }

        .welcome-card h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        /* Stats Cards */
        .stats-financeiro {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.saldo {
            border-top: 4px solid var(--saldo-color);
        }

        .stat-card.receita {
            border-top: 4px solid var(--receita-color);
        }

        .stat-card.despesa {
            border-top: 4px solid var(--despesa-color);
        }

        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card.saldo i { color: var(--saldo-color); }
        .stat-card.receita i { color: var(--receita-color); }
        .stat-card.despesa i { color: var(--despesa-color); }

        .stat-card h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        /* Gr√°ficos */
        .graficos-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .grafico-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .grafico-card h5 {
            margin-bottom: 20px;
            color: var(--dark-color);
            font-weight: 600;
        }

        /* Calculadora Flutuante */
        .calculadora-flutuante {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .calculadora-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calculadora-btn:hover {
            transform: scale(1.1);
        }

        .calculadora-panel {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 300px;
            display: none;
        }

        .calculadora-panel.show {
            display: block;
        }

        .calculadora-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: right;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            min-height: 60px;
            word-break: break-all;
        }

        .calculadora-botoes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calc-btn {
            padding: 12px 5px;
            border: none;
            border-radius: 8px;
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-btn:hover {
            background: #e9ecef;
        }

        .calc-btn.operador {
            background: #3498db;
            color: white;
        }

        .calc-btn.calcular {
            background: #27ae60;
            color: white;
            grid-column: span 2;
        }

        /* Search and Filter */
        .search-filter-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .search-box input {
            padding-left: 45px;
        }

        /* Tabelas */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background: #f8f9fa;
            border-bottom: 2px solid #e8ecef;
            font-weight: 600;
            color: var(--dark-color);
            padding: 15px;
        }

        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-color: #e8ecef;
        }

        /* Badges de Status */
        .badge-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pago {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
        }

        .status-pendente {
            background: rgba(241, 196, 15, 0.1);
            color: #f39c12;
        }

        .status-atrasado {
            background: rgba(231, 76, 60, 0.1);
            color: #c0392b;
        }

        /* A√ß√µes */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-action-sm {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            font-size: 0.8rem;
            border: none;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-action-sm:hover {
            transform: translateY(-2px);
        }

        .btn-ver:hover {
            background: #3498db;
            color: white;
        }

        .btn-editar:hover {
            background: #f39c12;
            color: white;
        }

        .btn-recibo:hover {
            background: #e74c3c;
            color: white;
        }

        .btn-excluir:hover {
            background: #c0392b;
            color: white;
        }

        /* Bot√µes Principais */
        .btn-primary-action {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }

        /* Modal */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px 30px;
            border: none;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        /* Responsivo */
        @media (max-width: 992px) {
            .navbar-brand-dashboard {
                transform: scale(1.8);
            }
            
            .dashboard-menu {
                position: fixed;
                top: 80px;
                left: 0;
                right: 0;
                background: white;
                flex-direction: column;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                border-radius: 0 0 20px 20px;
                display: none;
                z-index: 999;
            }
            
            .dashboard-menu.show {
                display: flex;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .graficos-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .navbar-brand-dashboard {
                transform: scale(1.6);
            }
            
            .main-content {
                padding: 15px;
            }
            
            .calculadora-panel {
                width: calc(100vw - 40px);
                right: -100px;
            }
        }

        @media (max-width: 576px) {
            .stats-financeiro {
                grid-template-columns: 1fr;
            }
            
            .calculadora-panel {
                width: calc(100vw - 20px);
                right: -60px;
            }
        }

        /* Bot√£o Mobile Menu */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--dark-color);
            padding: 5px 10px;
        }

        /* Notifica√ß√µes */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Categorias simples */
        .categoria-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
        }

        .categoria-receita { background: #27ae60; }
        .categoria-despesa { background: #e74c3c; }
        .categoria-servico { background: #3498db; }
        .categoria-material { background: #9b59b6; }
        .categoria-outros { background: #7f8c8d; }
    </style>
</head>
<body>
    <!-- Navbar Dashboard -->
    <nav class="navbar navbar-dashboard">
        <div class="container-fluid">
            <div class="d-flex align-items-center w-100">
                <!-- Logo -->
                <a class="navbar-brand-dashboard" href="#">
                    <img src="logoscanhub.png" alt="ScanHub">
                </a>

                <!-- Bot√£o Menu Mobile -->
                <button class="mobile-menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- User Info -->
                <div class="user-info-mobile">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-details d-none d-md-block">
                        <h5 id="userName">Carregando...</h5>
                        <small>ID: <span id="userId">---</span></small>
                    </div>
                </div>

                <!-- Bot√£o Logout -->
                <button class="btn btn-outline-danger btn-sm ms-3" id="btnLogout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="d-none d-md-inline">Sair</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Menu Dashboard -->
    <div class="container-fluid">
        <ul class="dashboard-menu" id="dashboardMenu">
            <li>
                <a href="profissional-dashboard.html">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="perfil-profissional.html">
                    <i class="fas fa-user"></i>
                    <span>Perfil</span>
                </a>
            </li>
            <li>
                <a href="meus-clientes.html">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
            </li>
            <li>
                <a href="financeiro.html" class="active">
                    <i class="fas fa-chart-line"></i>
                    <span>Financeiro</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Agenda</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-tools"></i>
                    <span>Servi√ßos</span>
                </a>
            </li>
            <li>
                <a href="pedidos.html">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Pedidos</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Welcome Card -->
        <div class="welcome-card">
            <h1>Financeiro üí∞</h1>
            <p>Controle completo das suas finan√ßas - Receitas, Despesas e An√°lises</p>
        </div>

        <!-- Stats -->
        <div class="stats-financeiro">
            <div class="stat-card saldo">
                <i class="fas fa-wallet"></i>
                <h3 id="saldoAtual">R$ 0,00</h3>
                <p>Saldo Atual</p>
            </div>
            <div class="stat-card receita">
                <i class="fas fa-money-bill-wave"></i>
                <h3 id="receitaMes">R$ 0,00</h3>
                <p>Receita (M√™s)</p>
            </div>
            <div class="stat-card despesa">
                <i class="fas fa-shopping-cart"></i>
                <h3 id="despesaMes">R$ 0,00</h3>
                <p>Despesas (M√™s)</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="atrasados">R$ 0,00</h3>
                <p>Pagamentos Atrasados</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-calendar-day"></i>
                <h3 id="aReceber">R$ 0,00</h3>
                <p>A Receber (7 dias)</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-calendar-times"></i>
                <h3 id="aPagar">R$ 0,00</h3>
                <p>A Pagar (7 dias)</p>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="graficos-container">
            <div class="grafico-card">
                <h5>Fluxo de Caixa - √öltimos 6 Meses</h5>
                <canvas id="graficoFluxoCaixa"></canvas>
            </div>
            <div class="grafico-card">
                <h5>Distribui√ß√£o de Despesas</h5>
                <canvas id="graficoDespesas"></canvas>
            </div>
            <div class="grafico-card">
                <h5>Comparativo Receita x Despesa</h5>
                <canvas id="graficoComparativo"></canvas>
            </div>
        </div>

        <!-- Bot√µes Principais -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0">Movimenta√ß√µes Financeiras</h4>
                <small class="text-muted">Gerencie receitas, despesas e relat√≥rios</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary-action" onclick="abrirModalMovimentacao('receita')">
                    <i class="fas fa-plus-circle"></i> Nova Receita
                </button>
                <button class="btn btn-primary-action" onclick="abrirModalMovimentacao('despesa')">
                    <i class="fas fa-minus-circle"></i> Nova Despesa
                </button>
                <button class="btn btn-primary-action" onclick="exportarPDF()">
                    <i class="fas fa-download"></i> Exportar PDF
                </button>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter-container">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" id="searchMovimentacoes" placeholder="Buscar por descri√ß√£o...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterTipo">
                        <option value="">Todos tipos</option>
                        <option value="receita">Receitas</option>
                        <option value="despesa">Despesas</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterStatus">
                        <option value="">Todos status</option>
                        <option value="pago">Pago/Recebido</option>
                        <option value="pendente">Pendente</option>
                        <option value="atrasado">Atrasado</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterMes">
                        <option value="">Todos os meses</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Mar√ßo</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tabela de Movimenta√ß√µes -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Descri√ß√£o</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Vencimento</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="movimentacoesTable">
                        <tr id="emptyState">
                            <td colspan="8" class="text-center py-5">
                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Nenhuma movimenta√ß√£o cadastrada</h5>
                                <p class="text-muted mb-0">Comece cadastrando sua primeira receita ou despesa</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Calculadora Flutuante -->
    <div class="calculadora-flutuante">
        <div class="calculadora-panel" id="calculadoraPanel">
            <div class="calculadora-display" id="calcDisplay">0</div>
            <div class="calculadora-botoes">
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn operador" onclick="calcInput('/')">√∑</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn operador" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn operador" onclick="calcInput('-')">-</button>
                <button class="calc-btn" onclick="calcInput('0')">0</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>
                <button class="calc-btn" onclick="calcClear()">C</button>
                <button class="calc-btn operador" onclick="calcInput('+')">+</button>
                <button class="calc-btn" onclick="calcPercentage()">%</button>
                <button class="calc-btn calcular" onclick="calcCalculate()">=</button>
            </div>
        </div>
        <button class="calculadora-btn" id="toggleCalculadora">
            <i class="fas fa-calculator"></i>
        </button>
    </div>

    <!-- Modal Movimenta√ß√£o -->
    <div class="modal fade" id="modalMovimentacao" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Nova Movimenta√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formMovimentacao">
                        <input type="hidden" id="movimentacaoId">
                        <input type="hidden" id="tipoMovimentacao" value="receita">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Tipo *</label>
                                <div class="d-flex gap-3">
                                    <button type="button" class="btn btn-outline-success flex-fill tipo-mov-btn active" data-tipo="receita">
                                        <i class="fas fa-arrow-down me-2"></i>Receita
                                    </button>
                                    <button type="button" class="btn btn-outline-danger flex-fill tipo-mov-btn" data-tipo="despesa">
                                        <i class="fas fa-arrow-up me-2"></i>Despesa
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Data *</label>
                                <input type="date" class="form-control" id="dataMovimentacao" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Descri√ß√£o *</label>
                                <input type="text" class="form-control" id="descricao" required placeholder="Ex: Pagamento do cliente, Compra de material...">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Categoria *</label>
                                <select class="form-select" id="categoria" required>
                                    <option value="">Selecione...</option>
                                    <option value="servico" class="categoria-receita">Servi√ßo Prestado</option>
                                    <option value="produto" class="categoria-receita">Venda de Produto</option>
                                    <option value="material" class="categoria-despesa">Material/Insumo</option>
                                    <option value="marketing" class="categoria-despesa">Marketing</option>
                                    <option value="transporte" class="categoria-despesa">Transporte</option>
                                    <option value="imposto" class="categoria-despesa">Imposto</option>
                                    <option value="salario" class="categoria-despesa">Sal√°rio</option>
                                    <option value="aluguel" class="categoria-despesa">Aluguel</option>
                                    <option value="outros" class="categoria-outros">Outros</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Valor (R$) *</label>
                                <input type="number" class="form-control" id="valor" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="status" required>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago/Recebido</option>
                                    <option value="atrasado">Atrasado</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Vencimento *</label>
                                <input type="date" class="form-control" id="vencimento" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Forma de Pagamento</label>
                                <select class="form-select" id="formaPagamento">
                                    <option value="">Selecione...</option>
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="pix">PIX</option>
                                    <option value="cartao_credito">Cart√£o de Cr√©dito</option>
                                    <option value="cartao_debito">Cart√£o de D√©bito</option>
                                    <option value="boleto">Boleto</option>
                                    <option value="transferencia">Transfer√™ncia</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Observa√ß√µes</label>
                                <textarea class="form-control" id="observacoes" rows="2" placeholder="Observa√ß√µes adicionais..."></textarea>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="despesaFixa">
                                <label class="form-check-label" for="despesaFixa">
                                    Esta √© uma despesa fixa mensal
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-action" id="btnSalvarMovimentacao">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut 
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            getDocs,
            query,
            where,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAYqWTg2RAr4IbqxRsl58TZGQ9tKnyFK14",
            authDomain: "scanhub-ed512.firebaseapp.com",
            projectId: "scanhub-ed512",
            storageBucket: "scanhub-ed512.firebasestorage.app",
            messagingSenderId: "1083305018831",
            appId: "1:1083305018831:web:f7594d560439c8965c3eba"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ============================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================
        let currentUser = null;
        let userData = null;
        let movimentacoes = [];
        let calculadoraVisible = false;
        let calculadoraValue = '0';

        // ============================================
        // ELEMENTOS DOM
        // ============================================
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const userId = document.getElementById('userId');
        const btnLogout = document.getElementById('btnLogout');
        const menuToggle = document.getElementById('menuToggle');
        const dashboardMenu = document.getElementById('dashboardMenu');
        
        // Elementos de estat√≠sticas
        const saldoAtual = document.getElementById('saldoAtual');
        const receitaMes = document.getElementById('receitaMes');
        const despesaMes = document.getElementById('despesaMes');
        const atrasados = document.getElementById('atrasados');
        const aReceber = document.getElementById('aReceber');
        const aPagar = document.getElementById('aPagar');
        
        // Elementos de filtro
        const searchMovimentacoes = document.getElementById('searchMovimentacoes');
        const filterTipo = document.getElementById('filterTipo');
        const filterStatus = document.getElementById('filterStatus');
        const filterMes = document.getElementById('filterMes');
        
        // Tabelas
        const movimentacoesTable = document.getElementById('movimentacoesTable');
        const emptyState = document.getElementById('emptyState');
        
        // Calculadora
        const calculadoraPanel = document.getElementById('calculadoraPanel');
        const toggleCalculadora = document.getElementById('toggleCalculadora');
        const calcDisplay = document.getElementById('calcDisplay');

        // ============================================
        // INICIALIZA√á√ÉO DO SISTEMA
        // ============================================

        // Monitorar autentica√ß√£o
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userRef = doc(db, "usuarios", user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        userData = userDoc.data();
                        atualizarInterfaceUsuario(userData);
                        await carregarMovimentacoes();
                        inicializarSistema();
                        inicializarGraficos();
                    }
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    showNotification('Erro ao carregar dados do usu√°rio', 'error');
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        function inicializarSistema() {
            inicializarCalculadora();
            inicializarEventListeners();
            inicializarModais();
        }

        function atualizarInterfaceUsuario(data) {
            if (data.apelido) {
                userName.textContent = `Ol√°, ${data.apelido}`;
                userAvatar.textContent = data.apelido.charAt(0).toUpperCase();
            } else if (data.nomeCompleto) {
                userName.textContent = `Ol√°, ${data.nomeCompleto.split(' ')[0]}`;
                userAvatar.textContent = data.nomeCompleto.charAt(0).toUpperCase();
            }
            
            if (data.idScanHub) {
                userId.textContent = data.idScanHub;
            }
        }

        // ============================================
        // CARREGAMENTO DE DADOS
        // ============================================

        async function carregarMovimentacoes() {
            try {
                const q = query(
                    collection(db, "movimentacoes"),
                    where("profissionalId", "==", currentUser.uid),
                    orderBy("data", "desc")
                );
                
                const querySnapshot = await getDocs(q);
                movimentacoes = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    movimentacoes.push({
                        id: doc.id,
                        ...data,
                        data: data.data?.toDate?.().toISOString().split('T')[0] || data.data,
                        vencimento: data.vencimento?.toDate?.().toISOString().split('T')[0] || data.vencimento
                    });
                });
                
                // Verificar e atualizar status de atrasados
                await verificarAtrasados();
                
                atualizarTabelaMovimentacoes();
                atualizarEstatisticas();
            } catch (error) {
                console.error('Erro ao carregar movimenta√ß√µes:', error);
                showNotification('Erro ao carregar movimenta√ß√µes', 'error');
            }
        }

        async function verificarAtrasados() {
            const hoje = new Date().toISOString().split('T')[0];

            for (const mov of movimentacoes) {
                if (mov.status === 'pendente' && mov.vencimento < hoje) {
                    try {
                        const movRef = doc(db, "movimentacoes", mov.id);
                        await updateDoc(movRef, {
                            status: 'atrasado',
                            atualizadoEm: serverTimestamp()
                        });
                        
                        mov.status = 'atrasado';
                    } catch (error) {
                        console.error('Erro ao atualizar status:', error);
                    }
                }
            }
        }

        // ============================================
        // TABELA DE MOVIMENTA√á√ïES
        // ============================================

        function atualizarTabelaMovimentacoes() {
            const searchTerm = searchMovimentacoes.value.toLowerCase();
            const tipoFilter = filterTipo.value;
            const statusFilter = filterStatus.value;
            const mesFilter = filterMes.value;
            
            // Aplicar filtros
            let movimentacoesFiltradas = movimentacoes.filter(mov => {
                const matchSearch = !searchTerm || 
                    (mov.descricao && mov.descricao.toLowerCase().includes(searchTerm));
                
                const matchTipo = !tipoFilter || mov.tipo === tipoFilter;
                const matchStatus = !statusFilter || mov.status === statusFilter;
                
                let matchMes = true;
                if (mesFilter && mov.data) {
                    const data = new Date(mov.data);
                    const mes = data.getMonth() + 1;
                    matchMes = mes.toString() === mesFilter;
                }
                
                return matchSearch && matchTipo && matchStatus && matchMes;
            });
            
            // Limpar tabela
            movimentacoesTable.innerHTML = '';
            
            if (movimentacoesFiltradas.length === 0) {
                const emptyRow = emptyState.cloneNode(true);
                emptyRow.id = '';
                movimentacoesTable.appendChild(emptyRow);
                return;
            }
            
            // Preencher tabela
            movimentacoesFiltradas.forEach(mov => {
                const row = document.createElement('tr');
                
                const dataFormatada = formatarData(mov.data);
                const vencimentoFormatado = formatarData(mov.vencimento);
                const valorFormatado = formatarMoeda(mov.valor);
                
                // Determinar categoria
                const categoriaClass = getCategoriaClass(mov.categoria);
                const categoriaNome = getCategoriaNome(mov.categoria);
                
                // Determinar estilo baseado no tipo
                const tipoBadge = mov.tipo === 'receita' 
                    ? '<span class="badge-status status-pago"><i class="fas fa-arrow-down me-1"></i>Receita</span>'
                    : '<span class="badge-status status-atrasado"><i class="fas fa-arrow-up me-1"></i>Despesa</span>';
                
                const statusBadge = getStatusBadge(mov.status);
                
                row.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>${tipoBadge}</td>
                    <td>${mov.descricao || 'Sem descri√ß√£o'}</td>
                    <td>
                        <span class="categoria-badge ${categoriaClass}">
                            ${categoriaNome}
                        </span>
                    </td>
                    <td class="${mov.tipo === 'receita' ? 'text-success' : 'text-danger'} fw-bold">
                        ${mov.tipo === 'receita' ? '+' : '-'} ${valorFormatado}
                    </td>
                    <td>${statusBadge}</td>
                    <td>${vencimentoFormatado}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action-sm btn-editar" onclick="editarMovimentacao('${mov.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action-sm btn-excluir" onclick="excluirMovimentacao('${mov.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                // Destacar linhas atrasadas
                if (mov.status === 'atrasado') {
                    row.style.backgroundColor = '#fff5f5';
                }
                
                movimentacoesTable.appendChild(row);
            });
        }

        function getCategoriaClass(categoria) {
            switch(categoria) {
                case 'servico':
                case 'produto':
                    return 'categoria-receita';
                case 'material':
                case 'marketing':
                case 'transporte':
                case 'imposto':
                case 'salario':
                case 'aluguel':
                    return 'categoria-despesa';
                default:
                    return 'categoria-outros';
            }
        }

        function getCategoriaNome(categoria) {
            const categorias = {
                'servico': 'Servi√ßo',
                'produto': 'Produto',
                'material': 'Material',
                'marketing': 'Marketing',
                'transporte': 'Transporte',
                'imposto': 'Imposto',
                'salario': 'Sal√°rio',
                'aluguel': 'Aluguel',
                'outros': 'Outros'
            };
            return categorias[categoria] || 'Outros';
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'pago':
                    return '<span class="badge-status status-pago"><i class="fas fa-check me-1"></i>Pago</span>';
                case 'pendente':
                    return '<span class="badge-status status-pendente"><i class="fas fa-clock me-1"></i>Pendente</span>';
                case 'atrasado':
                    return '<span class="badge-status status-atrasado"><i class="fas fa-exclamation-triangle me-1"></i>Atrasado</span>';
                default:
                    return `<span class="badge-status">${status}</span>`;
            }
        }

        // ============================================
        // ESTAT√çSTICAS E GR√ÅFICOS
        // ============================================

        function atualizarEstatisticas() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            // Filtrar movimenta√ß√µes do m√™s atual
            const movimentacoesMes = movimentacoes.filter(mov => {
                if (!mov.data) return false;
                const dataMov = new Date(mov.data);
                return dataMov.getMonth() === mesAtual && 
                       dataMov.getFullYear() === anoAtual;
            });
            
            // Calcular valores
            let totalReceita = 0;
            let totalDespesa = 0;
            let totalAtrasados = 0;
            let totalAReceber7dias = 0;
            let totalAPagar7dias = 0;
            
            movimentacoes.forEach(mov => {
                const valor = parseFloat(mov.valor) || 0;
                
                if (mov.tipo === 'receita') {
                    totalReceita += valor;
                    
                    // A receber nos pr√≥ximos 7 dias
                    if ((mov.status === 'pendente' || mov.status === 'atrasado') && mov.vencimento) {
                        const vencimento = new Date(mov.vencimento);
                        const diferencaDias = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                        if (diferencaDias <= 7 && diferencaDias >= 0) {
                            totalAReceber7dias += valor;
                        }
                    }
                    
                    // Atrasados
                    if (mov.status === 'atrasado') {
                        totalAtrasados += valor;
                    }
                } else if (mov.tipo === 'despesa') {
                    totalDespesa += valor;
                    
                    // A pagar nos pr√≥ximos 7 dias
                    if ((mov.status === 'pendente' || mov.status === 'atrasado') && mov.vencimento) {
                        const vencimento = new Date(mov.vencimento);
                        const diferencaDias = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                        if (diferencaDias <= 7 && diferencaDias >= 0) {
                            totalAPagar7dias += valor;
                        }
                    }
                    
                    // Atrasados
                    if (mov.status === 'atrasado') {
                        totalAtrasados += valor;
                    }
                }
            });
            
            const saldo = totalReceita - totalDespesa;
            
            // Atualizar elementos
            saldoAtual.textContent = formatarMoeda(saldo);
            receitaMes.textContent = formatarMoeda(totalReceita);
            despesaMes.textContent = formatarMoeda(totalDespesa);
            atrasados.textContent = formatarMoeda(totalAtrasados);
            aReceber.textContent = formatarMoeda(totalAReceber7dias);
            aPagar.textContent = formatarMoeda(totalAPagar7dias);
        }

        function inicializarGraficos() {
            // Preparar dados dos √∫ltimos 6 meses
            const meses = getUltimos6Meses();
            const dadosReceitas = gerarDadosPorMes('receita');
            const dadosDespesas = gerarDadosPorMes('despesa');
            
            // Gr√°fico de Fluxo de Caixa (√∫ltimos 6 meses)
            const ctxFluxo = document.getElementById('graficoFluxoCaixa');
            if (ctxFluxo) {
                new Chart(ctxFluxo.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: meses,
                        datasets: [
                            {
                                label: 'Receitas',
                                data: dadosReceitas,
                                borderColor: '#27ae60',
                                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2
                            },
                            {
                                label: 'Despesas',
                                data: dadosDespesas,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatarMoeda(context.raw)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Distribui√ß√£o de Despesas
            const ctxDespesas = document.getElementById('graficoDespesas');
            if (ctxDespesas) {
                const dadosCategorias = getDadosCategoriasDespesa();
                new Chart(ctxDespesas.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: dadosCategorias.labels,
                        datasets: [{
                            data: dadosCategorias.valores,
                            backgroundColor: dadosCategorias.cores,
                            borderWidth: 1,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${formatarMoeda(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico Comparativo
            const ctxComparativo = document.getElementById('graficoComparativo');
            if (ctxComparativo) {
                new Chart(ctxComparativo.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: meses,
                        datasets: [
                            {
                                label: 'Receitas',
                                data: dadosReceitas,
                                backgroundColor: 'rgba(39, 174, 96, 0.7)',
                                borderColor: '#27ae60',
                                borderWidth: 1
                            },
                            {
                                label: 'Despesas',
                                data: dadosDespesas,
                                backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                borderColor: '#e74c3c',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function getDadosCategoriasDespesa() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            const categoriasDespesa = {
                'material': 0,
                'marketing': 0,
                'transporte': 0,
                'imposto': 0,
                'salario': 0,
                'aluguel': 0,
                'outros': 0
            };
            
            // Calcular totais por categoria
            movimentacoes.forEach(mov => {
                if (mov.tipo === 'despesa') {
                    const dataMov = new Date(mov.data);
                    if (dataMov.getMonth() === mesAtual && dataMov.getFullYear() === anoAtual) {
                        const categoria = mov.categoria || 'outros';
                        categoriasDespesa[categoria] = (categoriasDespesa[categoria] || 0) + (mov.valor || 0);
                    }
                }
            });
            
            // Preparar dados para o gr√°fico
            const labels = [];
            const valores = [];
            const cores = ['#e74c3c', '#9b59b6', '#f39c12', '#34495e', '#1abc9c', '#d35400', '#7f8c8d'];
            
            Object.entries(categoriasDespesa).forEach(([categoria, valor], index) => {
                if (valor > 0) {
                    labels.push(getCategoriaNome(categoria));
                    valores.push(valor);
                }
            });
            
            return {
                labels: labels,
                valores: valores,
                cores: cores.slice(0, labels.length)
            };
        }

        function gerarDadosPorMes(tipo) {
            const hoje = new Date();
            const dados = [];
            
            for (let i = 5; i >= 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const mes = data.getMonth();
                const ano = data.getFullYear();
                
                const total = movimentacoes
                    .filter(m => {
                        if (m.tipo !== tipo) return false;
                        const dataMov = new Date(m.data);
                        return dataMov.getMonth() === mes && 
                               dataMov.getFullYear() === ano;
                    })
                    .reduce((sum, m) => sum + (m.valor || 0), 0);
                
                dados.push(total);
            }
            
            return dados;
        }

        // ============================================
        // CALCULADORA - CORRIGIDA 100% FUNCIONAL
        // ============================================

        function inicializarCalculadora() {
            toggleCalculadora.addEventListener('click', () => {
                calculadoraVisible = !calculadoraVisible;
                calculadoraPanel.classList.toggle('show', calculadoraVisible);
            });
            
            // Fechar calculadora ao clicar fora
            document.addEventListener('click', (e) => {
                if (!calculadoraPanel.contains(e.target) && !toggleCalculadora.contains(e.target)) {
                    calculadoraPanel.classList.remove('show');
                    calculadoraVisible = false;
                }
            });
        }

        window.calcInput = function(value) {
            if (calculadoraValue === '0' && value !== '.') {
                calculadoraValue = value;
            } else {
                calculadoraValue += value;
            }
            calcDisplay.textContent = calculadoraValue;
        };

        window.calcClear = function() {
            calculadoraValue = '0';
            calcDisplay.textContent = calculadoraValue;
        };

        // FUN√á√ÉO DE PORCENTAGEM 100% FUNCIONAL
        window.calcPercentage = function() {
            try {
                let expression = calculadoraValue.replace(/√ó/g, '*').replace(/√∑/g, '/');
                
                // Se n√£o tem operador, apenas calcula porcentagem do n√∫mero
                if (!/[+\-*/]/.test(expression)) {
                    let num = parseFloat(expression) / 100;
                    calculadoraValue = num.toString();
                    calcDisplay.textContent = calculadoraValue;
                    return;
                }
                
                // Divide a express√£o em partes: n√∫mero, operador, n√∫mero
                let parts = expression.match(/(\d+\.?\d*)([+\-*/])(\d+\.?\d*)/);
                
                if (parts && parts.length === 4) {
                    let num1 = parseFloat(parts[1]);
                    let operador = parts[2];
                    let num2 = parseFloat(parts[3]);
                    
                    let result;
                    switch(operador) {
                        case '+':
                            result = num1 + (num1 * (num2 / 100));
                            break;
                        case '-':
                            result = num1 - (num1 * (num2 / 100));
                            break;
                        case '*':
                            result = num1 * (num2 / 100);
                            break;
                        case '/':
                            result = num1 / (num2 / 100);
                            break;
                        default:
                            result = 0;
                    }
                    
                    calculadoraValue = result.toString();
                    calcDisplay.textContent = calculadoraValue;
                }
            } catch (error) {
                calculadoraValue = 'Erro';
                calcDisplay.textContent = calculadoraValue;
            }
        };

        window.calcCalculate = function() {
            try {
                let expression = calculadoraValue.replace(/√ó/g, '*').replace(/√∑/g, '/');
                const result = eval(expression) || 0;
                calculadoraValue = parseFloat(result.toFixed(2)).toString();
                calcDisplay.textContent = calculadoraValue;
            } catch (error) {
                calculadoraValue = 'Erro';
                calcDisplay.textContent = calculadoraValue;
            }
        };

        // ============================================
        // FUN√á√ïES PRINCIPAIS
        // ============================================

        window.abrirModalMovimentacao = function(tipo = 'receita') {
            const modalTitle = document.getElementById('modalTitle');
            
            modalTitle.textContent = tipo === 'receita' ? 'Nova Receita' : 'Nova Despesa';
            
            // Resetar formul√°rio
            document.getElementById('formMovimentacao').reset();
            document.getElementById('movimentacaoId').value = '';
            
            // Definir tipo
            document.getElementById('tipoMovimentacao').value = tipo;
            
            // Ativar bot√£o correto
            document.querySelectorAll('.tipo-mov-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tipo') === tipo) {
                    btn.classList.add('active');
                }
            });
            
            // Configurar data atual
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataMovimentacao').value = hoje;
            document.getElementById('vencimento').value = hoje;
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('modalMovimentacao')).show();
        };

        window.editarMovimentacao = async function(id) {
            const mov = movimentacoes.find(m => m.id === id);
            if (!mov) {
                showNotification('Movimenta√ß√£o n√£o encontrada!', 'error');
                return;
            }
            
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.textContent = `Editar ${mov.tipo === 'receita' ? 'Receita' : 'Despesa'}`;
            
            // Preencher dados
            document.getElementById('movimentacaoId').value = mov.id;
            document.getElementById('descricao').value = mov.descricao || '';
            document.getElementById('categoria').value = mov.categoria || 'outros';
            document.getElementById('valor').value = mov.valor || 0;
            document.getElementById('status').value = mov.status || 'pendente';
            document.getElementById('dataMovimentacao').value = mov.data || '';
            document.getElementById('vencimento').value = mov.vencimento || '';
            document.getElementById('formaPagamento').value = mov.formaPagamento || '';
            document.getElementById('observacoes').value = mov.observacoes || '';
            document.getElementById('despesaFixa').checked = mov.despesaFixa || false;
            
            // Definir tipo
            document.getElementById('tipoMovimentacao').value = mov.tipo;
            
            // Ativar bot√£o correto
            document.querySelectorAll('.tipo-mov-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tipo') === mov.tipo) {
                    btn.classList.add('active');
                }
            });
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('modalMovimentacao')).show();
        };

        document.getElementById('btnSalvarMovimentacao').addEventListener('click', async function() {
            await salvarMovimentacao();
        });

        async function salvarMovimentacao() {
            // Valida√ß√£o b√°sica
            const descricao = document.getElementById('descricao').value.trim();
            const valor = parseFloat(document.getElementById('valor').value);
            const categoria = document.getElementById('categoria').value;
            const dataMov = document.getElementById('dataMovimentacao').value;
            const vencimento = document.getElementById('vencimento').value;
            
            if (!descricao) {
                showNotification('Informe uma descri√ß√£o.', 'warning');
                return;
            }
            
            if (!valor || isNaN(valor) || valor <= 0) {
                showNotification('Informe um valor v√°lido maior que zero.', 'warning');
                return;
            }
            
            if (!categoria) {
                showNotification('Selecione uma categoria.', 'warning');
                return;
            }
            
            if (!dataMov) {
                showNotification('Informe a data da movimenta√ß√£o.', 'warning');
                return;
            }
            
            if (!vencimento) {
                showNotification('Informe a data de vencimento.', 'warning');
                return;
            }
            
            try {
                const movData = {
                    tipo: document.getElementById('tipoMovimentacao').value,
                    descricao: descricao,
                    categoria: categoria,
                    valor: valor,
                    status: document.getElementById('status').value,
                    data: dataMov,
                    vencimento: vencimento,
                    formaPagamento: document.getElementById('formaPagamento').value || '',
                    observacoes: document.getElementById('observacoes').value || '',
                    despesaFixa: document.getElementById('despesaFixa').checked,
                    profissionalId: currentUser.uid,
                    atualizadoEm: serverTimestamp()
                };
                
                const movId = document.getElementById('movimentacaoId').value;
                
                if (movId) {
                    // Atualizar
                    const movRef = doc(db, "movimentacoes", movId);
                    await updateDoc(movRef, movData);
                    
                    // Atualizar localmente
                    const index = movimentacoes.findIndex(m => m.id === movId);
                    if (index !== -1) {
                        movimentacoes[index] = { ...movimentacoes[index], ...movData };
                    }
                    
                    showNotification('Movimenta√ß√£o atualizada com sucesso!', 'success');
                } else {
                    // Nova movimenta√ß√£o
                    movData.criadoEm = serverTimestamp();
                    const docRef = await addDoc(collection(db, "movimentacoes"), movData);
                    movData.id = docRef.id;
                    movimentacoes.unshift(movData);
                    
                    showNotification('Movimenta√ß√£o criada com sucesso!', 'success');
                }
                
                // Fechar modal
                bootstrap.Modal.getInstance(document.getElementById('modalMovimentacao')).hide();
                
                // Atualizar interface
                atualizarTabelaMovimentacoes();
                atualizarEstatisticas();
                inicializarGraficos(); // Atualizar gr√°ficos
                
            } catch (error) {
                console.error('Erro ao salvar movimenta√ß√£o:', error);
                showNotification('Erro ao salvar movimenta√ß√£o. Tente novamente.', 'error');
            }
        }

        window.excluirMovimentacao = async function(id) {
            if (!confirm('Tem certeza que deseja excluir esta movimenta√ß√£o?\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                const movRef = doc(db, "movimentacoes", id);
                await deleteDoc(movRef);
                
                // Remover da lista local
                const index = movimentacoes.findIndex(m => m.id === id);
                if (index !== -1) {
                    movimentacoes.splice(index, 1);
                }
                
                // Atualizar interface
                atualizarTabelaMovimentacoes();
                atualizarEstatisticas();
                inicializarGraficos(); // Atualizar gr√°ficos
                
                showNotification('Movimenta√ß√£o exclu√≠da com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir movimenta√ß√£o:', error);
                showNotification('Erro ao excluir movimenta√ß√£o. Tente novamente.', 'error');
            }
        };

        // ============================================
        // EXPORTA√á√ÉO
        // ============================================

        window.exportarPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const margin = 20;
            const pageWidth = doc.internal.pageSize.width;
            let y = margin;
            
            // Cabe√ßalho
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('RELAT√ìRIO FINANCEIRO - SCANHUB', pageWidth/2, y, { align: 'center' });
            y += 10;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Profissional: ${userData?.nomeCompleto || userData?.apelido || '---'}`, margin, y);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth - margin, y, { align: 'right' });
            y += 15;
            
            // Resumo Financeiro
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMO FINANCEIRO', margin, y);
            y += 10;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const resumo = [
                ['Saldo Atual:', saldoAtual.textContent],
                ['Receita do M√™s:', receitaMes.textContent],
                ['Despesas do M√™s:', despesaMes.textContent],
                ['Pagamentos Atrasados:', atrasados.textContent],
                ['A Receber (7 dias):', aReceber.textContent],
                ['A Pagar (7 dias):', aPagar.textContent]
            ];
            
            resumo.forEach(([label, value]) => {
                doc.text(label, margin, y);
                doc.text(value, pageWidth - margin, y, { align: 'right' });
                y += 7;
            });
            
            y += 10;
            
            // Movimenta√ß√µes
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('MOVIMENTA√á√ïES', margin, y);
            y += 10;
            
            // Adicionar movimenta√ß√µes
            movimentacoes.forEach((mov, index) => {
                if (y > 250) {
                    doc.addPage();
                    y = margin;
                }
                
                const categoriaNome = getCategoriaNome(mov.categoria);
                const valor = formatarMoeda(mov.valor);
                
                doc.setFontSize(9);
                doc.text(`${formatarData(mov.data)} - ${mov.descricao}`, margin, y);
                doc.text(`${categoriaNome}`, pageWidth/2 - 20, y);
                doc.text(`${mov.tipo === 'receita' ? '+' : '-'} ${valor}`, pageWidth - margin, y, { align: 'right' });
                y += 6;
            });
            
            doc.save(`Relatorio-Financeiro-${new Date().toISOString().slice(0,10)}.pdf`);
            showNotification('Relat√≥rio PDF gerado com sucesso!', 'success');
        };

        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================

        function formatarData(dataString) {
            if (!dataString) return '--';
            try {
                const date = new Date(dataString);
                if (isNaN(date.getTime())) return '--';
                return date.toLocaleDateString('pt-BR');
            } catch {
                return '--';
            }
        }

        function formatarMoeda(valor) {
            if (!valor && valor !== 0) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function getUltimos6Meses() {
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const hoje = new Date();
            const ultimosMeses = [];
            
            for (let i = 5; i >= 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                ultimosMeses.push(`${meses[data.getMonth()]}/${data.getFullYear().toString().slice(2)}`);
            }
            
            return ultimosMeses;
        }

        function showNotification(message, type = 'success') {
            // Remover notifica√ß√µes anteriores
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            // Criar nova notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        function inicializarEventListeners() {
            // Filtros
            searchMovimentacoes.addEventListener('input', atualizarTabelaMovimentacoes);
            filterTipo.addEventListener('change', atualizarTabelaMovimentacoes);
            filterStatus.addEventListener('change', atualizarTabelaMovimentacoes);
            filterMes.addEventListener('change', atualizarTabelaMovimentacoes);
            
            // Menu mobile
            menuToggle.addEventListener('click', () => {
                dashboardMenu.classList.toggle('show');
                const icon = menuToggle.querySelector('i');
                icon.classList.toggle('fa-bars');
                icon.classList.toggle('fa-times');
            });
            
            // Fechar menu ao clicar fora
            document.addEventListener('click', (e) => {
                if (!dashboardMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                    dashboardMenu.classList.remove('show');
                    const icon = menuToggle.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });
            
            // Logout
            btnLogout.addEventListener('click', async () => {
                if (confirm('Tem certeza que deseja sair?')) {
                    try {
                        await signOut(auth);
                        window.location.href = 'login.html';
                    } catch {
                        showNotification('Erro ao sair. Tente novamente.', 'error');
                    }
                }
            });
            
            // Bot√µes de tipo no modal
            document.querySelectorAll('.tipo-mov-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tipo-mov-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('tipoMovimentacao').value = this.getAttribute('data-tipo');
                });
            });
        }

        function inicializarModais() {
            // Configurar data padr√£o
            const hoje = new Date().toISOString().split('T')[0];
            const dataMov = document.getElementById('dataMovimentacao');
            const vencimento = document.getElementById('vencimento');
            
            if (dataMov) {
                dataMov.value = hoje;
            }
            
            if (vencimento) {
                vencimento.value = hoje;
            }
        }

    </script>
</body>
</html>