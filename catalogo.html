<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo - ScanHub</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #44689a;
            --primary-light: rgba(68, 104, 154, 0.1);
            --secondary-color: #FF6B35;
            --secondary-light: rgba(255, 107, 53, 0.1);
            --light-color: #f8f9fa;
            --dark-color: #2c3e50;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        /* ========== RESET E ESTILOS BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
            padding-top: 80px;
            overflow-x: hidden;
        }

        /* ========== LOGO GRANDE ========== */
        .navbar-brand-dashboard {
            display: flex;
            align-items: center;
            transform: scale(2.5);
            transform-origin: left center;
            margin-right: 40px;
        }

        .navbar-brand-dashboard img {
            height: 60px;
            width: auto;
            object-fit: contain;
        }

        /* ========== NAVBAR DASHBOARD ========== */
        .navbar-dashboard {
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .navbar-dashboard .container-fluid {
            padding: 0 15px;
        }

        /* ========== MENU DASHBOARD HORIZONTAL ========== */
        .dashboard-menu {
            list-style: none;
            display: flex;
            gap: 5px;
            margin: 0;
            padding: 0;
            flex-wrap: wrap;
        }

        .dashboard-menu li {
            flex: 1;
            min-width: 120px;
        }

        .dashboard-menu a {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            color: var(--dark-color);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            border-radius: 10px;
            background: transparent;
            text-align: center;
        }

        .dashboard-menu a:hover,
        .dashboard-menu a.active {
            background: rgba(68, 104, 154, 0.1);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .dashboard-menu i {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .dashboard-menu span {
            font-size: 0.75rem;
            line-height: 1.2;
        }

        /* ========== USER INFO ========== */
        .user-info-mobile {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .user-details h5 {
            margin: 0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-details small {
            color: #666;
            font-size: 0.75rem;
        }

        /* ========== BOTÃO MENU MOBILE ========== */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--dark-color);
            padding: 5px 10px;
            margin-left: 10px;
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            padding: 20px;
            min-height: calc(100vh - 80px);
            max-width: 100%;
            overflow-x: hidden;
        }

        /* ========== HEADER COM ABAS ========== */
        .header-abas {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .header-abas .row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .catalogo-tabs-container {
            display: flex;
            background: var(--gray-100);
            border-radius: 10px;
            padding: 4px;
            border: 1px solid var(--gray-200);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            width: 100%;
        }

        .catalogo-tabs-container::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--gray-600);
            font-weight: 500;
            font-size: 14px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }

        .tab-badge {
            background: var(--gray-200);
            color: var(--gray-600);
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .tab-btn.active .tab-badge {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .btn-primary-action {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #F7931E 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        /* ========== STATS CARDS ========== */
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid #e8ecef;
        }

        .stat-card i {
            font-size: 2.5rem;
            color: #FF6B35;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .stat-card p {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }

        /* ========== CATÁLOGO GRID ========== */
        .catalogo-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .catalogo-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid #e8ecef;
        }

        .catalogo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .card-image {
            height: 180px;
            background: var(--gray-100);
            position: relative;
            overflow: hidden;
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .catalogo-card:hover .card-image img {
            transform: scale(1.05);
        }

        .card-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 2;
        }

        .badge-servico {
            background: rgba(52, 152, 219, 0.95);
            color: white;
        }

        .badge-produto {
            background: rgba(46, 204, 113, 0.95);
            color: white;
        }

        .card-content {
            padding: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 12px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 45px;
        }

        .card-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 5px;
        }

        /* Status badge */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
        }

        .status-inactive {
            background: rgba(231, 76, 60, 0.1);
            color: #c0392b;
        }

        .status-pending {
            background: rgba(241, 196, 15, 0.1);
            color: #f39c12;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-card {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 36px;
        }

        .btn-card-edit {
            background: var(--gray-100);
            color: var(--primary-color);
            border: 1px solid var(--gray-300);
        }

        .btn-card-edit:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
        }

        .btn-card-delete {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .btn-card-delete:hover {
            background: rgba(220, 53, 69, 0.15);
        }

        /* ========== MODAL ========== */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px 30px;
            border: none;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }

        .modal-header .btn-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e8ecef;
            background: white;
            border-radius: 0 0 15px 15px;
        }

        /* ========== FORMULÁRIOS ========== */
        .form-label {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e8ecef;
            padding: 10px 15px;
            transition: all 0.3s ease;
            font-size: 16px !important; /* Prevenir zoom iOS */
        }

        .form-control:focus, .form-select:focus {
            border-color: #FF6B35;
            box-shadow: 0 0 0 0.25rem rgba(255, 107, 53, 0.25);
        }

        /* ========== TABS DO MODAL ========== */
        .modal-tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .modal-tabs::-webkit-scrollbar {
            display: none;
        }

        .modal-tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            font-weight: 500;
            color: var(--gray-600);
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            font-size: 14px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .modal-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* ========== UPLOAD AREA ========== */
        .upload-area {
            border: 3px dashed var(--gray-300);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            background: var(--gray-100);
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .upload-area i {
            font-size: 40px;
            color: var(--gray-500);
            margin-bottom: 15px;
        }

        /* ========== GALLERY GRID ========== */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .gallery-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
            background: var(--gray-100);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(220, 53, 69, 0.95);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .gallery-item-remove:hover {
            transform: scale(1.1);
        }

        /* ========== TAGS ========== */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            background: white;
            min-height: 48px;
            margin-top: 10px;
        }

        .tag {
            background: var(--primary-light);
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .tag-remove {
            cursor: pointer;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        /* ========== FINANCEIRO ========== */
        .financeiro-container {
            background: var(--gray-100);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--danger-color);
        }

        .financeiro-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .financeiro-item:last-child {
            border-bottom: none;
        }

        .financeiro-valor {
            font-weight: 600;
            font-size: 15px;
        }

        .financeiro-lucro {
            color: var(--success-color);
        }

        .financeiro-custo {
            color: var(--danger-color);
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-600);
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 48px;
            color: var(--gray-300);
            margin-bottom: 20px;
        }

        .empty-state h4 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--gray-700);
        }

        .empty-state p {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* ========== LOADING ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== TOAST ========== */
        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.3s ease-out;
            border-left: 4px solid var(--primary-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== RESPONSIVIDADE ========== */
        @media (max-width: 1200px) {
            .navbar-brand-dashboard {
                transform: scale(2);
            }
            
            .dashboard-menu a {
                font-size: 0.8rem;
                padding: 12px 8px;
            }
            
            .dashboard-menu i {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 992px) {
            .navbar-brand-dashboard {
                transform: scale(1.8);
                margin-right: 20px;
            }
            
            .dashboard-menu {
                position: fixed;
                top: 80px;
                left: 0;
                right: 0;
                background: white;
                flex-direction: column;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                border-radius: 0 0 20px 20px;
                display: none;
                z-index: 999;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            .dashboard-menu.show {
                display: flex;
            }
            
            .dashboard-menu li {
                width: 100%;
            }
            
            .dashboard-menu a {
                flex-direction: row;
                justify-content: flex-start;
                padding: 15px;
                font-size: 1rem;
                text-align: left;
            }
            
            .dashboard-menu i {
                margin-right: 15px;
                margin-bottom: 0;
                width: 25px;
                text-align: center;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .user-info-mobile {
                margin-left: 0;
            }
            
            .header-abas .row {
                flex-direction: column;
            }
            
            .catalogo-tabs-container {
                overflow-x: auto;
            }
            
            .btn-primary-action {
                width: 100%;
                margin-top: 10px;
            }
        }

        @media (min-width: 768px) {
            .catalogo-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn-primary-action {
                width: auto;
            }
            
            .header-abas .row {
                flex-direction: row;
                align-items: center;
            }
        }

        @media (max-width: 768px) {
            body {
                padding-top: 70px;
            }
            
            .navbar-brand-dashboard {
                transform: scale(1.6);
            }
            
            .main-content {
                padding: 15px;
            }
            
            .header-abas {
                padding: 20px;
            }
            
            .catalogo-grid {
                gap: 15px;
            }
            
            .modal-dialog {
                margin: 10px;
            }
            
            .modal-body {
                padding: 20px;
                max-height: 60vh;
            }
            
            .gallery-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .catalogo-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .catalogo-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 576px) {
            .navbar-brand-dashboard {
                transform: scale(1.4);
            }
            
            .catalogo-grid {
                grid-template-columns: 1fr;
            }
            
            .card-actions {
                flex-direction: column;
            }
            
            .btn-card {
                width: 100%;
            }
            
            .modal-dialog {
                margin: 5px;
            }
            
            .modal-header {
                padding: 15px 20px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-footer {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
            
            .gallery-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ========== SCROLLBAR PERSONALIZADA ========== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* ========== FIXES PARA SAFARI ========== */
        @supports (-webkit-touch-callout: none) {
            .modal-body {
                -webkit-transform: translateZ(0);
            }
        }

        /* Prevenir zoom no iOS */
        @media (max-width: 768px) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Navbar Dashboard -->
    <nav class="navbar navbar-dashboard">
        <div class="container-fluid">
            <div class="d-flex align-items-center w-100">
                <!-- Logo Grande -->
                <a class="navbar-brand-dashboard" href="profissional-dashboard.html">
                    <img src="logoscanhub.png" alt="ScanHub">
                </a>

                <!-- Botão Menu Mobile -->
                <button class="mobile-menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- User Info -->
                <div class="user-info-mobile ms-auto">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-details d-none d-md-block ms-2">
                        <h5 id="userName">Carregando...</h5>
                        <small>ID: <span id="userId">---</span></small>
                    </div>
                </div>

                <!-- Botão Logout -->
                <button class="btn btn-outline-danger btn-sm ms-3" id="btnLogout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="d-none d-md-inline">Sair</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Menu Dashboard -->
    <div class="container-fluid">
        <ul class="dashboard-menu" id="dashboardMenu">
            <li>
                <a href="profissional-dashboard.html">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="perfil-profissional.html">
                    <i class="fas fa-user"></i>
                    <span>Perfil</span>
                </a>
            </li>
            <li>
                <a href="meus-clientes.html">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-chart-line"></i>
                    <span>Financeiro</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Agenda</span>
                </a>
            </li>
            <li>
                <a href="catalogo.html" class="active">
                    <i class="fas fa-boxes"></i>
                    <span>Catálogo</span>
                </a>
            </li>
            <li>
                <a href="pedidos.html">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Pedidos</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-crown"></i>
                    <span>Assinatura</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header com Abas -->
        <div class="header-abas">
            <div class="row">
                <div class="col-12 col-md-8">
                    <h4 class="mb-3 mb-md-0">Catálogo</h4>
                    <div class="catalogo-tabs-container" id="catalogoTabs">
                        <button class="tab-btn active" data-tipo="servicos">
                            <i class="fas fa-tools"></i>
                            <span>Serviços</span>
                            <span class="tab-badge" id="badgeServicos">0</span>
                        </button>
                        <button class="tab-btn" data-tipo="produtos">
                            <i class="fas fa-box"></i>
                            <span>Produtos</span>
                            <span class="tab-badge" id="badgeProdutos">0</span>
                        </button>
                        <button class="tab-btn" data-tipo="todos">
                            <i class="fas fa-list"></i>
                            <span>Todos</span>
                            <span class="tab-badge" id="badgeTodos">0</span>
                        </button>
                    </div>
                </div>
                <div class="col-12 col-md-4 mt-3 mt-md-0">
                    <div class="dropdown">
                        <button class="btn btn-primary-action dropdown-toggle w-100" type="button" 
                                id="btnNovoItemDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-plus"></i> Novo Item
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end w-100">
                            <li>
                                <a class="dropdown-item" href="#" onclick="abrirModalItem('servico')">
                                    <i class="fas fa-tools text-primary me-2"></i>
                                    Novo Serviço
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="abrirModalItem('produto')">
                                    <i class="fas fa-box text-success me-2"></i>
                                    Novo Produto
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Filtros Rápidos -->
            <div class="row g-3 mt-3">
                <div class="col-md-6">
                    <div class="search-box">
                        <i class="fas fa-search position-absolute" style="left: 15px; top: 50%; transform: translateY(-50%); z-index: 10; color: #999;"></i>
                        <input type="text" class="form-control ps-4" id="searchCatalogo" 
                               placeholder="Buscar por nome, descrição, categoria...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterCategoria">
                        <option value="">Todas categorias</option>
                        <!-- Categorias serão carregadas -->
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterStatus">
                        <option value="">Todos status</option>
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                        <option value="esgotado">Esgotado</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Stats Rápidos -->
        <div class="row mb-4">
            <div class="col-md-3 col-6">
                <div class="stat-card">
                    <i class="fas fa-tools"></i>
                    <h3 id="totalServicos">0</h3>
                    <p>Serviços Ativos</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-card">
                    <i class="fas fa-box"></i>
                    <h3 id="totalProdutos">0</h3>
                    <p>Produtos em Estoque</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-card">
                    <i class="fas fa-dollar-sign"></i>
                    <h3 id="valorEstoque">R$ 0</h3>
                    <p>Valor do Estoque</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-card">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3 id="baixoEstoque">0</h3>
                    <p>Baixo Estoque</p>
                </div>
            </div>
        </div>

        <!-- Grid do Catálogo -->
        <div class="catalogo-grid" id="catalogoGrid">
            <!-- Itens serão carregados aqui -->
            <div class="empty-state">
                <i class="fas fa-boxes"></i>
                <h4>Seu catálogo está vazio</h4>
                <p class="text-muted">Comece adicionando seu primeiro serviço ou produto</p>
                <button class="btn btn-primary-action mt-3" onclick="abrirModalItem('servico')">
                    <i class="fas fa-plus me-2"></i>Adicionar Primeiro Item
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro/Edição Item -->
    <div class="modal fade" id="modalItem" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Novo Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Tipo de Item (visível apenas em novo) -->
                    <div class="row mb-4" id="seletorTipoItem">
                        <div class="col-12">
                            <label class="form-label">Tipo de Item *</label>
                            <div class="d-flex gap-3">
                                <button type="button" class="btn btn-outline-primary flex-fill tipo-item-btn active" data-tipo="servico">
                                    <i class="fas fa-tools me-2"></i>Serviço
                                </button>
                                <button type="button" class="btn btn-outline-success flex-fill tipo-item-btn" data-tipo="produto">
                                    <i class="fas fa-box me-2"></i>Produto
                                </button>
                            </div>
                        </div>
                    </div>

                    <form id="formItem">
                        <input type="hidden" id="itemId">
                        <input type="hidden" id="tipoItem" value="servico">
                        
                        <!-- Abas Público/Privado -->
                        <div class="modal-tabs" id="modalTabs">
                            <button type="button" class="modal-tab-btn active" data-tab="publico">
                                <i class="fas fa-eye me-2"></i>Informações Públicas
                            </button>
                            <button type="button" class="modal-tab-btn" data-tab="privado">
                                <i class="fas fa-lock me-2"></i>Informações Privadas
                            </button>
                        </div>

                        <!-- Conteúdo das Abas -->
                        <div class="tab-content">
                            <!-- ABA PÚBLICA -->
                            <div class="tab-pane active" id="tabPublico">
                                <!-- Informações Gerais -->
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <label class="form-label">Nome do Item *</label>
                                        <input type="text" class="form-control" id="nomePublico" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Status *</label>
                                        <select class="form-select" id="statusPublico" required>
                                            <option value="ativo">Ativo</option>
                                            <option value="inativo">Inativo</option>
                                            <option value="esgotado">Esgotado</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Descrição -->
                                <div class="mb-3">
                                    <label class="form-label">Descrição Detalhada *</label>
                                    <textarea class="form-control" id="descricaoPublico" rows="3" required></textarea>
                                </div>

                                <!-- Categoria -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Categoria *</label>
                                        <select class="form-select" id="categoriaPublico" required>
                                            <!-- Categorias serão carregadas -->
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Tags</label>
                                        <div class="tags-container" id="tagsPublicoContainer">
                                            <input type="text" class="tags-input" id="tagPublicoInput" 
                                                   placeholder="Digite e pressione Enter" style="border: none; outline: none; flex: 1; min-width: 100px;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Preço (Público) -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label">Preço de Venda *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" class="form-control" id="precoVenda" 
                                                   min="0" step="0.01" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Unidade de Medida</label>
                                        <select class="form-select" id="unidadeMedida">
                                            <option value="unidade">Unidade</option>
                                            <option value="metro">Metro</option>
                                            <option value="metro_quadrado">m²</option>
                                            <option value="hora">Hora</option>
                                            <option value="servico">Serviço</option>
                                            <option value="pacote">Pacote</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Garantia</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="garantiaDias" 
                                                   min="0" value="90">
                                            <span class="input-group-text">dias</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Imagens (Público) -->
                                <div class="mb-4">
                                    <label class="form-label">Imagens do Item (Máx. 5)</label>
                                    <p class="text-muted small">Essas imagens serão vistas pelos clientes</p>
                                    
                                    <div class="upload-area" id="uploadAreaPublico">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <h5>Arraste e solte suas imagens aqui</h5>
                                        <p class="text-muted">ou clique para selecionar (JPEG, PNG)</p>
                                        <input type="file" id="fotosPublicoInput" accept="image/*" multiple style="display: none;">
                                    </div>
                                    
                                    <div class="gallery-grid" id="galleryPublico">
                                        <!-- Imagens serão adicionadas aqui -->
                                    </div>
                                </div>

                                <!-- Campos específicos para Produto (Público) -->
                                <div id="camposProdutoPublico" style="display: none;">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Marca</label>
                                            <input type="text" class="form-control" id="marcaProduto">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Modelo</label>
                                            <input type="text" class="form-control" id="modeloProduto">
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Cor</label>
                                            <input type="text" class="form-control" id="corProduto">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Tamanho</label>
                                            <input type="text" class="form-control" id="tamanhoProduto">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Peso (kg)</label>
                                            <input type="number" class="form-control" id="pesoProduto" step="0.01">
                                        </div>
                                    </div>
                                </div>

                                <!-- Campos específicos para Serviço (Público) -->
                                <div id="camposServicoPublico">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Duração Estimada</label>
                                            <input type="text" class="form-control" id="duracaoServico" 
                                                   placeholder="Ex: 2 horas, 1 dia completo">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Tipo de Serviço</label>
                                            <select class="form-select" id="tipoServico">
                                                <option value="presencial">Presencial</option>
                                                <option value="remoto">Remoto</option>
                                                <option value="ambos">Ambos</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ABA PRIVADA -->
                            <div class="tab-pane" id="tabPrivado">
                                <div class="alert alert-warning">
                                    <i class="fas fa-lock me-2"></i>
                                    Estas informações são visíveis apenas para você (profissional)
                                </div>

                                <!-- Informações Financeiras (Privado) -->
                                <div class="financeiro-container">
                                    <h6><i class="fas fa-chart-line me-2"></i>Informações Financeiras</h6>
                                    
                                    <div class="financeiro-item">
                                        <span>Preço de Custo:</span>
                                        <span class="financeiro-valor financeiro-custo" id="displayCusto">R$ 0,00</span>
                                    </div>
                                    
                                    <div class="financeiro-item">
                                        <span>Preço de Venda:</span>
                                        <span class="financeiro-valor" id="displayVenda">R$ 0,00</span>
                                    </div>
                                    
                                    <div class="financeiro-item">
                                        <span>Margem de Lucro:</span>
                                        <span class="financeiro-valor financeiro-lucro" id="displayMargem">0%</span>
                                    </div>
                                    
                                    <div class="financeiro-item">
                                        <span>Lucro por Unidade:</span>
                                        <span class="financeiro-valor financeiro-lucro" id="displayLucro">R$ 0,00</span>
                                    </div>
                                </div>

                                <!-- Campos Privados para Produto -->
                                <div id="camposProdutoPrivado" style="display: none;">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Código/SKU *</label>
                                            <input type="text" class="form-control" id="codigoSKU" 
                                                   placeholder="Ex: PROD-001">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Código de Barras</label>
                                            <input type="text" class="form-control" id="codigoBarras">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Preço de Custo *</label>
                                            <div class="input-group">
                                                <span class="input-group-text">R$</span>
                                                <input type="number" class="form-control" id="precoCusto" 
                                                       min="0" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Fornecedor</label>
                                            <input type="text" class="form-control" id="fornecedor" 
                                                   placeholder="Nome do fornecedor">
                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Estoque Atual *</label>
                                            <input type="number" class="form-control" id="estoqueAtual" 
                                                   min="0" step="1" value="0">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Estoque Mínimo</label>
                                            <input type="number" class="form-control" id="estoqueMinimo" 
                                                   min="0" step="1" value="0">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Localização</label>
                                            <input type="text" class="form-control" id="localizacaoEstoque" 
                                                   placeholder="Ex: Prateleira A3">
                                        </div>
                                    </div>

                                    <!-- Impostos e Taxas -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Impostos (%)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="impostos" 
                                                       min="0" max="100" step="0.1" value="0">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Taxa Cartão (%)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="taxaCartao" 
                                                       min="0" max="100" step="0.1" value="0">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Carga Tributária (%)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="cargaTributaria" 
                                                       min="0" max="100" step="0.1" value="0">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Contato do Fornecedor</label>
                                        <textarea class="form-control" id="contatoFornecedor" rows="2" 
                                                  placeholder="Telefone, email, site..."></textarea>
                                    </div>
                                </div>

                                <!-- Campos Privados para Serviço -->
                                <div id="camposServicoPrivado">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Custo por Hora/Material</label>
                                            <div class="input-group">
                                                <span class="input-group-text">R$</span>
                                                <input type="number" class="form-control" id="custoHoraServico" 
                                                       min="0" step="0.01" placeholder="Custo estimado">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Materiais Necessários</label>
                                            <div class="tags-container" id="materiaisServicoContainer">
                                                <input type="text" class="tags-input" id="materialServicoInput" 
                                                       placeholder="Digite material e pressione Enter" style="border: none; outline: none; flex: 1; min-width: 100px;">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Observações Internas</label>
                                        <textarea class="form-control" id="observacoesPrivadas" rows="3" 
                                                  placeholder="Informações internas, detalhes técnicos..."></textarea>
                                    </div>
                                </div>

                                <!-- Histórico (futuro) -->
                                <div class="alert alert-info">
                                    <i class="fas fa-history me-2"></i>
                                    Histórico de preços e alterações será implementado em breve
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-action" id="btnSalvarItem">
                        <i class="fas fa-save me-2"></i>Salvar Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
   <!-- Script Principal -->
<script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        signOut 
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc,
        collection,
        addDoc,
        updateDoc,
        deleteDoc,
        getDocs,
        query,
        where,
        orderBy,
        serverTimestamp,
        getCountFromServer
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAYqWTg2RAr4IbqxRsl58TZGQ9tKnyFK14",
        authDomain: "scanhub-ed512.firebaseapp.com",
        projectId: "scanhub-ed512",
        storageBucket: "scanhub-ed512.firebasestorage.app",
        messagingSenderId: "1083305018831",
        appId: "1:1083305018831:web:f7594d560439c8965c3eba"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ============================================
    // VARIÁVEIS GLOBAIS
    // ============================================
    let currentUser = null;
    let userData = null;
    let servicos = [];
    let produtos = [];
    let tipoAtualCatalogo = 'servicos';
    let fotosPublicas = [];
    let modoEdicao = false;
    let itemEmEdicao = null;
    let tagsPublicas = [];
    let materiaisServico = [];

    // ============== VARIÁVEIS DE LIMITES ==============
    let planoUsuario = 'free';
    let limiteServicos = 5;
    let limiteProdutos = 5;
    let limiteTotalCatalogo = 10;
    let servicosAtuais = 0;
    let produtosAtuais = 0;
    let totalCatalogoAtual = 0;

    // ============================================
    // ELEMENTOS DOM - MODIFICADOS PARA NOVA ESTRUTURA
    // ============================================
    const loadingOverlay = document.getElementById('loadingOverlay');
    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');
    const userId = document.getElementById('userId');
    const btnLogout = document.getElementById('btnLogout');
    const menuToggle = document.getElementById('menuToggle');
    const dashboardMenu = document.getElementById('dashboardMenu');
    
    // ============== NOVO: ELEMENTOS DE LIMITES ==============
    const alertLimiteCatalogo = document.getElementById('alertLimiteCatalogo');
    const limiteTexto = document.getElementById('limiteTexto');
    const btnUpgradeCatalogo = document.getElementById('btnUpgradeCatalogo');
    const statsLimiteServicos = document.getElementById('statsLimiteServicos');
    const statsLimiteProdutos = document.getElementById('statsLimiteProdutos');
    const statsLimiteTotal = document.getElementById('statsLimiteTotal');
    
    // Elementos das abas
    const catalogoTabs = document.getElementById('catalogoTabs');
    const tabButtons = catalogoTabs ? catalogoTabs.querySelectorAll('.tab-btn') : [];
    const badgeServicos = document.getElementById('badgeServicos');
    const badgeProdutos = document.getElementById('badgeProdutos');
    const badgeTodos = document.getElementById('badgeTodos');
    
    // Elementos de filtro
    const searchCatalogo = document.getElementById('searchCatalogo');
    const filterCategoria = document.getElementById('filterCategoria');
    const filterStatus = document.getElementById('filterStatus');
    
    // Elementos de estatísticas
    const totalServicos = document.getElementById('totalServicos');
    const totalProdutos = document.getElementById('totalProdutos');
    const valorEstoque = document.getElementById('valorEstoque');
    const baixoEstoque = document.getElementById('baixoEstoque');
    
    // Grid do catálogo
    const catalogoGrid = document.getElementById('catalogoGrid');
    
    // Modal
    const modalItem = new bootstrap.Modal(document.getElementById('modalItem'));
    const modalTitle = document.getElementById('modalTitle');
    const seletorTipoItem = document.getElementById('seletorTipoItem');
    const tipoItemBtns = document.querySelectorAll('.tipo-item-btn');
    const tipoItemInput = document.getElementById('tipoItem');
    const itemId = document.getElementById('itemId');
    const formItem = document.getElementById('formItem');
    const btnSalvarItem = document.getElementById('btnSalvarItem');
    
    // Abas do modal
    const modalTabs = document.getElementById('modalTabs');
    const modalTabBtns = document.querySelectorAll('.modal-tab-btn');
    
    // Campos gerais
    const nomePublico = document.getElementById('nomePublico');
    const statusPublico = document.getElementById('statusPublico');
    const descricaoPublico = document.getElementById('descricaoPublico');
    const categoriaPublico = document.getElementById('categoriaPublico');
    const precoVenda = document.getElementById('precoVenda');
    const unidadeMedida = document.getElementById('unidadeMedida');
    const garantiaDias = document.getElementById('garantiaDias');
    
    // Campos específicos Produto (Público)
    const camposProdutoPublico = document.getElementById('camposProdutoPublico');
    const marcaProduto = document.getElementById('marcaProduto');
    const modeloProduto = document.getElementById('modeloProduto');
    const corProduto = document.getElementById('corProduto');
    const tamanhoProduto = document.getElementById('tamanhoProduto');
    const pesoProduto = document.getElementById('pesoProduto');
    
    // Campos específicos Serviço (Público)
    const camposServicoPublico = document.getElementById('camposServicoPublico');
    const duracaoServico = document.getElementById('duracaoServico');
    const tipoServico = document.getElementById('tipoServico');
    
    // Campos Privados (Produto)
    const camposProdutoPrivado = document.getElementById('camposProdutoPrivado');
    const codigoSKU = document.getElementById('codigoSKU');
    const codigoBarras = document.getElementById('codigoBarras');
    const precoCusto = document.getElementById('precoCusto');
    const fornecedor = document.getElementById('fornecedor');
    const estoqueAtual = document.getElementById('estoqueAtual');
    const estoqueMinimo = document.getElementById('estoqueMinimo');
    const localizacaoEstoque = document.getElementById('localizacaoEstoque');
    const impostos = document.getElementById('impostos');
    const taxaCartao = document.getElementById('taxaCartao');
    const cargaTributaria = document.getElementById('cargaTributaria');
    const contatoFornecedor = document.getElementById('contatoFornecedor');
    
    // Campos Privados (Serviço)
    const camposServicoPrivado = document.getElementById('camposServicoPrivado');
    const custoHoraServico = document.getElementById('custoHoraServico');
    const observacoesPrivadas = document.getElementById('observacoesPrivadas');
    
    // Tags containers
    const tagsPublicoContainer = document.getElementById('tagsPublicoContainer');
    const tagPublicoInput = document.getElementById('tagPublicoInput');
    const materiaisServicoContainer = document.getElementById('materiaisServicoContainer');
    const materialServicoInput = document.getElementById('materialServicoInput');
    
    // Upload de imagens
    const uploadAreaPublico = document.getElementById('uploadAreaPublico');
    const fotosPublicoInput = document.getElementById('fotosPublicoInput');
    const galleryPublico = document.getElementById('galleryPublico');
    
    // Display financeiro
    const displayCusto = document.getElementById('displayCusto');
    const displayVenda = document.getElementById('displayVenda');
    const displayMargem = document.getElementById('displayMargem');
    const displayLucro = document.getElementById('displayLucro');

    // ============================================
    // FUNÇÕES DE UTILIDADE - MANTIDAS INTACTAS
    // ============================================
    function showLoading() {
        loadingOverlay.style.display = 'flex';
    }

    function hideLoading() {
        loadingOverlay.style.display = 'none';
    }

    function showAlert(mensagem, tipo = 'success') {
        alert(mensagem);
    }

    // ============== NOVAS FUNÇÕES DE LIMITES ==============
    function configurarLimitesPorPlano(plano) {
        const planoNormalizado = plano.toLowerCase().trim();
        
        switch(planoNormalizado) {
            case 'básico':
            case 'basic':
                limiteServicos = 20;
                limiteProdutos = 20;
                limiteTotalCatalogo = 40;
                planoUsuario = 'basic';
                break;
                
            case 'profissional':
            case 'pro':
                limiteServicos = 100;
                limiteProdutos = 100;
                limiteTotalCatalogo = 200;
                planoUsuario = 'pro';
                break;
                
            case 'enterprise':
                limiteServicos = 500;
                limiteProdutos = 500;
                limiteTotalCatalogo = 1000;
                planoUsuario = 'enterprise';
                break;
                
            default: // free
                limiteServicos = 5;
                limiteProdutos = 5;
                limiteTotalCatalogo = 10;
                planoUsuario = 'free';
        }
        
        console.log(`Plano detectado: ${planoNormalizado}`);
        console.log(`Limites: Serviços=${limiteServicos}, Produtos=${limiteProdutos}, Total=${limiteTotalCatalogo}`);
    }

    async function verificarLimitesUsuario() {
        try {
            // Contar serviços
            const servicosQuery = query(
                collection(db, "servicos"),
                where("profissionalId", "==", currentUser.uid)
            );
            const servicosCount = await getCountFromServer(servicosQuery);
            servicosAtuais = servicosCount.data().count;
            
            // Contar produtos
            const produtosQuery = query(
                collection(db, "produtos"),
                where("profissionalId", "==", currentUser.uid)
            );
            const produtosCount = await getCountFromServer(produtosQuery);
            produtosAtuais = produtosCount.data().count;
            
            totalCatalogoAtual = servicosAtuais + produtosAtuais;
            
            // Atualizar interface de limites
            atualizarDisplayLimites();
            
        } catch (error) {
            console.error('Erro ao verificar limites:', error);
            // Em caso de erro, usar valores locais
            servicosAtuais = servicos.length;
            produtosAtuais = produtos.length;
            totalCatalogoAtual = servicosAtuais + produtosAtuais;
        }
    }

    function atualizarDisplayLimites() {
        if (!alertLimiteCatalogo || !limiteTexto) return;
        
        // Verificar se atingiu limite
        let atingiuLimite = false;
        let mensagem = '';
        
        if (planoUsuario !== 'enterprise') {
            const percentualServicos = Math.round((servicosAtuais / limiteServicos) * 100);
            const percentualProdutos = Math.round((produtosAtuais / limiteProdutos) * 100);
            const percentualTotal = Math.round((totalCatalogoAtual / limiteTotalCatalogo) * 100);
            
            // Verificar qual limite está mais crítico
            if (percentualTotal >= 80) {
                atingiuLimite = true;
                mensagem = `Catálogo: ${totalCatalogoAtual}/${limiteTotalCatalogo} itens (${percentualTotal}% usado)`;
            } else if (percentualServicos >= 80) {
                atingiuLimite = true;
                mensagem = `Serviços: ${servicosAtuais}/${limiteServicos} (${percentualServicos}% usado)`;
            } else if (percentualProdutos >= 80) {
                atingiuLimite = true;
                mensagem = `Produtos: ${produtosAtuais}/${limiteProdutos} (${percentualProdutos}% usado)`;
            }
            
            // Atualizar alerta
            if (atingiuLimite && alertLimiteCatalogo) {
                alertLimiteCatalogo.style.display = 'block';
                limiteTexto.textContent = mensagem;
                
                // Colorir alerta baseado na porcentagem
                if (percentualTotal >= 90) {
                    alertLimiteCatalogo.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
                } else {
                    alertLimiteCatalogo.style.background = 'linear-gradient(135deg, #FF6B35 0%, #F7931E 100%)';
                }
            } else if (alertLimiteCatalogo) {
                alertLimiteCatalogo.style.display = 'none';
            }
            
            // Atualizar stats
            if (statsLimiteServicos) {
                statsLimiteServicos.textContent = `${servicosAtuais}/${limiteServicos}`;
                statsLimiteServicos.style.color = percentualServicos >= 80 ? '#e74c3c' : '#27ae60';
            }
            
            if (statsLimiteProdutos) {
                statsLimiteProdutos.textContent = `${produtosAtuais}/${limiteProdutos}`;
                statsLimiteProdutos.style.color = percentualProdutos >= 80 ? '#e74c3c' : '#27ae60';
            }
            
            if (statsLimiteTotal) {
                statsLimiteTotal.textContent = `${totalCatalogoAtual}/${limiteTotalCatalogo}`;
                statsLimiteTotal.style.color = percentualTotal >= 80 ? '#e74c3c' : '#27ae60';
            }
        } else {
            // Enterprise - sem limites visíveis
            if (alertLimiteCatalogo) alertLimiteCatalogo.style.display = 'none';
            if (statsLimiteServicos) statsLimiteServicos.textContent = `${servicosAtuais}/Ilimitado`;
            if (statsLimiteProdutos) statsLimiteProdutos.textContent = `${produtosAtuais}/Ilimitado`;
            if (statsLimiteTotal) statsLimiteTotal.textContent = `${totalCatalogoAtual}/Ilimitado`;
        }
    }

    function verificarPodeAdicionarItem(tipo) {
        if (planoUsuario === 'enterprise') {
            return { podeCriar: true, motivo: '' };
        }
        
        if (tipo === 'servico') {
            if (servicosAtuais >= limiteServicos) {
                return {
                    podeCriar: false,
                    motivo: `❌ LIMITE DE SERVIÇOS ATINGIDO!\n\nPlano: ${planoUsuario.toUpperCase()}\nLimite: ${limiteServicos} serviços\nAtuais: ${servicosAtuais}\n\nFaça upgrade para adicionar mais serviços.`
                };
            }
        } else if (tipo === 'produto') {
            if (produtosAtuais >= limiteProdutos) {
                return {
                    podeCriar: false,
                    motivo: `❌ LIMITE DE PRODUTOS ATINGIDO!\n\nPlano: ${planoUsuario.toUpperCase()}\nLimite: ${limiteProdutos} produtos\nAtuais: ${produtosAtuais}\n\nFaça upgrade para adicionar mais produtos.`
                };
            }
        }
        
        if (totalCatalogoAtual >= limiteTotalCatalogo) {
            return {
                podeCriar: false,
                motivo: `❌ LIMITE TOTAL DO CATÁLOGO ATINGIDO!\n\nPlano: ${planoUsuario.toUpperCase()}\nLimite: ${limiteTotalCatalogo} itens\nAtuais: ${totalCatalogoAtual}\n\nFaça upgrade para adicionar mais itens.`
            };
        }
        
        return { podeCriar: true, motivo: '' };
    }

    // Upload Imgur - MESMO CÓDIGO DO PERFIL
    async function uploadParaImgur(arquivo) {
        showLoading();
        
        try {
            const base64 = await converterParaBase64(arquivo);
            const CLIENT_ID = '546c25a59c58ad7';
            const formData = new FormData();
            formData.append('image', base64.split(',')[1]);
            formData.append('type', 'base64');
            
            const resposta = await fetch('https://api.imgur.com/3/image', {
                method: 'POST',
                headers: {
                    'Authorization': `Client-ID ${CLIENT_ID}`
                },
                body: formData
            });
            
            if (!resposta.ok) {
                throw new Error('Erro do Imgur');
            }
            
            const dados = await resposta.json();
            
            if (!dados.success) {
                throw new Error('Erro no upload');
            }
            
            return dados.data.link;
            
        } catch (erro) {
            throw new Error('Falha ao enviar imagem');
        } finally {
            hideLoading();
        }
    }

    function converterParaBase64(arquivo) {
        return new Promise((resolve, reject) => {
            const leitor = new FileReader();
            leitor.onload = (e) => resolve(e.target.result);
            leitor.onerror = reject;
            leitor.readAsDataURL(arquivo);
        });
    }

    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(valor || 0);
    }

    function calcularMargem(custo, venda) {
        if (!custo || !venda || custo <= 0 || venda <= 0) return 0;
        const margem = ((venda - custo) / custo) * 100;
        return Math.round(margem * 100) / 100;
    }

    function calcularLucro(custo, venda) {
        if (!custo || !venda) return 0;
        return venda - custo;
    }

    function formatarData(data) {
        if (!data) return '--';
        try {
            const date = data.toDate ? data.toDate() : new Date(data);
            if (isNaN(date.getTime())) return '--';
            return date.toLocaleDateString('pt-BR');
        } catch {
            return '--';
        }
    }

    // ============================================
    // INICIALIZAÇÃO DO SISTEMA - COM LIMITES
    // ============================================
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            try {
                showLoading();
                const userRef = doc(db, "usuarios", user.uid);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    atualizarInterfaceUsuario(userData);
                    
                    // ============== CONFIGURAR LIMITES ==============
                    if (userData.plano_assinatura) {
                        configurarLimitesPorPlano(userData.plano_assinatura);
                    } else {
                        configurarLimitesPorPlano('free');
                    }
                    
                    await carregarCatalogo();
                    await verificarLimitesUsuario(); // Verificar limites reais
                    carregarCategorias(); 
                    inicializarSistema();
                }
            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao carregar dados do usuário', 'error');
            } finally {
                hideLoading();
            }
        } else {
            window.location.href = 'login.html';
        }
    });

    function atualizarInterfaceUsuario(data) {
        if (data.apelido) {
            userName.textContent = `Olá, ${data.apelido}`;
            userAvatar.textContent = data.apelido.charAt(0).toUpperCase();
        }
        
        if (data.idScanHub) {
            userId.textContent = data.idScanHub;
        }
    }

    function inicializarSistema() {
        // Inicializar abas
        if (tabButtons.length > 0) inicializarAbasCatalogo();
        
        // Inicializar seletor de tipo no modal
        if (tipoItemBtns.length > 0) inicializarSeletorTipo();
        
        // Inicializar abas do modal (público/privado)
        if (modalTabBtns.length > 0) inicializarAbasModal();
        
        // Inicializar eventos
        inicializarEventListeners();
        
        // Inicializar tags system
        inicializarTagsSystem();
        
        // Botão upgrade
        if (btnUpgradeCatalogo) {
            btnUpgradeCatalogo.addEventListener('click', () => {
                window.location.href = 'assinatura.html';
            });
        }
    }

    // ============================================
    // CARREGAMENTO DE DADOS - MANTIDO INTACTO
    // ============================================
    async function carregarCatalogo() {
        await carregarServicos();
        await carregarProdutos();
        atualizarContadores();
        atualizarGridCatalogo();
    }

    async function carregarServicos() {
        try {
            const q = query(
                collection(db, "servicos"),
                where("profissionalId", "==", currentUser.uid)
            );
            
            const querySnapshot = await getDocs(q);
            servicos = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                servicos.push({
                    id: doc.id,
                    ...data,
                    criadoEm: data.criadoEm || null,
                    atualizadoEm: data.atualizadoEm || null
                });
            });
            
            // Ordenar por data de criação (mais recente primeiro)
            servicos.sort((a, b) => {
                const dateA = a.criadoEm ? (a.criadoEm.toDate ? a.criadoEm.toDate() : new Date(a.criadoEm)) : new Date(0);
                const dateB = b.criadoEm ? (b.criadoEm.toDate ? b.criadoEm.toDate() : new Date(b.criadoEm)) : new Date(0);
                return dateB - dateA;
            });
            
        } catch (error) {
            console.error('Erro ao carregar serviços:', error);
            showAlert('Erro ao carregar serviços', 'error');
        }
    }

    async function carregarProdutos() {
        try {
            const q = query(
                collection(db, "produtos"),
                where("profissionalId", "==", currentUser.uid)
            );
            
            const querySnapshot = await getDocs(q);
            produtos = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                produtos.push({
                    id: doc.id,
                    ...data,
                    criadoEm: data.criadoEm || null,
                    atualizadoEm: data.atualizadoEm || null
                });
            });
            
            // Ordenar por data de criação (mais recente primeiro)
            produtos.sort((a, b) => {
                const dateA = a.criadoEm ? (a.criadoEm.toDate ? a.criadoEm.toDate() : new Date(a.criadoEm)) : new Date(0);
                const dateB = b.criadoEm ? (b.criadoEm.toDate ? b.criadoEm.toDate() : new Date(b.criadoEm)) : new Date(0);
                return dateB - dateA;
            });
            
        } catch (error) {
            console.error('Erro ao carregar produtos:', error);
            showAlert('Erro ao carregar produtos', 'error');
        }
    }

    function carregarCategorias() {
        // Categorias padrão do sistema
        const categoriasPadrao = [
            // Serviços
            'Reparo de Celulares',
            'Manutenção de Computadores',
            'Instalação Elétrica',
            'Encanamento',
            'Pintura',
            'Construção Civil',
            'Consultoria Técnica',
            'Design Gráfico',
            'Desenvolvimento Web',
            'Marketing Digital',
            'Limpeza',
            'Organização',
            'Transporte',
            'Entregas',
            'Aulas Particulares',
            'Personal Trainer',
            'Beleza',
            'Cuidados Pessoais',
            
            // Produtos
            'Eletrônicos',
            'Informática',
            'Celulares & Tablets',
            'Acessórios',
            'Eletrodomésticos',
            'Móveis',
            'Decoração',
            'Ferramentas',
            'Materiais de Construção',
            'Automotivo',
            'Beleza & Saúde',
            'Moda',
            'Calçados',
            'Esportes',
            'Brinquedos',
            'Alimentos',
            'Bebidas',
            'Livros',
            'Papelaria',
            'Outros'
        ];

        // Limpar selects
        if (filterCategoria) {
            filterCategoria.innerHTML = '<option value="">Todas categorias</option>';
        }
        
        if (categoriaPublico) {
            categoriaPublico.innerHTML = '<option value="">Selecione uma categoria</option>';
        }
        
        // Adicionar categorias padrão
        categoriasPadrao.forEach(categoria => {
            if (filterCategoria) {
                const option1 = document.createElement('option');
                option1.value = categoria;
                option1.textContent = categoria;
                filterCategoria.appendChild(option1);
            }
            
            if (categoriaPublico) {
                const option2 = document.createElement('option');
                option2.value = categoria;
                option2.textContent = categoria;
                categoriaPublico.appendChild(option2);
            }
        });
        
        // Adicionar opção para criar nova categoria
        if (categoriaPublico) {
            const novaCategoriaOption = document.createElement('option');
            novaCategoriaOption.value = 'nova_categoria';
            novaCategoriaOption.textContent = '+ Adicionar nova categoria';
            categoriaPublico.appendChild(novaCategoriaOption);
            
            // Evento para nova categoria
            categoriaPublico.addEventListener('change', function() {
                if (this.value === 'nova_categoria') {
                    const novaCategoria = prompt('Digite o nome da nova categoria:');
                    if (novaCategoria && novaCategoria.trim()) {
                        // Adicionar ao select
                        const option = document.createElement('option');
                        option.value = novaCategoria.trim();
                        option.textContent = novaCategoria.trim();
                        option.selected = true;
                        
                        // Inserir antes da opção "nova_categoria"
                        categoriaPublico.insertBefore(option, novaCategoriaOption);
                        
                        // Adicionar ao filtro também
                        if (filterCategoria) {
                            const filterOption = document.createElement('option');
                            filterOption.value = novaCategoria.trim();
                            filterOption.textContent = novaCategoria.trim();
                            filterCategoria.appendChild(filterOption);
                        }
                    } else {
                        this.value = '';
                    }
                }
            });
        }
    }

    // ============================================
    // SISTEMA DE ABAS - MANTIDO INTACTO
    // ============================================
    function inicializarAbasCatalogo() {
        tabButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                tabButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                tipoAtualCatalogo = this.getAttribute('data-tipo');
                atualizarGridCatalogo();
            });
        });
    }

    function inicializarAbasModal() {
        modalTabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                modalTabBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const tab = this.getAttribute('data-tab');
                
                // Mostrar conteúdo da aba selecionada
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });
                document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            });
        });
    }

    function inicializarSeletorTipo() {
        tipoItemBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                tipoItemBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const novoTipo = this.getAttribute('data-tipo');
                tipoItemInput.value = novoTipo;
                alternarCamposPorTipo(novoTipo);
            });
        });
    }

    function alternarCamposPorTipo(tipo) {
        if (tipo === 'servico') {
            camposServicoPublico.style.display = 'block';
            camposProdutoPublico.style.display = 'none';
            camposServicoPrivado.style.display = 'block';
            camposProdutoPrivado.style.display = 'none';
            
            // Habilitar/desabilitar campos obrigatórios
            if (codigoSKU) codigoSKU.required = false;
            if (precoCusto) precoCusto.required = false;
            if (estoqueAtual) estoqueAtual.required = false;
            
            // Habilitar campos de serviço
            if (duracaoServico) duracaoServico.required = true;
            
        } else if (tipo === 'produto') {
            camposServicoPublico.style.display = 'none';
            camposProdutoPublico.style.display = 'block';
            camposServicoPrivado.style.display = 'none';
            camposProdutoPrivado.style.display = 'block';
            
            // Habilitar/desabilitar campos obrigatórios
            if (codigoSKU) codigoSKU.required = true;
            if (precoCusto) precoCusto.required = true;
            if (estoqueAtual) estoqueAtual.required = true;
            
            // Desabilitar campos de serviço
            if (duracaoServico) duracaoServico.required = false;
        }
        
        // Recalcular margem se houver valores
        atualizarDisplayFinanceiro();
    }

    // ============================================
    // TAGS SYSTEM - MANTIDO INTACTO
    // ============================================
    function inicializarTagsSystem() {
        // Tags públicas
        if (tagPublicoInput) {
            tagPublicoInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && tagPublicoInput.value.trim()) {
                    e.preventDefault();
                    adicionarTagPublica(tagPublicoInput.value.trim());
                    tagPublicoInput.value = '';
                }
            });
        }
        
        // Materiais do serviço
        if (materialServicoInput) {
            materialServicoInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && materialServicoInput.value.trim()) {
                    e.preventDefault();
                    adicionarMaterialServico(materialServicoInput.value.trim());
                    materialServicoInput.value = '';
                }
            });
        }
    }

    function adicionarTagPublica(texto) {
        if (!texto.trim()) return;
        
        tagsPublicas.push(texto.trim());
        
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.innerHTML = `
            ${texto}
            <span class="tag-remove" onclick="removerTagPublica('${texto}', this)">×</span>
        `;
        
        if (tagsPublicoContainer) {
            tagsPublicoContainer.insertBefore(tag, tagPublicoInput);
        }
    }

    function adicionarMaterialServico(texto) {
        if (!texto.trim()) return;
        
        materiaisServico.push(texto.trim());
        
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.innerHTML = `
            ${texto}
            <span class="tag-remove" onclick="removerMaterialServico('${texto}', this)">×</span>
        `;
        
        if (materiaisServicoContainer) {
            materiaisServicoContainer.insertBefore(tag, materialServicoInput);
        }
    }

    // Funções globais para remover tags
    window.removerTagPublica = function(texto, elemento) {
        tagsPublicas = tagsPublicas.filter(tag => tag !== texto);
        if (elemento && elemento.parentElement) {
            elemento.parentElement.remove();
        }
    };

    window.removerMaterialServico = function(texto, elemento) {
        materiaisServico = materiaisServico.filter(material => material !== texto);
        if (elemento && elemento.parentElement) {
            elemento.parentElement.remove();
        }
    };

    // ============================================
    // UPLOAD DE IMAGENS - MANTIDO INTACTO
    // ============================================
    if (uploadAreaPublico) {
        uploadAreaPublico.addEventListener('click', () => {
            if (fotosPublicoInput) {
                fotosPublicoInput.click();
            }
        });
    }

    if (fotosPublicoInput) {
        fotosPublicoInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            
            if (fotosPublicas.length + files.length > 5) {
                showAlert('Máximo de 5 fotos por item', 'error');
                return;
            }
            
            for (const file of files) {
                try {
                    showLoading();
                    const imageUrl = await uploadParaImgur(file);
                    fotosPublicas.push(imageUrl);
                    adicionarFotoGaleria(imageUrl);
                } catch (erro) {
                    console.error('Erro no upload:', erro);
                    showAlert('Erro ao enviar foto', 'error');
                } finally {
                    hideLoading();
                }
            }
        });
    }

    function adicionarFotoGaleria(url) {
        if (!galleryPublico) return;
        
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.innerHTML = `
            <img src="${url}" alt="Foto do item">
            <div class="gallery-item-remove" onclick="removerFotoCatalogo('${url}', this)">
                <i class="fas fa-times"></i>
            </div>
        `;
        galleryPublico.appendChild(item);
    }

    window.removerFotoCatalogo = function(url, element) {
        if (confirm('Remover esta foto?')) {
            fotosPublicas = fotosPublicas.filter(foto => foto !== url);
            if (element && element.parentElement) {
                element.parentElement.remove();
            }
        }
    };

    // ============================================
    // DISPLAY FINANCEIRO - MANTIDO INTACTO
    // ============================================
    function atualizarDisplayFinanceiro() {
        if (!displayCusto || !displayVenda || !displayMargem || !displayLucro) return;
        
        const custo = precoCusto ? parseFloat(precoCusto.value) || 0 : 0;
        const venda = precoVenda ? parseFloat(precoVenda.value) || 0 : 0;
        const margem = calcularMargem(custo, venda);
        const lucro = calcularLucro(custo, venda);
        
        displayCusto.textContent = formatarMoeda(custo);
        displayVenda.textContent = formatarMoeda(venda);
        displayMargem.textContent = `${margem}%`;
        displayLucro.textContent = formatarMoeda(lucro);
        
        // Colorir margem
        if (displayMargem.style) {
            if (margem > 30) {
                displayMargem.style.color = '#27ae60';
            } else if (margem > 15) {
                displayMargem.style.color = '#f39c12';
            } else if (margem > 0) {
                displayMargem.style.color = '#e74c3c';
            } else {
                displayMargem.style.color = '#95a5a6';
            }
        }
    }

    // Eventos para atualizar display financeiro
    if (precoCusto) {
        precoCusto.addEventListener('input', atualizarDisplayFinanceiro);
    }
    
    if (precoVenda) {
        precoVenda.addEventListener('input', atualizarDisplayFinanceiro);
    }

    // ============================================
    // CRUD - CREATE, READ, UPDATE, DELETE
    // COM VERIFICAÇÃO DE LIMITES
    // ============================================
    window.abrirModalItem = function(tipo = 'servico', itemId = null) {
        // ============== VERIFICAÇÃO DE LIMITES ==============
        if (!itemId) { // Só verifica limite se for criar novo
            const verificacaoLimite = verificarPodeAdicionarItem(tipo);
            if (!verificacaoLimite.podeCriar) {
                showAlert(verificacaoLimite.motivo, 'error');
                return;
            }
        }
        
        resetarModal();
        
        if (itemId) {
            // Modo edição
            modoEdicao = true;
            const item = tipo === 'servico' 
                ? servicos.find(s => s.id === itemId)
                : produtos.find(p => p.id === itemId);
            
            if (!item) {
                showAlert('Item não encontrado', 'error');
                return;
            }
            
            itemEmEdicao = item;
            preencherModal(item);
            modalTitle.textContent = `Editar ${tipo === 'servico' ? 'Serviço' : 'Produto'}`;
            if (seletorTipoItem) seletorTipoItem.style.display = 'none'; // Não mudar tipo na edição
        } else {
            // Modo criação
            modoEdicao = false;
            modalTitle.textContent = `Novo ${tipo === 'servico' ? 'Serviço' : 'Produto'}`;
            if (seletorTipoItem) seletorTipoItem.style.display = 'block';
            
            // Ativar botão do tipo selecionado
            tipoItemBtns.forEach(btn => btn.classList.remove('active'));
            const btnAtivo = document.querySelector(`.tipo-item-btn[data-tipo="${tipo}"]`);
            if (btnAtivo) btnAtivo.classList.add('active');
            if (tipoItemInput) tipoItemInput.value = tipo;
            
            alternarCamposPorTipo(tipo);
        }
        
        if (modalItem) {
            modalItem.show();
        }
    };

    function resetarModal() {
        // Resetar formulário
        if (formItem) formItem.reset();
        if (itemId) itemId.value = '';
        
        // Resetar arrays
        fotosPublicas = [];
        tagsPublicas = [];
        materiaisServico = [];
        
        // Limpar galeria
        if (galleryPublico) galleryPublico.innerHTML = '';
        
        // Limpar tags containers
        if (tagsPublicoContainer) {
            const tags = tagsPublicoContainer.querySelectorAll('.tag');
            tags.forEach(tag => tag.remove());
        }
        
        if (materiaisServicoContainer) {
            const tags = materiaisServicoContainer.querySelectorAll('.tag');
            tags.forEach(tag => tag.remove());
        }
        
        // Resetar abas
        if (modalTabBtns && modalTabBtns.length > 0) {
            modalTabBtns.forEach(btn => btn.classList.remove('active'));
            modalTabBtns[0].classList.add('active');
            
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            const tabPublico = document.getElementById('tabPublico');
            if (tabPublico) tabPublico.classList.add('active');
        }
        
        // Data padrão
        const hoje = new Date().toISOString().split('T')[0];
        
        // Resetar display financeiro
        setTimeout(atualizarDisplayFinanceiro, 100);
    }

    function preencherModal(item) {
        if (!item) return;
        
        if (itemId) itemId.value = item.id;
        if (tipoItemInput) tipoItemInput.value = item.tipo || 'servico';
        
        // Preencher dados públicos
        if (nomePublico) nomePublico.value = item.nome || '';
        if (statusPublico) statusPublico.value = item.status || 'ativo';
        if (descricaoPublico) descricaoPublico.value = item.descricao || '';
        if (categoriaPublico) categoriaPublico.value = item.categoria || '';
        if (precoVenda) precoVenda.value = item.precoVenda || 0;
        if (unidadeMedida) unidadeMedida.value = item.unidadeMedida || 'unidade';
        if (garantiaDias) garantiaDias.value = item.garantiaDias || 90;
        
        // Preencher tags
        if (item.tags && Array.isArray(item.tags)) {
            item.tags.forEach(tag => {
                adicionarTagPublica(tag);
            });
        }
        
        // Preencher imagens
        if (item.imagens && Array.isArray(item.imagens)) {
            fotosPublicas = item.imagens;
            item.imagens.forEach(img => adicionarFotoGaleria(img));
        }
        
        // Alternar campos por tipo
        const tipo = item.tipo || (item.codigoSKU ? 'produto' : 'servico');
        alternarCamposPorTipo(tipo);
        
        if (tipo === 'produto') {
            // É produto
            if (marcaProduto) marcaProduto.value = item.marca || '';
            if (modeloProduto) modeloProduto.value = item.modelo || '';
            if (corProduto) corProduto.value = item.cor || '';
            if (tamanhoProduto) tamanhoProduto.value = item.tamanho || '';
            if (pesoProduto) pesoProduto.value = item.peso || '';
            
            // Dados privados
            if (codigoSKU) codigoSKU.value = item.codigoSKU || '';
            if (codigoBarras) codigoBarras.value = item.codigoBarras || '';
            if (precoCusto) precoCusto.value = item.precoCusto || 0;
            if (fornecedor) fornecedor.value = item.fornecedor || '';
            if (estoqueAtual) estoqueAtual.value = item.estoqueAtual || 0;
            if (estoqueMinimo) estoqueMinimo.value = item.estoqueMinimo || 0;
            if (localizacaoEstoque) localizacaoEstoque.value = item.localizacaoEstoque || '';
            if (impostos) impostos.value = item.impostos || 0;
            if (taxaCartao) taxaCartao.value = item.taxaCartao || 0;
            if (cargaTributaria) cargaTributaria.value = item.cargaTributaria || 0;
            if (contatoFornecedor) contatoFornecedor.value = item.contatoFornecedor || '';
            
        } else {
            // É serviço
            if (duracaoServico) duracaoServico.value = item.duracao || '';
            if (tipoServico) tipoServico.value = item.tipoServico || 'presencial';
            if (custoHoraServico) custoHoraServico.value = item.custoHora || 0;
            if (observacoesPrivadas) observacoesPrivadas.value = item.observacoesPrivadas || '';
            
            // Preencher materiais
            if (item.materiais && Array.isArray(item.materiais)) {
                item.materiais.forEach(material => {
                    adicionarMaterialServico(material);
                });
            }
        }
        
        atualizarDisplayFinanceiro();
    }

    async function salvarItem() {
        // Validação básica
        if (!nomePublico || !nomePublico.value.trim()) {
            showAlert('Informe o nome do item', 'error');
            if (nomePublico) nomePublico.focus();
            return;
        }
        
        if (!categoriaPublico || !categoriaPublico.value || categoriaPublico.value === 'nova_categoria') {
            showAlert('Selecione uma categoria válida', 'error');
            if (categoriaPublico) categoriaPublico.focus();
            return;
        }
        
        if (!precoVenda || !precoVenda.value || precoVenda.value <= 0) {
            showAlert('Informe um preço de venda válido', 'error');
            if (precoVenda) precoVenda.focus();
            return;
        }
        
        const tipo = tipoItemInput ? tipoItemInput.value : 'servico';
        
        // Validações específicas para produto
        if (tipo === 'produto') {
            if (!codigoSKU || !codigoSKU.value.trim()) {
                showAlert('Informe o código/SKU do produto', 'error');
                if (codigoSKU) codigoSKU.focus();
                return;
            }
            
            if (!precoCusto || precoCusto.value === '' || precoCusto.value < 0) {
                showAlert('Informe o preço de custo', 'error');
                if (precoCusto) precoCusto.focus();
                return;
            }
            
            if (!estoqueAtual || estoqueAtual.value === '' || estoqueAtual.value < 0) {
                showAlert('Informe o estoque atual', 'error');
                if (estoqueAtual) estoqueAtual.focus();
                return;
            }
        }
        
        try {
            showLoading();
            if (btnSalvarItem) {
                btnSalvarItem.disabled = true;
                btnSalvarItem.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
            }
            
            // Preparar dados públicos
            const dadosPublicos = {
                nome: nomePublico ? nomePublico.value.trim() : '',
                descricao: descricaoPublico ? descricaoPublico.value.trim() : '',
                categoria: categoriaPublico ? categoriaPublico.value : '',
                precoVenda: precoVenda ? parseFloat(precoVenda.value) : 0,
                unidadeMedida: unidadeMedida ? unidadeMedida.value : 'unidade',
                garantiaDias: garantiaDias ? parseInt(garantiaDias.value) || null : null,
                status: statusPublico ? statusPublico.value : 'ativo',
                tags: tagsPublicas,
                imagens: fotosPublicas,
                profissionalId: currentUser.uid,
                profissionalNome: userData?.nomeCompleto || userData?.apelido || 'Profissional',
                tipo: tipo,
                atualizadoEm: serverTimestamp()
            };
            
            // Adicionar campos específicos
            if (tipo === 'produto') {
                dadosPublicos.marca = marcaProduto ? marcaProduto.value.trim() || null : null;
                dadosPublicos.modelo = modeloProduto ? modeloProduto.value.trim() || null : null;
                dadosPublicos.cor = corProduto ? corProduto.value.trim() || null : null;
                dadosPublicos.tamanho = tamanhoProduto ? tamanhoProduto.value.trim() || null : null;
                dadosPublicos.peso = pesoProduto ? (parseFloat(pesoProduto.value) || null) : null;
            } else {
                dadosPublicos.duracao = duracaoServico ? duracaoServico.value.trim() || null : null;
                dadosPublicos.tipoServico = tipoServico ? tipoServico.value : 'presencial';
            }
            
            // Preparar dados privados
            const dadosPrivados = {};
            
            if (tipo === 'produto') {
                dadosPrivados.codigoSKU = codigoSKU ? codigoSKU.value.trim() : '';
                dadosPrivados.codigoBarras = codigoBarras ? codigoBarras.value.trim() || null : null;
                dadosPrivados.precoCusto = precoCusto ? parseFloat(precoCusto.value) || 0 : 0;
                dadosPrivados.fornecedor = fornecedor ? fornecedor.value.trim() || null : null;
                dadosPrivados.contatoFornecedor = contatoFornecedor ? contatoFornecedor.value.trim() || null : null;
                dadosPrivados.estoqueAtual = estoqueAtual ? parseInt(estoqueAtual.value) || 0 : 0;
                dadosPrivados.estoqueMinimo = estoqueMinimo ? parseInt(estoqueMinimo.value) || 0 : 0;
                dadosPrivados.localizacaoEstoque = localizacaoEstoque ? localizacaoEstoque.value.trim() || null : null;
                dadosPrivados.impostos = impostos ? parseFloat(impostos.value) || 0 : 0;
                dadosPrivados.taxaCartao = taxaCartao ? parseFloat(taxaCartao.value) || 0 : 0;
                dadosPrivados.cargaTributaria = cargaTributaria ? parseFloat(cargaTributaria.value) || 0 : 0;
                
                // Calcular margem e lucro
                const margem = calcularMargem(dadosPrivados.precoCusto, dadosPublicos.precoVenda);
                const lucro = calcularLucro(dadosPrivados.precoCusto, dadosPublicos.precoVenda);
                dadosPrivados.margemLucro = margem;
                dadosPrivados.lucroUnitario = lucro;
            } else {
                dadosPrivados.custoHora = custoHoraServico ? parseFloat(custoHoraServico.value) || 0 : 0;
                dadosPrivados.materiais = materiaisServico;
                dadosPrivados.observacoesPrivadas = observacoesPrivadas ? observacoesPrivadas.value.trim() || null : null;
            }
            
            // Unir dados
            const dadosCompletos = {
                ...dadosPublicos,
                ...dadosPrivados
            };
            
            if (modoEdicao && itemEmEdicao) {
                // Atualizar item existente
                const collectionName = tipo === 'servico' ? 'servicos' : 'produtos';
                const itemRef = doc(db, collectionName, itemEmEdicao.id);
                await updateDoc(itemRef, dadosCompletos);
                
                // Atualizar localmente
                const lista = tipo === 'servico' ? servicos : produtos;
                const index = lista.findIndex(item => item.id === itemEmEdicao.id);
                if (index !== -1) {
                    lista[index] = { ...lista[index], ...dadosCompletos };
                }
                
                showAlert(`${tipo === 'servico' ? 'Serviço' : 'Produto'} atualizado com sucesso!`, 'success');
            } else {
                // Criar novo item
                dadosCompletos.criadoEm = serverTimestamp();
                
                const collectionName = tipo === 'servico' ? 'servicos' : 'produtos';
                const docRef = await addDoc(collection(db, collectionName), dadosCompletos);
                dadosCompletos.id = docRef.id;
                
                // Adicionar localmente
                if (tipo === 'servico') {
                    servicos.unshift(dadosCompletos);
                    servicosAtuais++;
                } else {
                    produtos.unshift(dadosCompletos);
                    produtosAtuais++;
                }
                
                totalCatalogoAtual = servicosAtuais + produtosAtuais;
                
                showAlert(`${tipo === 'servico' ? 'Serviço' : 'Produto'} criado com sucesso!`, 'success');
            }
            
            if (modalItem) {
                modalItem.hide();
            }
            
            // Atualizar interface
            atualizarContadores();
            atualizarGridCatalogo();
            atualizarDisplayLimites(); // Atualizar limites
            
        } catch (error) {
            console.error('Erro ao salvar item:', error);
            showAlert('Erro ao salvar item. Tente novamente.', 'error');
        } finally {
            hideLoading();
            if (btnSalvarItem) {
                btnSalvarItem.disabled = false;
                btnSalvarItem.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Item';
            }
        }
    }

    window.editarItem = function(tipo, id) {
        abrirModalItem(tipo, id);
    };

    window.excluirItem = async function(tipo, id) {
        if (!confirm(`Tem certeza que deseja excluir este ${tipo === 'servico' ? 'serviço' : 'produto'}?\nEsta ação não pode ser desfeita.`)) {
            return;
        }
        
        try {
            showLoading();
            
            const collectionName = tipo === 'servico' ? 'servicos' : 'produtos';
            const itemRef = doc(db, collectionName, id);
            await deleteDoc(itemRef);
            
            // Remover localmente
            const lista = tipo === 'servico' ? servicos : produtos;
            const index = lista.findIndex(item => item.id === id);
            if (index !== -1) {
                lista.splice(index, 1);
                
                // Atualizar contadores
                if (tipo === 'servico') {
                    servicosAtuais = Math.max(0, servicosAtuais - 1);
                } else {
                    produtosAtuais = Math.max(0, produtosAtuais - 1);
                }
                totalCatalogoAtual = servicosAtuais + produtosAtuais;
            }
            
            // Atualizar interface
            atualizarContadores();
            atualizarGridCatalogo();
            atualizarDisplayLimites(); // Atualizar limites
            
            showAlert(`${tipo === 'servico' ? 'Serviço' : 'Produto'} excluído com sucesso!`, 'success');
            
        } catch (error) {
            console.error('Erro ao excluir item:', error);
            showAlert('Erro ao excluir item. Tente novamente.', 'error');
        } finally {
            hideLoading();
        }
    };

    // ============================================
    // DISPLAY DO CATÁLOGO - MANTIDO INTACTO
    // ============================================
    function atualizarGridCatalogo() {
        if (!catalogoGrid) return;
        
        const searchTerm = searchCatalogo ? searchCatalogo.value.toLowerCase() : '';
        const categoriaFilter = filterCategoria ? filterCategoria.value : '';
        const statusFilter = filterStatus ? filterStatus.value : '';
        
        let itensParaExibir = [];
        
        // Filtrar por tipo
        if (tipoAtualCatalogo === 'servicos') {
            itensParaExibir = [...servicos];
        } else if (tipoAtualCatalogo === 'produtos') {
            itensParaExibir = [...produtos];
        } else {
            itensParaExibir = [...servicos, ...produtos];
        }
        
        // Aplicar filtros
        itensParaExibir = itensParaExibir.filter(item => {
            const matchSearch = !searchTerm || 
                item.nome.toLowerCase().includes(searchTerm) ||
                (item.descricao && item.descricao.toLowerCase().includes(searchTerm)) ||
                (item.categoria && item.categoria.toLowerCase().includes(searchTerm)) ||
                (item.tags && Array.isArray(item.tags) && 
                 item.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
            
            const matchCategoria = !categoriaFilter || item.categoria === categoriaFilter;
            const matchStatus = !statusFilter || item.status === statusFilter;
            
            return matchSearch && matchCategoria && matchStatus;
        });
        
        // Limpar grid
        catalogoGrid.innerHTML = '';
        
        if (itensParaExibir.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.innerHTML = `
                <i class="fas fa-${tipoAtualCatalogo === 'servicos' ? 'tools' : tipoAtualCatalogo === 'produtos' ? 'box' : 'boxes'}"></i>
                <h4>Nenhum item encontrado</h4>
                <p class="text-muted">${searchTerm || categoriaFilter || statusFilter ? 'Tente ajustar os filtros' : 'Comece adicionando seu primeiro item'}</p>
                <button class="btn btn-primary-action mt-3" onclick="abrirModalItem('${tipoAtualCatalogo === 'servicos' ? 'servico' : 'produto'}')">
                    <i class="fas fa-plus me-2"></i>Adicionar Item
                </button>
            `;
            catalogoGrid.appendChild(emptyState);
            return;
        }
        
        // Preencher grid
        itensParaExibir.forEach(item => {
            const tipo = item.tipo || (item.codigoSKU ? 'produto' : 'servico');
            const card = criarCardItem(item, tipo);
            if (card) {
                catalogoGrid.appendChild(card);
            }
        });
    }

    function criarCardItem(item, tipo) {
        if (!item) return null;
        
        const card = document.createElement('div');
        card.className = 'catalogo-card';
        
        // Badge de tipo
        const badgeClass = tipo === 'servico' ? 'badge-servico' : 'badge-produto';
        const badgeIcon = tipo === 'servico' ? 'fa-tools' : 'fa-box';
        const badgeText = tipo === 'servico' ? 'Serviço' : 'Produto';
        
        // Imagem principal
        const imagemPrincipal = item.imagens && item.imagens.length > 0 
            ? item.imagens[0] 
            : `https://via.placeholder.com/400x300?text=${encodeURIComponent(item.nome || (tipo === 'servico' ? 'Serviço' : 'Produto'))}`;
        
        // Informações específicas
        let infoExtra = '';
        if (tipo === 'produto') {
            const estoque = item.estoqueAtual || 0;
            const estoqueMinimo = item.estoqueMinimo || 0;
            const textoEstoque = estoque <= estoqueMinimo ? `⚠️ Baixo: ${estoque} un` : `📦 ${estoque} un`;
            
            infoExtra = `<div class="card-info"><span>${textoEstoque}</span><span>${item.marca || 'Sem marca'}</span></div>`;
        } else {
            infoExtra = `<div class="card-info"><span>${item.duracao || '--'}</span><span>${item.tipoServico || 'Presencial'}</span></div>`;
        }
        
        // Status
        const statusMap = {
            'ativo': 'Ativo',
            'inativo': 'Inativo',
            'esgotado': 'Esgotado'
        };
        const statusTexto = statusMap[item.status] || 'Ativo';
        const statusClass = item.status === 'ativo' ? 'status-active' : 
                          item.status === 'inativo' ? 'status-inactive' : 'status-pending';
        
        card.innerHTML = `
            <div class="card-image">
                <img src="${imagemPrincipal}" alt="${item.nome}" onerror="this.src='https://via.placeholder.com/400x300?text=${encodeURIComponent(item.nome || 'Item')}'">
                <span class="card-badge ${badgeClass}">
                    <i class="fas ${badgeIcon} me-1"></i>${badgeText}
                </span>
            </div>
            <div class="card-content">
                <h5 class="card-title">${item.nome || 'Sem nome'}</h5>
                ${infoExtra}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="card-price">${formatarMoeda(item.precoVenda)}</div>
                    <span class="status-badge ${statusClass}">
                        ${statusTexto}
                    </span>
                </div>
                <p class="text-muted small mb-0" style="height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                    ${item.descricao || 'Sem descrição'}
                </p>
                <div class="card-actions mt-3">
                    <button class="btn-card btn-card-edit" onclick="editarItem('${tipo}', '${item.id}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn-card btn-card-delete" onclick="excluirItem('${tipo}', '${item.id}')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            </div>
        `;
        
        return card;
    }

    function atualizarContadores() {
        // Contagem
        if (totalServicos) {
            totalServicos.textContent = servicos.filter(s => s.status === 'ativo').length;
        }
        
        if (totalProdutos) {
            totalProdutos.textContent = produtos.filter(p => p.status === 'ativo').length;
        }
        
        // Atualizar badges
        if (badgeServicos) badgeServicos.textContent = servicos.length;
        if (badgeProdutos) badgeProdutos.textContent = produtos.length;
        if (badgeTodos) badgeTodos.textContent = servicos.length + produtos.length;
        
        // Calcular valor do estoque
        let valorTotalEstoque = 0;
        let baixoEstoqueCount = 0;
        
        produtos.forEach(produto => {
            if (produto.status === 'ativo') {
                const estoque = produto.estoqueAtual || 0;
                const precoCusto = produto.precoCusto || 0;
                valorTotalEstoque += estoque * precoCusto;
                
                const estoqueMinimo = produto.estoqueMinimo || 0;
                if (estoque <= estoqueMinimo && estoqueMinimo > 0) {
                    baixoEstoqueCount++;
                }
            }
        });
        
        if (valorEstoque) {
            valorEstoque.textContent = formatarMoeda(valorTotalEstoque);
        }
        
        if (baixoEstoque) {
            baixoEstoque.textContent = baixoEstoqueCount;
        }
    }

    // ============================================
    // EVENT LISTENERS - ATUALIZADO
    // ============================================
    function inicializarEventListeners() {
        // Botão salvar
        if (btnSalvarItem) {
            btnSalvarItem.addEventListener('click', salvarItem);
        }
        
        // Filtros
        if (searchCatalogo) {
            searchCatalogo.addEventListener('input', atualizarGridCatalogo);
        }
        
        if (filterCategoria) {
            filterCategoria.addEventListener('change', atualizarGridCatalogo);
        }
        
        if (filterStatus) {
            filterStatus.addEventListener('change', atualizarGridCatalogo);
        }
        
        // Menu mobile
        if (menuToggle) {
            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                dashboardMenu.classList.toggle('show');
                const icon = menuToggle.querySelector('i');
                if (icon) {
                    if (dashboardMenu.classList.contains('show')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                }
            });
        }
        
        // Fechar menu ao clicar fora
        document.addEventListener('click', (e) => {
            if (dashboardMenu && menuToggle) {
                if (!dashboardMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                    dashboardMenu.classList.remove('show');
                    const icon = menuToggle.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                }
            }
        });
        
        // Logout
        if (btnLogout) {
            btnLogout.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    window.location.href = 'login.html';
                } catch {
                    showAlert('Erro ao sair. Tente novamente.', 'error');
                }
            });
        }
        
        // Auto-save quando modal fecha
        const modalElement = document.getElementById('modalItem');
        if (modalElement) {
            modalElement.addEventListener('hidden.bs.modal', function () {
                resetarModal();
            });
        }
    }

    // Inicializar quando o DOM carregar
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar display financeiro
        setTimeout(atualizarDisplayFinanceiro, 500);
    });
</script>
</body>
</html>